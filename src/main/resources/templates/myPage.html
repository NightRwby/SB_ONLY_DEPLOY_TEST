<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SNS ë©”ì‹ ì € - ë§ˆì´í˜ì´ì§€</title>

    <!-- ê³µìš© CSS -->
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/myPage.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
<div th:replace="~{fragments/header :: headerFragment}"></div>
<div class="page-wrap">
    <!-- ===== ë©”ì¸ 3ì»¬ëŸ¼ ===== -->
    <div class="main-row">
        <!-- LEFT -->
        <div class="col-left">
            <aside class="side">
                <div class="inner">
                    <div class="menu-title">ë§ˆì´ ë©”ë‰´</div>
                    <div class="menu">
                        <button class="menu-btn active" data-target="section-profile">í”„ë¡œí•„</button>
                        <button class="menu-btn" data-target="section-security">ê³„ì •/ë³´ì•ˆ</button>
                        <button class="menu-btn" data-target="section-noti">ì•Œë¦¼ ì„¤ì •</button>
                        <button class="menu-btn" data-target="section-privacy">ê°œì¸ì •ë³´/ì°¨ë‹¨</button>
                        <button class="menu-btn" data-target="section-content">ê²Œì‹œë¬¼ ê´€ë¦¬</button>
                        <button class="menu-btn" data-target="section-saved">ìŠ¤í¬ë©/ì €ì¥í•¨</button>
                        <button class="menu-btn" data-target="section-devices">ê¸°ê¸°/ì„¸ì…˜</button>
                        <button class="menu-btn" data-target="section-data">ë°ì´í„°/ë°±ì—…</button>
                        <button class="menu-btn" data-target="section-settings">ì•± ì„¤ì •</button>
                        <button class="menu-btn business-only" data-target="section-business">ë¹„ì¦ˆë‹ˆìŠ¤ ì„¤ì •</button>
                    </div>
                </div>
            </aside>
        </div>

        <!-- MAIN -->
        <div class="col-main">
            <main class="stack">
                <section class="top-comu">
                    <div class="top-text">
                        <h1>ë§ˆì´ í˜ì´ì§€</h1>
                    </div>
                </section>

                <!-- í”„ë¡œí•„ -->
                <section id="section-profile" class="card">
                    <h2>í”„ë¡œí•„ ì„¤ì •</h2>
                    <div class="grid-2">
                        <div class="profile-image-section">

                            <div class="banner-container">
                                <div class="banner-wrapper">
                                    <img id="bannerPreview" class="banner" alt="banner" style="display: none;">

                                    <div id="bannerPlaceholder" class="banner placeholder">
                                        <span class="ph-text">ë°°ê²½ ì´ë¯¸ì§€</span>
                                    </div>
                                </div>

                                <label for="bannerInput" class="upload-btn banner-upload-btn" title="ë°°ê²½ ì‚¬ì§„ ë³€ê²½">ğŸ“·</label>
                                <input type="file" id="bannerInput" name="bannerImageUrl" accept="image/*" style="display: none;"/>
                            </div>

                            <div class="avatar-container">
                                <div class="avatar-wrapper">
                                    <img id="avatarPreview" class="avatar" alt="avatar" style="display: none;">

                                    <div id="avatarPlaceholder" class="avatar placeholder">
                                        <span id="avatarInitial" class="ph-text-avatar">?</span>
                                    </div>
                                </div>

                                <label for="avatarInput" class="upload-btn avatar-upload-btn" title="í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½">ğŸ“·</label>
                                <input type="file" id="avatarInput" name="profileImageUrl" accept="image/*" style="display: none;"/>
                            </div>

                        </div>

                        <div class="profile-input-section"><div class="profile-input-section">
                            <div>
                                <label class="tool-label" for="nickname">ë‹‰ë„¤ì„</label>
                                <input id="nickname" class="tool-input" placeholder="ë‹‰ë„¤ì„" th:value="${profile.nickname}"/>
                            </div>

                            <div>
                                <label class="tool-label" for="onlineStatus">ì ‘ì† ìƒíƒœ í‘œì‹œ</label>
                                <select id="onlineStatus" class="tool-select">
                                    <option value="online">ì˜¨ë¼ì¸</option>
                                    <option value="offline">ì˜¤í”„ë¼ì¸ (ìˆ¨ê¸°ê¸°)</option>
                                    <option value="away">ìë¦¬ ë¹„ì›€</option>
                                </select>
                            </div>

                            <div>
                                <label class="tool-label" for="statusMsg">ìƒíƒœ ë©”ì‹œì§€</label>
                                <input id="statusMsg" class="tool-input" placeholder="í•œ ì¤„ ì†Œê°œ" th:value="${profile.stateMessage}"/>
                            </div>

                            <div>
                                <label class="tool-label" for="profileBio">ìê¸°ì†Œê°œ</label>
                                <textarea id="profileBio" class="tool-area" placeholder="ìì‹ ì„ ììœ ë¡­ê²Œ ì†Œê°œí•´ì£¼ì„¸ìš”."></textarea>
                            </div>

                            <div class="button-group">
                                <button class="btn btn-primary" id="saveProfile">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
                                <button class="btn btn-outline" id="copyProfile">ë§í¬ ë³µì‚¬</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ê³„ì •/ë³´ì•ˆ -->
                <section id="section-security" class="card" hidden>
                    <h2>ê³„ì •/ë³´ì•ˆ</h2>
                    <div class="grid-3">
                        <div>
                            <label class="tool-label">ì´ë©”ì¼</label>
                            <input id="email" class="tool-input" type="email" placeholder="you@example.com" th:value="${userDto.email}"/>
                        </div>
                        <div>
                            <label class="tool-label">ê³„ì • ìƒíƒœ</label>
                            <input class="tool-input" value="ì •ìƒ" disabled/>
                        </div>
                    </div>

                    <div style="height:12px;"></div>
                    <div class="grid-2">
                        <div class="card sub-card">
                            <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                            <label class="tool-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <input id="pwCurrent" class="tool-input" type="password"/>
                            <label class="tool-label" style="margin-top:8px;">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <input id="pwNew" class="tool-input" type="password"/>
                            <label class="tool-label" style="margin-top:8px;">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input id="pwNew2" class="tool-input" type="password"/>
                            <div class="row" style="margin-top:10px;">
                                <button class="btn" id="changePw">ë³€ê²½</button>
                            </div>
                        </div>
                        <div class="card sub-card">
                            <h3>2ë‹¨ê³„ ì¸ì¦(2FA)</h3>
                            <div class="row">
                                <div id="twoFA" class="switch" role="switch" aria-checked="false" tabindex="0">
                                </div>
                                <span class="muted">ì•±/ë¬¸ì ê¸°ë°˜ ì¸ì¦</span>
                            </div>
                            <div class="row" style="margin-top:8px; gap:8px;">
                                <button class="btn gray" id="viewBackupCodes">ë°±ì—… ì½”ë“œ ë³´ê¸°</button>
                                <button class="btn ghost" id="regenBackupCodes">ë°±ì—… ì½”ë“œ ì¬ë°œê¸‰</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ì•Œë¦¼ ì„¤ì • -->
                <section id="section-noti" class="card" hidden>
                    <h2>ì•Œë¦¼ ì„¤ì •</h2>
                    <div class="list" id="notiList">
                        <div class="item">
                            <div>
                                <div><strong>ë©”ì‹œì§€ ì•Œë¦¼</strong></div>
                                <div class="muted">1:1, ê·¸ë£¹, ë©˜ì…˜</div>
                            </div>
                            <div class="row">
                                <div id="swMsg" class="switch" role="switch" aria-checked="true" tabindex="0"></div>
                            </div>
                        </div>
                        <div class="item">
                            <div>
                                <div><strong>ëŒ“ê¸€/ë‹µê¸€ ì•Œë¦¼</strong></div>
                                <div class="muted">ë‚´ ê¸€/ìŠ¤í¬ë© í™œë™</div>
                            </div>
                            <div class="row">
                                <div id="swReply" class="switch" role="switch" aria-checked="true" tabindex="0">
                                </div>
                            </div>
                        </div>
                        <div class="item">
                            <div>
                                <div><strong>ë§ˆê° ì„ë°•(ì—…ë¬´)</strong><span class="tag">business</span></div>
                                <div class="muted">í”„ë¡œì íŠ¸/í•  ì¼ Due Soon</div>
                            </div>
                            <div class="row">
                                <div id="swDue" class="switch" role="switch" aria-checked="true" tabindex="0"></div>
                            </div>
                        </div>
                        <div class="item">
                            <div>
                                <div><strong>ë§ˆì¼€íŒ…/ì´ë²¤íŠ¸</strong></div>
                                <div class="muted">í”„ë¡œëª¨ì…˜/ì†Œì‹</div>
                            </div>
                            <div class="row">
                                <div id="swPromo" class="switch" role="switch" aria-checked="false" tabindex="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top:12px;">
                        <button class="btn" id="saveNoti">ì €ì¥</button>
                    </div>
                </section>

                <!-- ê°œì¸ì •ë³´/ì°¨ë‹¨ -->
                <section id="section-privacy" class="card" hidden>
                    <h2>ê°œì¸ì •ë³´/ì°¨ë‹¨</h2>
                    <div class="grid-3">
                        <div>
                            <label class="tool-label">í”„ë¡œí•„ ê³µê°œ ë²”ìœ„</label>
                            <select id="visibility" class="tool-select">
                                <option value="public">ì „ì²´ê³µê°œ</option>
                                <option value="friends">ì¹œêµ¬ë§Œ</option>
                                <option value="private">ë¹„ê³µê°œ</option>
                            </select>
                        </div>
                        <div>
                            <label class="tool-label">ë§ˆì§€ë§‰ ì ‘ì†ì‹œê°„ í‘œì‹œ</label>
                            <select id="lastSeen" class="tool-select">
                                <option value="on">í‘œì‹œ</option>
                                <option value="off">ìˆ¨ê¹€</option>
                            </select>
                        </div>
                        <div>
                            <label class="tool-label">ì½ìŒ í™•ì¸(ì½ìŒ í‘œì‹œ)</label>
                            <select id="readReceipt" class="tool-select">
                                <option value="on">ì‚¬ìš©</option>
                                <option value="off">ë¯¸ì‚¬ìš©</option>
                            </select>
                        </div>
                    </div>

                    <div style="height:12px;"></div>
                    <div class="card sub-card">
                        <div class="row" style="justify-content:space-between;">
                            <h3>ì°¨ë‹¨ ëª©ë¡</h3>
                            <div class="row">
                                <input id="blockInput" class="tool-input" placeholder="@ì‚¬ìš©ìID" style="width:200px;">
                                <button class="
                                btn gray" id="blockAdd">ì°¨ë‹¨</button>
                            </div>
                        </div>
                        <div id="blockList" class="list" style="margin-top:8px;"></div>
                    </div>
                </section>

                <!-- ê²Œì‹œë¬¼ ê´€ë¦¬ (CRUD ì¶”ê°€) -->
                <section id="section-content" class="card" hidden>
                    <h2>ê²Œì‹œë¬¼ ê´€ë¦¬</h2>
                    <div class="grid-2">
                        <div>
                            <div class="row row-between">
                                <h3>ë‚´ê°€ ì“´ ê¸€</h3>
                                <button class="btn ghost btn-sm" id="addPostBtn">ê¸€ ì¶”ê°€</button>
                            </div>
                            <div id="myPosts" class="list"></div>
                        </div>
                        <div>
                            <h3>ë‚´ ëŒ“ê¸€</h3>
                            <div id="myComments" class="list"></div>
                        </div>
                    </div>
                </section>

                <!-- ìŠ¤í¬ë©/ì €ì¥í•¨ -->
                <section id="section-saved" class="card" hidden>
                    <h2>ìŠ¤í¬ë©/ì €ì¥í•¨</h2>
                    <div id="savedWrap" class="grid-3"></div>
                    <div class="row" style="margin-top:12px;">
                        <button class="btn ghost" id="clearSaved">ì €ì¥í•¨ ë¹„ìš°ê¸°</button>
                    </div>
                </section>

                <!-- ê¸°ê¸°/ì„¸ì…˜ -->
                <section id="section-devices" class="card" hidden>
                    <h2>ê¸°ê¸°/ì„¸ì…˜</h2>
                    <div id="deviceList" class="list"></div>
                    <div class="row" style="margin-top:12px; gap:8px;">
                        <button class="btn ghost" id="logoutOthers">ë‹¤ë¥¸ ê¸°ê¸° ëª¨ë‘ ë¡œê·¸ì•„ì›ƒ</button>
                        <button class="btn danger" id="logoutAll">ëª¨ë“  ê¸°ê¸° ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </section>

                <!-- ë°ì´í„°/ë°±ì—… -->
                <section id="section-data" class="card" hidden>
                    <div id="quit-error-message" style="color: red; margin-bottom: 15px;"></div>
                    <h2>ë°ì´í„°/ë°±ì—…</h2>
                    <div class="grid-2">
                        <div class="card sub-card">
                            <h3>ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                            <div class="muted">ë‚´ ê²Œì‹œë¬¼/ëŒ“ê¸€/í”„ë¡œí•„ ì„¤ì •ì„ JSONìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ</div>
                            <div class="row" style="margin-top:10px;">
                                <button class="btn" id="exportData">JSON ë‹¤ìš´ë¡œë“œ</button>
                            </div>
                        </div>
                        <div class="card sub-card">
                            <h3>ê³„ì • ì‚­ì œ</h3>
                            <div class="muted">ê³„ì • ë° ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤. ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>

                            <form id="quitForm" action="/quit" method="POST" style="margin-top:10px;">
                                <div class="stack" style="gap:8px;">
                                    <label class="tool-label" for="quitPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                    <input id="quitPassword" name="password" class="tool-input" type="password"
                                           placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>

                                    <input type="hidden" name="agreed" value="true">

                                    <div class="row" style="margin-top:10px; justify-content:flex-end;">
                                        <button type="button" class="btn danger" id="deleteAccount">ê³„ì • ì‚­ì œ</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- ì•± ì„¤ì • -->
                <section id="section-settings" class="card" hidden>
                    <h2>ì•± ì„¤ì •</h2>

                    <div class="grid-3">
                        <div>
                            <label class="tool-label">ì–¸ì–´</label>
                            <select id="lang" class="tool-select">
                                <option value="ko">í•œêµ­ì–´</option>
                                <option value="en">English</option>
                                <option value="ja">æ—¥æœ¬èª</option>
                            </select>
                        </div>
                        <div>
                            <label class="tool-label">í…Œë§ˆ</label>
                            <select id="theme" class="tool-select">
                                <option value="light">ë¼ì´íŠ¸</option>
                                <option value="dark">ë‹¤í¬</option>
                                <option value="system">ì‹œìŠ¤í…œ ìë™</option>
                            </select>
                        </div>
                        <div>
                            <label class="tool-label">ì•Œë¦¼ìŒ</label>
                            <select id="sound" class="tool-select">
                                <option value="default">ê¸°ë³¸</option>
                                <option value="soft">ë¶€ë“œëŸ½ê²Œ</option>
                                <option value="pop">íŒ</option>
                                <option value="mute">ë¬´ìŒ</option>
                            </select>
                        </div>
                    </div>

                    <div style="height:12px;"></div>

                    <div class="grid-3">
                        <div class="switch-row">
                            <div>
                                <strong>ì»´íŒ©íŠ¸ ëª¨ë“œ</strong>
                                <div class="muted">ì—¬ë°±ì„ ì¤„ì—¬ ë” ë§ì€ ì •ë³´ë¥¼ í•œ í™”ë©´ì—</div>
                            </div>
                            <div id="compactMode" class="switch" role="switch" aria-checked="false" tabindex="0">
                            </div>
                        </div>
                        <div class="switch-row">
                            <div>
                                <strong>ë§í¬ í”„ë¦¬ë·°</strong>
                                <div class="muted">URL ìë™ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ í‘œì‹œ</div>
                            </div>
                            <div id="linkPreview" class="switch" role="switch" aria-checked="true" tabindex="0">
                            </div>
                        </div>
                        <div class="switch-row">
                            <div>
                                <strong>ë¯¸ë””ì–´ ìë™ì¬ìƒ</strong>
                                <div class="muted">íƒ€ì„ë¼ì¸ ë™ì˜ìƒ/ìŒì„± ìë™ ì¬ìƒ</div>
                            </div>
                            <div id="autoplayMedia" class="switch" role="switch" aria-checked="false" tabindex="0">
                            </div>
                        </div>
                    </div>

                    <div style="height:12px;"></div>

                    <div class="grid-3">
                        <div>
                            <label class="tool-label">ì±„íŒ… ê¸€ê¼´ í¬ê¸°</label>
                            <select id="fontSize" class="tool-select">
                                <option value="14">ì‘ê²Œ (14px)</option>
                                <option value="16" selected>ë³´í†µ (16px)</option>
                                <option value="18">í¬ê²Œ (18px)</option>
                            </select>
                        </div>
                        <div>
                            <label class="tool-label">ì‹œê°„ í‘œê¸°</label>
                            <select id="timeFormat" class="tool-select">
                                <option value="24h">24ì‹œê°„ì œ</option>
                                <option value="12h">12ì‹œê°„ì œ</option>
                            </select>
                        </div>
                        <div class="switch-row">
                            <div>
                                <strong>ë°ì´í„° ì„¸ì´ë²„</strong>
                                <div class="muted">ëª¨ë°”ì¼ì—ì„œ ì´ë¯¸ì§€/ë™ì˜ìƒ ì €ìš©ëŸ‰ ì „ì†¡</div>
                            </div>
                            <div id="dataSaver" class="switch" role="switch" aria-checked="false" tabindex="0">
                            </div>
                        </div>
                    </div>

                    <div style="height:12px;"></div>

                    <div class="range-row">
                        <label class="tool-label" for="volume" style="margin:0;">ì•Œë¦¼ìŒ ë³¼ë¥¨</label>
                        <input id="volume" type="range" min="0" max="100" step="5" value="70"/>
                        <span id="volumeVal" class="muted">70%</span>
                    </div>

                    <div class="row" style="margin-top:12px;">
                        <button class="btn" id="saveApp">ì„¤ì • ì €ì¥</button>
                    </div>
                </section>

                <!-- ë¹„ì¦ˆë‹ˆìŠ¤ ì„¤ì • -->
                <section id="section-business" class="card" hidden>
                    <h2>ë¹„ì¦ˆë‹ˆìŠ¤ ì„¤ì •</h2>
                    <div class="grid-3">
                        <div>
                            <label class="tool-label">ê·¼ë¬´ ìƒíƒœ</label>
                            <select id="workStatus" class="tool-select">
                                <option value="available">ì—…ë¬´ ê°€ëŠ¥</option>
                                <option value="focus">ì§‘ì¤‘ ëª¨ë“œ</option>
                                <option value="away">ìë¦¬ë¹„ì›€</option>
                                <option value="off">ì˜¤í”„ë¼ì¸</option>
                            </select>
                        </div>
                        <div>
                            <label class="tool-label">ê·¼ë¬´ì‹œê°„</label>
                            <input id="workHours" class="tool-input" placeholder="09:00~18:00"/>
                        </div>
                        <div>
                            <label class="tool-label">ìë™ íšŒì˜ ìƒíƒœ ì „í™˜</label>
                            <select id="autoMeeting" class="tool-select">
                                <option value="on">ì‚¬ìš©</option>
                                <option value="off">ë¯¸ì‚¬ìš©</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" style="margin-top:12px;">
                        <button class="btn" id="saveBiz">ì €ì¥</button>
                    </div>
                </section>
            </main>
        </div>

        <!-- RIGHT -->
        <div class="col-right">
            <aside class="side widget">
                <div class="inner">
                    <div class="menu-title">ë‚´ í™œë™ ìš”ì•½</div>
                    <div class="kpi">
                        <div class="box">
                            <div class="muted">ì´ë²ˆì£¼ ë©”ì‹œì§€</div>
                            <div class="num" id="kpiMsg">0</div>
                        </div>
                        <div class="box">
                            <div class="muted">ì´ë²ˆì£¼ ë©˜ì…˜</div>
                            <div class="num" id="kpiMention">0</div>
                        </div>
                        <div class="box">
                            <div class="muted">ë‚˜ì˜ ê¸€</div>
                            <div class="num" id="kpiPosts">0</div>
                        </div>
                        <div class="box">
                            <div class="muted">ìŠ¤í¬ë©</div>
                            <div class="num" id="kpiSaved">0</div>
                        </div>
                    </div>
                    <div style="height:12px;"></div>
                    <div class="card sub-card">
                        <div><strong>ì•± ë²„ì „</strong></div>
                        <div class="muted">v1.12.0</div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <div id="footer-placeholder"></div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast" class="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>

<!-- ê²Œì‹œë¬¼ CRUD ëª¨ë‹¬ -->
<div class="modal-backdrop" id="postModalBackdrop" role="dialog" aria-modal="true">
    <div class="modal-sm">
        <div class="modal-header">
            <div class="modal-title" id="postModalTitle">ê¸€ ì¶”ê°€</div>
            <button class="btn ghost btn-sm" id="closePostModal">ë‹«ê¸°</button>
        </div>
        <div class="modal-body">
            <label class="tool-label" for="postTitle">ì œëª©</label>
            <input id="postTitle" class="tool-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"/>

            <label class="tool-label" for="postCat" style="margin-top:8px;">ì¹´í…Œê³ ë¦¬</label>
            <select id="postCat" class="tool-select">
                <option value="ììœ ">ììœ </option>
                <option value="ëª¨ì§‘">ëª¨ì§‘</option>
                <option value="ì§ˆë¬¸">ì§ˆë¬¸</option>
                <option value="ì •ë³´">ì •ë³´</option>
            </select>

            <label class="tool-label" for="postDate" style="margin-top:8px;">ì‘ì„±ì¼</label>
            <input id="postDate" type="date" class="tool-input"/>

            <div class="grid-2" style="margin-top:8px;">
                <div>
                    <label class="tool-label" for="postLikes">ì¢‹ì•„ìš”</label>
                    <input id="postLikes" type="number" min="0" class="tool-input" value="0"/>
                </div>
                <div>
                    <label class="tool-label" for="postViews">ì¡°íšŒìˆ˜</label>
                    <input id="postViews" type="number" min="0" class="tool-input" value="0"/>
                </div>
            </div>

            <div class="row" style="margin-top:12px; justify-content:flex-end;">
                <button class="btn" id="savePostModal">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<script>
    const LS = {
        PROFILE: "my.profile",
        NOTI: "my.noti",
        PRIV: "my.privacy",
        BLOCK: "my.block",
        POSTS: "my.posts",
        COMMENTS: "my.comments",
        SAVED: "my.saved",
        DEV: "my.devices",
        APP: "my.appsettings",
        BIZ: "my.biz",
        TWOFA: "my.2fa",
        BACKUP: "my.backupcodes"
    };

    const sections = [
        'section-profile', 'section-security', 'section-noti', 'section-privacy',
        'section-content', 'section-saved', 'section-devices', 'section-data', 'section-settings', 'section-business'
    ];
    const toast = document.getElementById('toast');
    const menuButtons = document.querySelectorAll('.menu-btn');

    // Profile Elements
    const avatarPreview = document.getElementById('avatarPreview');
    const bannerPreview = document.getElementById('bannerPreview');
    // í”Œë ˆì´ìŠ¤í™€ë” ì¶”ê°€
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const bannerPlaceholder = document.getElementById('bannerPlaceholder');
    const avatarInitial = document.getElementById('avatarInitial');

    const avatarInput = document.getElementById('avatarInput');
    const bannerInput = document.getElementById('bannerInput');

    const nickname = document.getElementById('nickname');
    const onlineStatus = document.getElementById('onlineStatus');
    const statusMsg = document.getElementById('statusMsg');
    const profileBio = document.getElementById('profileBio');
    const btnSaveProfile = document.getElementById('saveProfile');
    const copyProfile = document.getElementById('copyProfile');

    // Security
    const email = document.getElementById('email');
    const phone = document.getElementById('phone');
    const twoFA = document.getElementById('twoFA');
    const changePw = document.getElementById('changePw');

    // ... (ê¸°íƒ€ ë³€ìˆ˜ë“¤ì€ Part 2ì—ì„œ ì—°ê²°ë©ë‹ˆë‹¤) ...
    // Noti
    const swMsg = document.getElementById('swMsg');
    const swReply = document.getElementById('swReply');
    const swDue = document.getElementById('swDue');
    const swPromo = document.getElementById('swPromo');
    const saveNoti = document.getElementById('saveNoti');

    // Privacy
    const visibility = document.getElementById('visibility');
    const lastSeen = document.getElementById('lastSeen');
    const readReceipt = document.getElementById('readReceipt');
    const blockInput = document.getElementById('blockInput');
    const blockList = document.getElementById('blockList');

    // Content
    const myPosts = document.getElementById('myPosts');
    const myComments = document.getElementById('myComments');
    const addPostBtn = document.getElementById('addPostBtn');

    // Saved
    const savedWrap = document.getElementById('savedWrap');
    const clearSaved = document.getElementById('clearSaved');

    // Devices
    const deviceList = document.getElementById('deviceList');
    const logoutOthers = document.getElementById('logoutOthers');
    const logoutAll = document.getElementById('logoutAll');

    // App settings
    const lang = document.getElementById('lang');
    const theme = document.getElementById('theme');
    const sound = document.getElementById('sound');
    const compactMode = document.getElementById('compactMode');
    const linkPreview = document.getElementById('linkPreview');
    const autoplayMedia = document.getElementById('autoplayMedia');
    const fontSize = document.getElementById('fontSize');
    const timeFormat = document.getElementById('timeFormat');
    const dataSaver = document.getElementById('dataSaver');
    const volume = document.getElementById('volume');
    const volumeVal = document.getElementById('volumeVal');
    const saveApp = document.getElementById('saveApp');

    // Biz
    const workStatus = document.getElementById('workStatus');
    const workHours = document.getElementById('workHours');
    const autoMeeting = document.getElementById('autoMeeting');
    const saveBiz = document.getElementById('saveBiz');

    // KPI
    const kpiMsg = document.getElementById('kpiMsg');
    const kpiMention = document.getElementById('kpiMention');
    const kpiPosts = document.getElementById('kpiPosts');
    const kpiSaved = document.getElementById('kpiSaved');

    // Post Modal
    const postModalBackdrop = document.getElementById('postModalBackdrop');
    const postModalTitle = document.getElementById('postModalTitle');
    const closePostModal = document.getElementById('closePostModal');
    const postTitle = document.getElementById('postTitle');
    const postCat = document.getElementById('postCat');
    const postDate = document.getElementById('postDate');
    const postLikes = document.getElementById('postLikes');
    const postViews = document.getElementById('postViews');
    const savePostModal = document.getElementById('savePostModal');

    // Helpers
    const fmt = new Intl.NumberFormat();
    const setSwitch = (el, on) => { if(el){ el.classList.toggle('on', !!on); el.setAttribute('aria-checked', !!on); } };
    const getSwitch = (el) => el && el.classList.contains('on');
    const toggleSwitch = (el) => { if(el) setSwitch(el, !getSwitch(el)); };
    const saveLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const getLS = (k, def) => { try { const v = JSON.parse(localStorage.getItem(k)); return v ?? def; } catch { return def; } };
    const showToast = (t = "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.") => {
        toast.textContent = t; toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1600);
    };

    // Nav
    function showSection(id) {
        sections.forEach(s => {
            const el = document.getElementById(s);
            if (el) el.hidden = (s !== id);
        });
        document.querySelectorAll('.menu-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.target === id);
        });

        history.replaceState(null, null, '#' + id);
    }
    menuButtons.forEach(b => b.addEventListener('click', () => showSection(b.dataset.target)));
    window.addEventListener('hashchange', () => {
        const id = location.hash.replace('#', ''); if (sections.includes(id)) showSection(id);
    });

    // =========================================================
    // Profile Logic (ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ ì „ë©´ ìˆ˜ì •)
    // =========================================================
    let avatarFileToUpload = null;
    let bannerFileToUpload = null;

    // í•œê¸€ ì´ˆì„± ì¶”ì¶œ í•¨ìˆ˜
    function getKoreanInitials(text) {
        if (!text) return '?';
        const chosung = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
        const code = text.charCodeAt(0) - 44032;
        if (code > -1 && code < 11172) return chosung[Math.floor(code / 588)];
        return text.charAt(0).toUpperCase();
    }

    async function initProfile() {
        try {
            const response = await axios.get('/api/profile/me');
            const p = response.data;

            // 1. í…ìŠ¤íŠ¸ ì •ë³´ ì„¤ì •
            if(nickname) nickname.value = p.nickname || "";
            if(statusMsg) statusMsg.value = p.stateMessage || "";
            if(onlineStatus) onlineStatus.value = p.onlineStatus || "online";
            // if(profileBio) profileBio.value = p.bio || "";

            // 2. ë°°ë„ˆ ì´ë¯¸ì§€ ì²˜ë¦¬ (Null ì²´í¬)
            if (p.bannerImageUrl && p.bannerImageUrl !== 'null' && p.bannerImageUrl.trim() !== '') {
                // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°
                bannerPreview.src = p.bannerImageUrl + '?t=' + new Date().getTime(); // ìºì‹œ ë°©ì§€
                bannerPreview.style.display = 'block';
                if(bannerPlaceholder) bannerPlaceholder.style.display = 'none';
            } else {
                // ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° (í°ìƒ‰ ë°•ìŠ¤)
                bannerPreview.style.display = 'none';
                if(bannerPlaceholder) bannerPlaceholder.style.display = 'block';
            }

            // 3. ì•„ë°”íƒ€ ì´ë¯¸ì§€ ì²˜ë¦¬ (Null ì²´í¬)
            if (p.profileImageUrl && p.profileImageUrl !== 'null' && p.profileImageUrl.trim() !== '') {
                // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°
                avatarPreview.src = p.profileImageUrl + '?t=' + new Date().getTime();
                avatarPreview.style.display = 'block';
                if(avatarPlaceholder) avatarPlaceholder.style.display = 'none';
            } else {
                // ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° (ë¯¼íŠ¸ìƒ‰ ì› + ì´ˆì„±)
                avatarPreview.style.display = 'none';
                if(avatarPlaceholder) avatarPlaceholder.style.display = 'flex'; // flexë¡œ ì¤‘ì•™ ì •ë ¬

                // ë‹‰ë„¤ì„ ì´ˆì„± ì¶”ì¶œ
                const name = p.nickname || "User";
                if(avatarInitial) avatarInitial.textContent = getKoreanInitials(name);
            }

        } catch (error) {
            console.error("í”„ë¡œí•„ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:", error);
        }
    }

    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ (ì•„ë°”íƒ€) - ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ ë°˜ì˜
    if(avatarInput) {
        avatarInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (!file) return;

            avatarFileToUpload = file;

            const reader = new FileReader();
            reader.onload = (e) => {
                // íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì¦‰ì‹œ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë³´ì—¬ì£¼ê³  í”Œë ˆì´ìŠ¤í™€ë”ëŠ” ìˆ¨ê¹€
                avatarPreview.src = e.target.result;
                avatarPreview.style.display = 'block';
                if(avatarPlaceholder) avatarPlaceholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        });
    }

    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ (ë°°ë„ˆ) - ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ ë°˜ì˜
    if(bannerInput) {
        bannerInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (!file) return;

            bannerFileToUpload = file;

            const reader = new FileReader();
            reader.onload = (e) => {
                bannerPreview.src = e.target.result;
                bannerPreview.style.display = 'block';
                if(bannerPlaceholder) bannerPlaceholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        });
    }

    // í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ í´ë¦­ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    if(btnSaveProfile) {
        btnSaveProfile.addEventListener('click', async () => {
            const formData = new FormData();
            formData.append('nickname', (nickname.value || "").trim() || "ì‚¬ìš©ì");
            formData.append('stateMessage', (statusMsg.value || "").trim());

            if (avatarFileToUpload instanceof File) {
                formData.append('profileImageUrl', avatarFileToUpload);
            }
            if (bannerFileToUpload instanceof File) {
                formData.append('bannerImageUrl', bannerFileToUpload);
            }
            if(onlineStatus) {
                formData.append('onlineStatus', onlineStatus.value);
            }
            try {
                await axios.put('/api/profile/update', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                showToast("í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

                // ì´ˆê¸°í™” ë° ì¬ë¡œë”©
                avatarFileToUpload = null;
                bannerFileToUpload = null;
                if(avatarInput) avatarInput.value = '';
                if(bannerInput) bannerInput.value = '';

                initProfile();

            } catch (error) {
                console.error("í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨:", error);
                showToast("í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
    // =========================================================
    // Security Logic
    // =========================================================
    function initSecurity() {
        const p = getLS(LS.PROFILE, {});

        // ì„œë²„(Thymeleaf)ì—ì„œ ê°’ì´ ì´ë¯¸ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
        if(email) {
            // 1. í˜„ì¬ ì…ë ¥ì°½ì— ê°’ì´ ë¹„ì–´ìˆì„ ë•Œë§Œ ì¿ í‚¤ë‚˜ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê°’ì„ ë„£ìŒ
            if (!email.value || email.value.trim() === '') {
                const emailFromCookie = getCookie('email');
                email.value = emailFromCookie || p.email || "";
            }
        }

        const two = getLS(LS.TWOFA, { enabled: false });
        if(twoFA) setSwitch(twoFA, !!two.enabled);
    }

    if(twoFA) {
        twoFA.addEventListener('click', () => toggleSwitch(twoFA));
        twoFA.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSwitch(twoFA); } });
    }

    if(changePw) {
        changePw.addEventListener('click', () => {
            const cur = document.getElementById('pwCurrent').value;
            const n1 = document.getElementById('pwNew').value;
            const n2 = document.getElementById('pwNew2').value;

            if (!cur || !n1 || !n2) { showToast("ëª¨ë“  ë¹„ë°€ë²ˆí˜¸ í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
            if (n1 !== n2) { showToast("ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
            if (n1.length < 8) { showToast("ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

            // ì‹¤ì œ ë³€ê²½ ë¡œì§ì€ ë°±ì—”ë“œ API ì—°ë™ í•„ìš” (/quit/pwchange ë“±)
            // ì—¬ê¸°ì„œëŠ” UI ì‹œë®¬ë ˆì´ì…˜ë§Œ ìˆ˜í–‰
            document.getElementById('pwCurrent').value = "";
            document.getElementById('pwNew').value = "";
            document.getElementById('pwNew2').value = "";
            showToast("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (ëª¨ì˜)");
        });
    }

    // ë°±ì—… ì½”ë“œ ê´€ë ¨
    function genCodes(len = 6, n = 8) { return Array.from({ length: n }, () => Math.random().toString(36).slice(2, 2 + len).toUpperCase()); }

    const btnViewBackup = document.getElementById('viewBackupCodes');
    if(btnViewBackup) {
        btnViewBackup.addEventListener('click', () => {
            let codes = getLS(LS.BACKUP, null);
            if (!codes) { codes = genCodes(); saveLS(LS.BACKUP, codes); }
            alert("ë°±ì—… ì½”ë“œ\n\n" + codes.join("\n"));
        });
    }

    const btnRegenBackup = document.getElementById('regenBackupCodes');
    if(btnRegenBackup) {
        btnRegenBackup.addEventListener('click', () => {
            const codes = genCodes(); saveLS(LS.BACKUP, codes); showToast("ìƒˆ ë°±ì—… ì½”ë“œê°€ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    }

    // =========================================================
    // Notification Logic
    // =========================================================
    function initNoti() {
        const cfg = getLS(LS.NOTI, { msg: true, reply: true, due: true, promo: false });
        if(swMsg) setSwitch(swMsg, cfg.msg);
        if(swReply) setSwitch(swReply, cfg.reply);
        if(swDue) setSwitch(swDue, cfg.due);
        if(swPromo) setSwitch(swPromo, cfg.promo);
    }

    if(saveNoti) {
        saveNoti.addEventListener('click', () => {
            const cfg = {
                msg: getSwitch(swMsg),
                reply: getSwitch(swReply),
                due: getSwitch(swDue),
                promo: getSwitch(swPromo)
            };
            saveLS(LS.NOTI, cfg);
            showToast("ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    }

    // =========================================================
    // Privacy & Block Logic
    // =========================================================
    // =========================================================
    // Privacy & Block Logic (ì„œë²„ API ì—°ë™)
    // =========================================================
    function initPrivacy() {
        // ê°œì¸ì •ë³´ ì„¤ì • (ê¸°ì¡´ LS ìœ ì§€ í˜¹ì€ ì¶”í›„ API ì—°ë™)
        const pv = getLS(LS.PRIV, { visibility: 'public', lastSeen: 'on', readReceipt: 'on' });
        if(visibility) visibility.value = pv.visibility;
        if(lastSeen) lastSeen.value = pv.lastSeen;
        if(readReceipt) readReceipt.value = pv.readReceipt;

        // [ìˆ˜ì •] ì„œë²„ì—ì„œ ì°¨ë‹¨ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        fetchAndRenderBlockList();
    }

    // 1. ì°¨ë‹¨ ëª©ë¡ ì¡°íšŒ (GET /api/blocklist)
    async function fetchAndRenderBlockList() {
        if(!blockList) return;
        blockList.innerHTML = '<div class="empty">ë¡œë”© ì¤‘...</div>';

        try {
            const response = await fetch('/api/blocklist');
            if (response.ok) {
                const list = await response.json(); // List<BlockResponse>
                renderBlock(list);
            } else {
                console.error("ì°¨ë‹¨ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");
                blockList.innerHTML = '<div class="empty">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        } catch (e) {
            console.error(e);
            blockList.innerHTML = '<div class="empty">ì„œë²„ ì˜¤ë¥˜</div>';
        }
    }

    // 2. ì°¨ë‹¨ ëª©ë¡ ë Œë”ë§
    function renderBlock(list) {
        blockList.innerHTML = "";
        if (!list || list.length === 0) {
            blockList.innerHTML = `<div class="empty">ì°¨ë‹¨ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
        }

        list.forEach((item) => {
            // BlockResponse: { blockedUserEmail, blockedAt, ... }
            const email = item.blockedUserEmail;

            const row = document.createElement('div');
            row.className = 'item';
            row.innerHTML = `
                <div>
                    <strong>${email}</strong>
                    <div class="muted">ì°¨ë‹¨ë¨</div>
                </div>
                <div class="row">
                    <button class="btn gray btn-sm">í•´ì œ</button>
                </div>`;

            // ì°¨ë‹¨ í•´ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
            row.querySelector('button').addEventListener('click', () => {
                requestUnblockUser(email);
            });
            blockList.appendChild(row);
        });
    }

    // 3. ì°¨ë‹¨ ìš”ì²­ (POST /api/block)
    async function requestBlockUser(targetEmail) {
        try {
            const response = await fetch('/api/block', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetUserEmail: targetEmail })
            });

            if (response.ok) {
                showToast("ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
                blockInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
                fetchAndRenderBlockList(); // ëª©ë¡ ê°±ì‹ 
            } else {
                const msg = await response.text();
                alert("ì°¨ë‹¨ ì‹¤íŒ¨: " + msg);
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }

    // 4. ì°¨ë‹¨ í•´ì œ ìš”ì²­ (DELETE /api/block)
    async function requestUnblockUser(targetEmail) {
        if(!confirm(`'${targetEmail}'ë‹˜ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const response = await fetch('/api/block', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetUserEmail: targetEmail })
            });

            if (response.ok) {
                showToast("ì°¨ë‹¨ í•´ì œë¨");
                fetchAndRenderBlockList(); // ëª©ë¡ ê°±ì‹ 
            } else {
                const msg = await response.text();
                alert("í•´ì œ ì‹¤íŒ¨: " + msg);
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }

    // [ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ] ì°¨ë‹¨ ë²„íŠ¼ í´ë¦­
    const btnBlockAdd = document.getElementById('blockAdd');
    if(btnBlockAdd) {
        btnBlockAdd.addEventListener('click', () => {
            const id = (blockInput.value || "").trim();
            if (!id) {
                showToast("ì°¨ë‹¨í•  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            // ì„œë²„ë¡œ ì°¨ë‹¨ ìš”ì²­
            requestBlockUser(id);
        });
    }

    // =========================================================
    // Content (Posts/Comments) CRUD Logic
    // =========================================================
    let postData = [];
    let commentData = [];
    let editingPostIndex = null;

    function loadPosts() {
        postData = getLS(LS.POSTS, [
            { id: 101, title: "ì²« ê¸€ ì¸ì‚¬ë“œë¦½ë‹ˆë‹¤", date: "2025-10-20", cat: "ììœ ", likes: 12, views: 320 },
            { id: 102, title: "ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ íŒ€ êµ¬í•©ë‹ˆë‹¤", date: "2025-10-23", cat: "ëª¨ì§‘", likes: 8, views: 210 }
        ]);
        commentData = getLS(LS.COMMENTS, [
            { id: 201, post: "í•«ì´ìŠˆ] ì˜¤ëŠ˜ ê²½ê¸° ì–´ë• ë‚˜", date: "2025-10-24", text: "í›„ë°˜ êµì²´ê°€ ì•„ì‰¬ì›€" },
            { id: 202, post: "ì •ë³´ê³µìœ ] VSCode ë‹¨ì¶•í‚¤", date: "2025-10-22", text: "ìœ ìš©í•©ë‹ˆë‹¤!" }
        ]);
    }

    function savePosts() {
        saveLS(LS.POSTS, postData);
        saveLS(LS.COMMENTS, commentData);
    }

    function renderPosts() {
        if(!myPosts) return;
        myPosts.innerHTML = "";
        if (!postData.length) {
            myPosts.innerHTML = `<div class="empty">ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
            postData.forEach((p, idx) => {
                const row = document.createElement('div');
                row.className = 'item';
                row.innerHTML = `
                    <div>
                      <div><strong>[${p.cat}] ${p.title}</strong></div>
                      <div class="muted">${p.date || "-"} Â·  ${p.likes ?? 0} Â·  ${p.views ?? 0}</div>
                    </div>
                    <div class="row">
                      <button class="btn gray btn-sm" data-action="edit" data-idx="${idx}">ìˆ˜ì •</button>
                      <button class="btn danger btn-sm" data-action="del" data-idx="${idx}">ì‚­ì œ</button>
                    </div>`;

                row.querySelector('[data-action="del"]').addEventListener('click', () => {
                    if (!confirm("ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
                    postData.splice(idx, 1);
                    savePosts();
                    renderPosts();
                    updateKpi();
                    showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
                row.querySelector('[data-action="edit"]').addEventListener('click', () => {
                    openPostModal('edit', idx);
                });
                myPosts.appendChild(row);
            });
        }

        // ëŒ“ê¸€ ë Œë”ë§
        if(!myComments) return;
        myComments.innerHTML = "";
        if (!commentData.length) {
            myComments.innerHTML = `<div class="empty">ì‘ì„±í•œ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
            commentData.forEach((c, idx) => {
                const row = document.createElement('div');
                row.className = 'item';
                row.innerHTML = `
                    <div>
                      <div><strong>${c.post}</strong></div>
                      <div class="muted">${c.date}</div>
                      <div>${c.text}</div>
                    </div>
                    <div class="row">
                      <button class="btn danger btn-sm" data-idx="${idx}">ì‚­ì œ</button>
                    </div>`;

                row.querySelector('button').addEventListener('click', () => {
                    if (!confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
                    commentData.splice(idx, 1);
                    savePosts();
                    renderPosts();
                    showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
                myComments.appendChild(row);
            });
        }
        updateKpi();
    }

    function openPostModal(mode = 'add', index = null) {
        editingPostIndex = (mode === 'edit') ? index : null;
        if (mode === 'edit' && postData[index]) {
            const p = postData[index];
            postModalTitle.textContent = "ê¸€ ìˆ˜ì •";
            postTitle.value = p.title || "";
            postCat.value = p.cat || "ììœ ";
            postDate.value = p.date || new Date().toISOString().slice(0, 10);
            postLikes.value = p.likes ?? 0;
            postViews.value = p.views ?? 0;
        } else {
            postModalTitle.textContent = "ê¸€ ì¶”ê°€";
            postTitle.value = "";
            postCat.value = "ììœ ";
            postDate.value = new Date().toISOString().slice(0, 10);
            postLikes.value = 0;
            postViews.value = 0;
        }
        postModalBackdrop.style.display = 'flex';
        postTitle.focus();
    }

    function closePostModalFn() {
        postModalBackdrop.style.display = 'none';
    }

    if(addPostBtn) addPostBtn.addEventListener('click', () => openPostModal('add'));
    if(closePostModal) closePostModal.addEventListener('click', closePostModalFn);
    if(postModalBackdrop) postModalBackdrop.addEventListener('click', (e) => {
        if (e.target === postModalBackdrop) closePostModalFn();
    });

    if(savePostModal) {
        savePostModal.addEventListener('click', () => {
            const title = (postTitle.value || "").trim();
            if (!title) { showToast("ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); postTitle.focus(); return; }
            const cat = postCat.value || "ììœ ";
            const date = postDate.value || new Date().toISOString().slice(0, 10);
            const likes = Math.max(0, Number(postLikes.value || 0));
            const views = Math.max(0, Number(postViews.value || 0));

            if (editingPostIndex === null) {
                const newId = (postData[0]?.id || 100) + 1;
                postData.unshift({ id: newId, title, cat, date, likes, views });
            } else {
                const p = postData[editingPostIndex];
                postData[editingPostIndex] = { ...p, title, cat, date, likes, views };
            }
            savePosts();
            renderPosts();
            closePostModalFn();
            showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    }

    function initContent() {
        loadPosts();
        renderPosts();
    }

    // =========================================================
    // Saved Logic
    // =========================================================
    function initSaved() {
        const saved = getLS(LS.SAVED, [
            { id: 301, title: "ê°œë°œì ë°ˆ ëª¨ìŒ 10ì„ ", cat: "ìœ ë¨¸/ë°ˆ" },
            { id: 302, title: "í•«ë”œ ëª¨ìŒ(í…Œí¬)", cat: "ì •ë³´ê³µìœ " },
            { id: 303, title: "êµ¬ë¯¸ ì¹´í˜ ì¶”ì²œ ë£¨íŠ¸", cat: "í›„ê¸°/ë¦¬ë·°" }
        ]);
        if(!savedWrap) return;
        savedWrap.innerHTML = "";
        if (!saved.length) {
            savedWrap.innerHTML = `<div class="empty" style="grid-column:1/-1;">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
            saved.forEach((s, idx) => {
                const card = document.createElement('div');
                card.className = 'card sub-card';
                card.innerHTML = `
                    <div><strong>${s.title}</strong> <span class="tag">${s.cat}</span></div>
                    <div class="row" style="margin-top:8px; gap:8px;">
                      <button class="btn gray btn-sm" data-idx="${idx}">ì—´ê¸°</button>
                      <button class="btn danger btn-sm" data-del="${idx}">ì‚­ì œ</button>
                    </div>`;

                card.querySelector('[data-idx]').addEventListener('click', () => showToast("í˜ì´ì§€ë¡œ ì´ë™(ëª¨ì˜)"));
                card.querySelector('[data-del]').addEventListener('click', () => {
                    const cur = getLS(LS.SAVED, []);
                    cur.splice(idx, 1);
                    saveLS(LS.SAVED, cur);
                    initSaved();
                    showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
                savedWrap.appendChild(card);
            });
        }

        if(kpiSaved) {
            const savedNow = getLS(LS.SAVED, saved);
            kpiSaved.textContent = savedNow.length;
        }
    }

    if(clearSaved) {
        clearSaved.addEventListener('click', () => {
            saveLS(LS.SAVED, []);
            initSaved();
            showToast("ì €ì¥í•¨ì´ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.");
        });
    }

    // =========================================================
    // Devices Logic
    // =========================================================
    function initDevices() {
        const devs = getLS(LS.DEV, [
            { id: "web-1", name: "Chrome on Windows", ip: "123.45.67.8", last: "2025-10-31 18:20" },
            { id: "ios-1", name: "iPhone iOS 17", ip: "123.45.67.9", last: "2025-10-31 08:12" }
        ]);
        if(!deviceList) return;
        deviceList.innerHTML = "";
        devs.forEach((d, idx) => {
            const row = document.createElement('div'); row.className = 'item';
            row.innerHTML = `
              <div>
                <div><strong>${d.name}</strong></div>
                <div class="muted">${d.ip} Â· ë§ˆì§€ë§‰ í™œë™ ${d.last}</div>
              </div>
              <div class="row"><button class="btn danger btn-sm" data-idx="${idx}">ë¡œê·¸ì•„ì›ƒ</button></div>`;
            row.querySelector('button').addEventListener('click', () => {
                const cur = getLS(LS.DEV, []); cur.splice(idx, 1); saveLS(LS.DEV, cur); initDevices(); showToast("í•´ë‹¹ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
            });
            deviceList.appendChild(row);
        });

        if(kpiMsg) kpiMsg.textContent = fmt.format(128);
        if(kpiMention) kpiMention.textContent = fmt.format(6);
    }

    if(logoutOthers) {
        logoutOthers.addEventListener('click', () => {
            const devs = getLS(LS.DEV, []); saveLS(LS.DEV, devs.slice(0, 1)); initDevices(); showToast("ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    }

    if(logoutAll) {
        logoutAll.addEventListener('click', () => {
            saveLS(LS.DEV, []); initDevices(); showToast("ëª¨ë“  ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    }

    // =========================================================
    // Data Export & Delete Logic
    // =========================================================
    const btnExport = document.getElementById('exportData');
    if(btnExport) {
        btnExport.addEventListener('click', () => {
            const dump = {
                profile: getLS(LS.PROFILE, {}),
                noti: getLS(LS.NOTI, {}),
                privacy: getLS(LS.PRIV, {}),
                block: getLS(LS.BLOCK, []),
                posts: getLS(LS.POSTS, []),
                comments: getLS(LS.COMMENTS, []),
                saved: getLS(LS.SAVED, []),
                devices: getLS(LS.DEV, []),
                app: getLS(LS.APP, {}),
                biz: getLS(LS.BIZ, {})
            };
            const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'mydata.json'; a.click();
            URL.revokeObjectURL(url);
            showToast("JSON ë‹¤ìš´ë¡œë“œ ì‹œì‘");
        });
    }

    const btnDeleteAccount = document.getElementById('deleteAccount');
    if(btnDeleteAccount) {
        btnDeleteAccount.addEventListener('click', async () => {
            const quitPassword = document.getElementById('quitPassword');
            const password = quitPassword.value.trim();

            if (!password) {
                showToast("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                quitPassword.focus();
                return;
            }

            const formData = new URLSearchParams();
            formData.append('password', password);
            formData.append('agreed', 'true');

            try {
                const response = await fetch('/quit/ajax', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (response.ok) {
                    alert("ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¸í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    window.location.href = "/main";
                } else {
                    const errorMessage = await response.text();
                    alert(errorMessage);
                    quitPassword.value = '';
                    quitPassword.focus();
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    // =========================================================
    // App Settings Logic
    // =========================================================
    function applyTheme(val) {
        if (val === 'dark') document.body.classList.add('dark');
        else if (val === 'light') document.body.classList.remove('dark');
        else {
            const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.body.classList.toggle('dark', prefers);
        }
    }

    function bindSwitch(el) {
        el.addEventListener('click', () => toggleSwitch(el));
        el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSwitch(el); } });
    }

    [compactMode, linkPreview, autoplayMedia, dataSaver].forEach(el => el && bindSwitch(el));

    if (volume && volumeVal) {
        volume.addEventListener('input', () => volumeVal.textContent = `${volume.value}%`);
    }

    function initApp() {
        const def = {
            lang: 'ko', theme: 'light', sound: 'default',
            compactMode: false, linkPreview: true, autoplayMedia: false,
            fontSize: '16', timeFormat: '24h', dataSaver: false, volume: 70
        };
        const app = getLS(LS.APP, def);

        if(lang) lang.value = app.lang ?? def.lang;
        if(theme) theme.value = app.theme ?? def.theme;
        if(sound) sound.value = app.sound ?? def.sound;
        if(compactMode) setSwitch(compactMode, !!app.compactMode);
        if(linkPreview) setSwitch(linkPreview, !!app.linkPreview);
        if(autoplayMedia) setSwitch(autoplayMedia, !!app.autoplayMedia);
        if(fontSize) fontSize.value = app.fontSize ?? def.fontSize;
        if(timeFormat) timeFormat.value = app.timeFormat ?? def.timeFormat;
        if(dataSaver) setSwitch(dataSaver, !!app.dataSaver);
        if(volume) volume.value = Number(app.volume ?? def.volume);
        if(volumeVal) volumeVal.textContent = `${volume.value}%`;

        applyTheme(app.theme);
        document.body.dataset.fontSize = app.fontSize;
        document.body.classList.toggle('compact', !!app.compactMode);
    }

    if(saveApp) {
        saveApp.addEventListener('click', () => {
            const app = {
                lang: lang.value, theme: theme.value, sound: sound.value,
                compactMode: getSwitch(compactMode),
                linkPreview: getSwitch(linkPreview),
                autoplayMedia: getSwitch(autoplayMedia),
                fontSize: fontSize.value,
                timeFormat: timeFormat.value,
                dataSaver: getSwitch(dataSaver),
                volume: Number(volume.value)
            };
            saveLS(LS.APP, app);
            applyTheme(app.theme);
            document.body.dataset.fontSize = app.fontSize;
            document.body.classList.toggle('compact', !!app.compactMode);
            showToast();
        });
    }

    // =========================================================
    // Business Logic
    // =========================================================
    function initBiz() {
        const biz = getLS(LS.BIZ, { workStatus: 'available', workHours: '09:00~18:00', autoMeeting: 'on' });
        if(workStatus) workStatus.value = biz.workStatus;
        if(workHours) workHours.value = biz.workHours;
        if(autoMeeting) autoMeeting.value = biz.autoMeeting;
    }

    if(saveBiz) {
        saveBiz.addEventListener('click', () => {
            const biz = {
                workStatus: workStatus.value,
                workHours: (workHours.value || "").trim(),
                autoMeeting: autoMeeting.value
            };
            saveLS(LS.BIZ, biz);
            showToast();
        });
    }

    function updateKpi() {
        if(kpiPosts) kpiPosts.textContent = postData.length;
        const saved = getLS(LS.SAVED, []);
        if(kpiSaved) kpiSaved.textContent = saved.length;
    }

    // =========================================================
    // Boot (Initialization)
    // =========================================================
    function boot() {
        // 1. ë¸Œë¼ìš°ì €ì˜ ìë™ ìŠ¤í¬ë¡¤ ë™ì‘ ë„ê¸°
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }

        // ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ ì‹¤í–‰
        initProfile();

        if (typeof initSecurity === 'function') initSecurity();
        if (typeof initNoti === 'function') initNoti();
        if (typeof initPrivacy === 'function') initPrivacy();
        if (typeof initContent === 'function') initContent();
        if (typeof initSaved === 'function') initSaved();
        if (typeof initDevices === 'function') initDevices();
        if (typeof initApp === 'function') initApp();
        if (typeof initBiz === 'function') initBiz();

        // ìŠ¤ìœ„ì¹˜ í‚¤ë³´ë“œ ì ‘ê·¼ì„±
        document.querySelectorAll('.switch').forEach(sw => {
            sw.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleSwitch(sw);
                }
            });
        });

        // ì´ˆê¸° ì„¹ì…˜ í‘œì‹œ
        const first = location.hash.replace('#', '');
        showSection(sections.includes(first) ? first : 'section-profile');

        // 2. ë¯¸ì„¸í•œ ë”œë ˆì´ë¥¼ ì£¼ì–´ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ê°•ì œ ê³ ì •
        setTimeout(() => {
            window.scrollTo(0, 0);
        }, 10);
    }

    // ì¢…ë£Œì‹œ ì €ì¥ ë¡œì§
    window.addEventListener('beforeunload', () => {
        if(typeof twoFA !== 'undefined' && twoFA) saveLS(LS.TWOFA, { enabled: getSwitch(twoFA) });

        if(typeof visibility !== 'undefined') {
            const priv = { visibility: visibility.value, lastSeen: lastSeen.value, readReceipt: readReceipt.value };
            saveLS(LS.PRIV, priv);
        }
    });

    boot();
</script>
</script>
</body>

</html>