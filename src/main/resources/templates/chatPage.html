<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ChatPage</title>
    <link rel="stylesheet" th:href="@{/css/chatPage.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">

    <!--í—¤ë”/í‘¸í„° jqueryë°©ì‹ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <!--  GLightbox(ì´ë¯¸ì§€ ëª¨ë‹¬ì°½)  -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

</head>

<body>

<div th:replace="~{fragments/header :: headerFragment}"></div>
<main>
    <div class="main-content">
        <aside class="icon-bar-left" id="icon-bar-left">
            <button class="icon-btn" data-view="chat" title="ì±„íŒ… ëª©ë¡">ì±—</button>
            <button class="icon-btn" data-view="document" title="ë‚´ ë³´ê´€í•¨">ë³´ê´€</button>
            <button class="icon-btn" data-view="community" title="ì»¤ë®¤ë‹ˆí‹°">ì»¤ë®¤</button>
            <button class="icon-btn" data-view="help" title="ë§Œë“ ì´">ì œì‘</button>
        </aside>

        <aside class="sub-panel-left" id="sub-panel-left">
            <div class="sub-panel-content" id="sub-panel-content"></div>
        </aside>

        <section class="chat-area-wrapper" id="chat-area-wrapper">
            <div class="empty-state" id="empty-state" style="display:flex;">
                <div>
                    <p style="font-size:18px;">í™˜ì˜í•©ë‹ˆë‹¤!</p>
                    <p style="font-size:14px;">ì¢Œì¸¡ â€˜ì±„íŒ… / ë³´ê´€í•¨ / ì»¤ë®¤ë‹ˆí‹° / ì œì‘ìâ€™ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìš°ì¸¡ ì¹œêµ¬/ì°¸ì—¬ì ëª©ë¡ì—ì„œ
                        ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </section>

        <aside class="friend-panel-right" id="friend-panel-right">
            <div id="frd_column" class="friend-column">

                <div id="friend-panel-header">
                    <div id="friend-panel-name">ì¹œêµ¬ ëª©ë¡</div>
                    <button id="add-friend-btn">ì¹œêµ¬ ì¶”ê°€</button>
                </div>
                <div class="add-friend-wrapper">
                </div>
                <div class="friend-list" id="friend-list"></div>
            </div>

            <div id="fixed_column" class="member-column">
                <section class="profile-card" aria-label="ë‚´ í”„ë¡œí•„">
                    <div class="p-header">
                        <div class="p_user">
                            <div class="p_img" id="p_img" aria-label="í”„ë¡œí•„ ì´ë¯¸ì§€" role="img">NM</div>
                            <div class="p-name">
                                <span id="pName">ë‚¨ê·œë¯¼ &lt&ltì–´ë””ê°??</span>
                                <span class="p-state-label">
                                        <span id="pDot" class="p-status-dot online"></span>
                                        <span id="pStateText">ì˜¨ë¼ì¸</span>
                                    </span>
                            </div>
                        </div>
                        <p class="p-message" id="pMessage">
                            â€œ ììœ ê²Œì‹œíŒì—ì„œ ì†Œí†µ ì¤‘ â€<br />
                            " ë²„ì„¯ ë§ˆì„ ëª¨í—˜ ë– ë‚¨.."
                        </p>
                    </div>
                    <div class="p-actions">
                        <button class="p-btn" id="editProfileOpen">í”„ë¡œí•„ í¸ì§‘</button>
                        <div class="meta">â€» ë‚´ê°€ ì“´ ê¸€ë§Œ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    </div>
                </section>
                <div class="member-header">
                    <div class="member-tabs">
                        <span class="member-tab active">ì°¸ì—¬ì</span>
                        <button id="invite-member-btn" class="member-tab btn-tab">+ ì°¸ì—¬ì ì¶”ê°€</button>
                        <button id="open-friend-panel-btn" class="member-tab btn-tab">ì¹œêµ¬ ëª©ë¡</button>
                    </div>
                    <input type="text" class="member-search" placeholder="ì°¸ì—¬ì ê²€ìƒ‰">
                </div>

                <div class="member-list-wrapper">
                    <div class="friend-list" id="member-list"></div>
                </div>
            </div>
        </aside>
    </div>
</main>
<div th:replace="~{fragments/footer :: footerFragment}"></div>

<div id="friend-profile-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>í”„ë¡œí•„</h3>
            <button class="modal-close-btn" data-modal="friend-profile-modal">âœ–</button>
        </div>
        <div class="profile-modal-body">
            <div class="avatar" id="modal-friend-avatar">?</div>
            <h3 id="modal-friend-name">ì¹œêµ¬ ì´ë¦„</h3>
            <p id="modal-friend-status">ìƒíƒœ ë©”ì‹œì§€</p>
            <div class="profile-modal-actions">
                <button class="btn-chat" id="start-chat-btn">ì±„íŒ…í•˜ê¸°</button>
                <button class="btn-cancel" data-modal="friend-profile-modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div id="context-menu" class="context-menu">
    <div class="menu-item warning" id="ctx-kick-member">íšŒì› íƒˆí‡´ (ê°•í‡´)</div>
    <div class="menu-item" id="ctx-cancel">ì·¨ì†Œ</div>
</div>

<div id="add-friend-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ì¹œêµ¬ ì¶”ê°€ ë° ìš”ì²­</h3>
            <button class="modal-close-btn" data-modal="add-friend-modal">âœ–</button>
        </div>
        <div class="add-friend-modal-body" style="display:flex; flex-direction:column; gap:15px;">

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0;">ğŸ” ì‚¬ìš©ì ê²€ìƒ‰ (ì¹œêµ¬ ìš”ì²­)</h4>
                <button id="btn-send-requests" class="btn-primary-sm" style="display:none;">ì„ íƒí•œ ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°</button>
            </div>

            <input type="text" id="friend-search-input" placeholder="ì´ë©”ì¼, ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰">

            <div id="search-results-list" class="search-results-list check-mode"></div>

            <h4 style="margin-top:10px;">âœ‰ï¸ ë°›ì€ ì¹œêµ¬ ìš”ì²­</h4>
            <div id="received-requests-list" class="requests-list"></div>
        </div>
    </div>
</div>

<div id="add-member-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë©¤ë²„ ì´ˆëŒ€ (ì±„íŒ…ë°©ì— ì¶”ê°€)</h3>
            <button class="modal-close-btn" data-modal="add-member-modal">âœ–</button>
        </div>
        <div class="member-add-modal-body" style="display:flex; flex-direction:column; gap:8px;">
            <input type="text" id="member-search-input" class="member-search" placeholder="ì´ˆëŒ€í•  ë©¤ë²„ ê²€ìƒ‰ (ì´ë©”ì¼/ë‹‰ë„¤ì„)">
            <div id="member-search-results-list" class="search-results-list">
                <div class="info-message">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
            </div>
            <div class="modal-actions">
                <button id="add-member-confirm-btn" class="btn-primary">ì„ íƒëœ ë©¤ë²„ ì´ˆëŒ€</button>
                <button class="btn-cancel" data-modal="add-member-modal">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>


<div id="invite-member-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë©¤ë²„ ì´ˆëŒ€ (ë ˆê±°ì‹œ/ì¹œêµ¬ ëª©ë¡ ê¸°ë°˜)</h3>
            <button class="modal-close-btn" data-modal="invite-member-modal">âœ–</button>
        </div>
        <div class="invite-member-body">
            <p class="invite-desc">ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <ul id="invite-friend-list" class="invite-friend-list">
            </ul>
            <button class="btn-cancel" data-modal="invite-member-modal"
                    style="margin-top:10px; width:100%;">ë‹«ê¸°
            </button>
        </div>
    </div>
</div>

<div id="notification-area"></div>
<script>
    // =======================================================================
    // 1. ì±„íŒ…ë°© í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ ê´€ë¦¬
    // =======================================================================
    /**
     * --- chatPaginationStatesì˜ êµ¬ì„±ìš”ì†Œ ---
     * tabStates = {
     * 'tab-uuid': {
     * nextCursor: '2025-11-20T10:00:00.000000', // ë‹¤ìŒì— ë¡œë“œí•  ë©”ì‹œì§€ì˜ ì‹œì‘ì 
     * hasMore: true,                            // ë” ê³¼ê±° ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ ì—¬ë¶€
     * isLoading: false,                         // í˜„ì¬ ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€ (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
     * observer: null                            // IntersectionObserver ì¸ìŠ¤í„´ìŠ¤
     * },
     * ...
     * }
     */
    const chatPaginationStates = {};

    // =======================================================================
    // 2. ìƒë‹¨ ìƒëµ ì˜ì—­ (Placeholder) HTML
    // =======================================================================
    function createPlaceholderHtml() {
        return `<li class="chat-placeholder-top">
            <div class="loading-area" onclick="loadMoreMessages(activeTabId)">
                <p>
                    <i class="fas fa-spinner fa-spin loading-icon" style="display: none;"></i>
                    <span class="load-text">
                        <i class="fas fa-history"></i> ê³¼ê±° ë©”ì‹œì§€ 50ê°œ ë¶ˆëŸ¬ì˜¤ê¸°
                    </span>
                </p>
            </div>
        </li>`;
    }

    // ë¡œë”© ìƒíƒœë¥¼ ë³´ì—¬ì£¼ëŠ” CSS í´ë˜ìŠ¤ ì œì–´
    function togglePlaceholderLoading(tabId, isActivating) {
        const listContainer = document.getElementById(`chat-messages-${tabId}`);
        if (!listContainer) return;
        const placeholder = listContainer.querySelector('.chat-placeholder-top');
        if (placeholder) {
            const icon = placeholder.querySelector('.loading-icon');
            const text = placeholder.querySelector('.load-text');

            if (isActivating) {
                icon.style.display = 'inline-block';
                text.style.display = 'none';
            } else {
                icon.style.display = 'none';
                text.style.display = 'inline-block';
            }
        }
    }

    // ë‚ ì§œ íŒŒì‹± ë¡œì§ ë‹¨ìˆœí™” ë° ê°•í™”
    function parseDateRobust(dateString) {
        if (!dateString) return null;
        return new Date(dateString);
    }
    function parseTimeStringToDate(dateString) {
        if (!dateString) return new Date(NaN);

        // 1. ê³µë°±ì„ 'T'ë¡œ ì¹˜í™˜í•˜ì—¬ ISO 8601ì— ê·¼ì ‘í•œ í˜•íƒœë¡œ ë§Œë“­ë‹ˆë‹¤.
        let isoLikeString = dateString.replace(' ', 'T');

        // 2. ì†Œìˆ˜ì  ì´í•˜(ì´ˆ) ì²˜ë¦¬: ë§ˆì´í¬ë¡œì´ˆ(6ìë¦¬)ë¥¼ ë°€ë¦¬ì´ˆ(3ìë¦¬)ë¡œ ìë¦…ë‹ˆë‹¤.
        const parts = isoLikeString.split('.');
        if (parts.length > 1) {
            // ì†Œìˆ˜ì  ì´í•˜ 3ìë¦¬ë§Œ ë‚¨ê¸°ê³  ìë¦…ë‹ˆë‹¤.
            const fractionalSeconds = parts[1].substring(0, 3);
            isoLikeString = parts[0] + '.' + fractionalSeconds;
        } else {
            isoLikeString = parts[0];
        }

        // ì´ëŠ” ì‹œê°„ëŒ€ ì •ë³´ ì—†ì´ ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ ì‹œê°„ì´ KST ê¸°ì¤€ì„ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
        const kstString = isoLikeString + '+09:00';

        // 4. Date ê°ì²´ë¡œ ë³€í™˜
        return new Date(kstString);
    }
    function getKoreanInitials(text) {
        if (!text || typeof text !== 'string') return '';
        const CHOSUNG = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
        let result = '';
        const firstChar = text.charAt(0);
        const charCode = firstChar.charCodeAt(0);

        // ì²« ê¸€ìê°€ í•œê¸€ ë²”ìœ„ì— ì†í•˜ëŠ”ì§€ í™•ì¸
        if (charCode >= 44032 && charCode <= 55203) {
            // í•œê¸€ì¸ ê²½ìš° ì´ˆì„±ë§Œ ì¶”ì¶œ
            const index = Math.floor((charCode - 44032) / 588);
            result = CHOSUNG[index];
        } else {
            // í•œê¸€ì´ ì•„ë‹Œ ê²½ìš° ì²« ê¸€ì ê·¸ëŒ€ë¡œ ì‚¬ìš©
            result = firstChar;
        }
        return result;
    }
    // GLightbox ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ì „ì—­(ë˜ëŠ” ì ‘ê·¼ ê°€ëŠ¥í•œ ë²”ìœ„) ë³€ìˆ˜
    let chatLightboxInstance = null;
    function reinitializeLightbox() {
        // Lightboxê°€ ì ìš©ë  ìš”ì†Œì˜ ì„ íƒì (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ì‚¬ìš©)
        const selector = '.glightbox';

        // 1. ì´ë¯¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì¡´ì¬í•˜ë©´ (ì´ì „ì— ì´ˆê¸°í™”ëœ ì ì´ ìˆë‹¤ë©´)
        if (chatLightboxInstance) {
            // GLightboxì˜ 'reload' ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ DOMì—ì„œ ìƒˆë¡­ê²Œ ì¶”ê°€ëœ
            // '.glightbox' ìš”ì†Œë¥¼ ì°¾ì•„ ìë™ìœ¼ë¡œ ê°¤ëŸ¬ë¦¬ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
            chatLightboxInstance.reload();
            // console.log("[GLightbox] Reloaded existing instance for dynamic content.");
            return;
        }

        // 2. ì¸ìŠ¤í„´ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ (ìµœì´ˆ í˜ì´ì§€ ë¡œë“œ ì‹œ)
        // GLightbox ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ì˜µì…˜ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        chatLightboxInstance = GLightbox({
            selector: selector, // '.glightbox' í´ë˜ìŠ¤ê°€ ë¶™ì€ ëª¨ë“  ìš”ì†Œë¥¼ ê°¤ëŸ¬ë¦¬ë¡œ ë§Œë“­ë‹ˆë‹¤.
            gallery: 'chat-photos',
            loop: true,
            caption: false,
            draggable: false,
            zoomable: true,
            touchNavigation: true,
            keyboardNavigation: true,
            openEffect: 'zoom',
            closeEffect: 'zoom',
            mousewheel: true,
            download: false,
        });
        // console.log("[GLightbox] Created new instance on initial load.");
    }
    const iconDownload = `<svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>`;
    const iconCheck = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
    const progressRingHTML = `
        <svg class="progress-ring" viewBox="0 0 36 36">
            <circle class="progress-ring__circle" cx="18" cy="18" r="15.9155" />
        </svg>
    `;

    // =======================================================
    // 2. [ì „ì—­ í•¨ìˆ˜] ë°”ì´íŠ¸ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (createChatMessageHTMLì—ì„œ ì‚¬ìš©)
    // =======================================================
    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }


    // =======================================================
    // 3. [ì „ì—­ í•¨ìˆ˜] ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  í•¨ìˆ˜ (HTML onclickì—ì„œ ì§ì ‘ í˜¸ì¶œ)
    // =======================================================
    async function downloadWithProgress(url, fileName, btnId) {
        const btn = document.getElementById(btnId);
        if (!btn) return;

        // 1. ì´ë¯¸ ì™„ë£Œëœ ìƒíƒœë¼ë©´ ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œì‘ (ì¬ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥)
        if (btn.classList.contains('completed')) {
            btn.classList.remove('completed');
            btn.innerHTML = `${iconDownload} ${progressRingHTML}`; // ì•„ì´ì½˜ ì´ˆê¸°í™”
            // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë‹¤ì‹œ ì‹œì‘
            setTimeout(() => downloadWithProgress(url, fileName, btnId), 100);
            return;
        }

        // 2. ë¡œë”© ìƒíƒœ ì‹œì‘
        btn.classList.add('loading');
        const circle = btn.querySelector('.progress-ring__circle');
        const radius = circle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;

        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = circumference;

        try {
            // 3. Fetch ìš”ì²­ (ì¸ì¦ í—¤ë” í¬í•¨)
            const ACCESS_TOKEN_COOKIE_NAME = 'access-token';
            const jwtToken = getCookie(ACCESS_TOKEN_COOKIE_NAME);

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${jwtToken}` }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            // 4. Content-Length ê°€ì ¸ì˜¤ê¸° (ì§„í–‰ë¥  ê³„ì‚°ìš©)
            const contentLength = response.headers.get('Content-Length');
            if (!contentLength) {
                console.warn('Content-Length í—¤ë”ê°€ ì—†ì–´ ì§„í–‰ë¥ ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            const total = parseInt(contentLength, 10);
            let loaded = 0;

            // 5. Stream ë¦¬ë” ìƒì„±
            const reader = response.body.getReader();
            const chunks = [];

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                chunks.push(value);
                loaded += value.length;

                // 6. ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (CSS stroke-dashoffset ì¡°ì ˆ)
                if (total) {
                    const percent = loaded / total;
                    const offset = circumference - (percent * circumference);
                    circle.style.strokeDashoffset = offset;
                }
            }

            // 7. ë‹¤ìš´ë¡œë“œ ì™„ë£Œ í›„ Blob ìƒì„± ë° ì €ì¥
            const blob = new Blob(chunks);
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = downloadUrl;

            // íŒŒì¼ëª… ê²°ì • (ì¸ìê°’ì´ ì—†ìœ¼ë©´ URLì—ì„œ ì¶”ì¶œ)
            let finalName = fileName;
            if (!finalName) {
                 const disposition = response.headers.get('Content-Disposition');
                 if (disposition && disposition.indexOf('attachment') !== -1) {
                     const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                     const matches = filenameRegex.exec(disposition);
                     if (matches != null && matches[1]) {
                         finalName = matches[1].replace(/['"]/g, '');
                         finalName = decodeURIComponent(finalName); // í•œê¸€ ë””ì½”ë”©
                     }
                 }
            }
            if(!finalName) finalName = url.substring(url.lastIndexOf('/') + 1);

            a.download = finalName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);

            // 8. UI ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
            btn.classList.remove('loading');
            btn.classList.add('completed');
            btn.innerHTML = iconCheck; // ì²´í¬ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½

        } catch (error) {
            console.error('Download failed:', error);
            alert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            btn.classList.remove('loading');
            // ì—ëŸ¬ ì‹œ UI ì´ˆê¸°í™”
            btn.innerHTML = `${iconDownload} ${progressRingHTML}`;
        }
    }
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ìš”ì†Œ ìºì‹± ---
        const chatRoomMap = {};
        const addMemberModal = document.getElementById('add-member-modal');
        const memberSearchInput = document.getElementById('member-search-input') || document.querySelector('.member-search');
        const memberSearchResultsList = document.getElementById('member-search-results-list');
        const addMemberButton = document.getElementById('add-member-confirm-btn');
        const loggedInUserEmail = '[[${myProfile.email}]]';
        const iconBar = document.getElementById('icon-bar-left');
        const subPanel = document.getElementById('sub-panel-left');
        const subPanelContent = document.getElementById('sub-panel-content');
        const friendSearchInput = document.getElementById('friend-search-input') || document.querySelector('#add-friend-modal input[type="text"]');
        const searchResultsList = document.getElementById('search-results-list');
        const pImg = document.getElementById('p_img');
        const pName = document.getElementById('pName');
        const pMessage = document.getElementById('pMessage');
        const pDot = document.getElementById('pDot');
        const pStateText = document.getElementById('pStateText');
        const btnSendRequests = document.getElementById('btn-send-requests');
        let myOnlineStatus = true;  // ê¸°ë³¸ê°’ ì˜¨ë¼ì¸

        // ë©¤ë²„ ìš°í´ë¦­ ê°•í‡´ (Context Menu)
        const contextMenu = document.getElementById('context-menu');
        const kickBtn = document.getElementById('ctx-kick-member');
        const cancelBtn = document.getElementById('ctx-cancel');
        let targetMemberId = null;
        let targetRoomId = null;
        let targetMemberName = null;

        // tabBarê°€ HTMLì— ì—†ë‹¤ê³  ê°€ì •í•˜ê³  ë™ì ìœ¼ë¡œ ìƒì„±í•˜ê±°ë‚˜, ì¡´ì¬í•˜ëŠ” êµ¬ì¡°ë¥¼ í™œìš©í•´ì•¼ í•©ë‹ˆë‹¤.
        let tabBar = document.getElementById('tab-bar');
        const mainElement = document.querySelector('main');
        if (!tabBar) {
            const tempTabBar = document.createElement('div');
            tempTabBar.id = 'tab-bar';
            tempTabBar.className = 'tab-bar';
            mainElement?.querySelector('.main-content')?.insertAdjacentElement('beforebegin', tempTabBar);
            tabBar = tempTabBar;
        }

        const chatAreaWrapper = document.getElementById('chat-area-wrapper');
        const emptyState = document.getElementById('empty-state');
        const NOTIFICATION_AREA_ID = 'notification-area';
        const friendPanel = document.getElementById('friend-panel-right');
        const addFriendBtn = document.getElementById('add-friend-btn');
        const addFriendModal = document.getElementById('add-friend-modal');
        const addFriendInput = document.getElementById('add-friend-input');
        const addFriendConfirmBtn = document.getElementById('add-friend-confirm-btn');

        const friendProfileModal = document.getElementById('friend-profile-modal');
        const startChatBtn = document.getElementById('start-chat-btn');
        const modalFriendAvatar = document.getElementById('modal-friend-avatar');
        const modalFriendName = document.getElementById('modal-friend-name');
        const modalFriendStatus = document.getElementById('modal-friend-status');
        const friendList = document.getElementById('friend-list');

        const memberList = document.getElementById('member-list');
        const inviteMemberBtn = document.getElementById('invite-member-btn');
        const inviteMemberModal = document.getElementById('invite-member-modal');
        const inviteFriendList = document.getElementById('invite-friend-list');

        if (memberList) {
            memberList.innerHTML = '<div class="empty-member">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ë©´ ì°¸ì—¬ìê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
        }

        // --- STOMP/WebSocket ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ---
        let stompClient = null;
        let subscriptions = {}; // { tabId: StompSubscription }
        let currentRoomId = null; // í˜„ì¬ í™œì„±í™”ëœ ì±„íŒ…ë°©ì˜ ID (tabId)
        let currentRoomIdForAdd = null; // ë©¤ë²„ ì¶”ê°€ ëª¨ë‹¬ìš© Room ID
        // ------------------------------------

        // ë§´ë²„ ëª©ë¡
        const chatParticipants = {};
        const myProfile = {
           userId: '[[${myProfile?.id}]]' === '' ? null : '[[${myProfile?.id}]]',
           email: '[[${myProfile?.email}]]' ? '[[${myProfile?.email}]]' : '',
           nickName: '[[${myProfile?.nickName}]]' ? '[[${myProfile?.nickName}]]' : ''
        };
        myProfile.initial = getKoreanInitials(myProfile.nickName);
        // ê²€ì¦ ë¡œê·¸
        console.log("DEBUG: My Profile Data:", myProfile);
        console.log("DEBUG: User ID Status:",
            myProfile.userId === '' ? 'EMPTY STRING (Error likely)' : `OK (${myProfile.userId})`
        );

        // ìƒíƒœ...
        let currentLeftView = null;
        let activeTabId = null;
        let modalFriendData = null;
        const openTabs = {}; // { tabId: {type,name,roomId} }
        const chatHistories = {}; // { tabId: [ {type,text,time,senderInitial?} ] }
        let isSending = false; // ì¤‘ë³µ ì „ì†¡ ë°©ì§€ í”Œë˜ê·¸
        const fileListManagers = {}; // { tabId: FileAreaManagerInstance }

        const getCurrentTime = () =>
            new Date().toLocaleTimeString('ko-KR', { hour: 'numeric', minute: '2-digit', hour12: true });

        // --- STOMP/WebSocket ì—°ê²° ë° í†µì‹  ë¡œì§ ---
        function connectStomp() {
            if (stompClient && stompClient.connected) {
                return;
            }

            const socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);

            // [ìˆ˜ì • 1] ì¿ í‚¤ì—ì„œ ì•¡ì„¸ìŠ¤ í† í° ê°€ì ¸ì˜¤ê¸°
            const jwtToken = getCookie('access-token'); // ì¿ í‚¤ ì´ë¦„ í™•ì¸ í•„ìš”

            // [ìˆ˜ì • 2] í—¤ë” ê°ì²´ ìƒì„±
            const headers = {
                'Authorization': 'Bearer ' + jwtToken,
                'access-token': jwtToken
            };

            // [ìˆ˜ì • 3] connect í•¨ìˆ˜ì— headers ì „ë‹¬
            stompClient.connect(headers, (frame) => { // headers ê°ì²´ ì „ë‹¬
                console.log('STOMP Connected: ' + frame);
                Object.keys(openTabs).forEach(tabId => {
                    if (openTabs[tabId].type === 'group' || openTabs[tabId].type === 'friend') {
                        subscribeChatRoom(tabId, openTabs[tabId].roomId);
                    }
                });
            }, (error) => {
                console.error('STOMP Connection Error: ' + error);
                setTimeout(connectStomp, 5000);
            });
        }

        function subscribeChatRoom(tabId, roomId) {
            if (subscriptions[tabId] || !stompClient || !stompClient.connected) {
                return;
            }

            const subscription = stompClient.subscribe(`/sub/chat/room/${roomId}`, (message) => {
                const receivedMessage = JSON.parse(message.body);

                // myProfileì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë°©ì–´ì ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                const myEmail = (myProfile && myProfile.email) || '';
                if (receivedMessage.sender === myEmail) {
                    console.log(`[STOMP ECHO] ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ì—ì½” ìˆ˜ì‹ . ë¬´ì‹œ ì²˜ë¦¬.`);
                    return; // í•¨ìˆ˜ ì¢…ë£Œ: ì´ ë©”ì‹œì§€ëŠ” ì´ë¯¸ sendStompMessageì—ì„œ ë Œë”ë§ë¨
                }

                // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹ˆê±°ë‚˜ (ë‹¤ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€),
                // myProfile ë¡œë“œê°€ ì™„ë£Œë˜ê¸° ì „ì— ì„œë²„ ì—ì½”ê°€ ëŒì•„ì™”ì§€ë§Œ
                // sendStompMessageì—ì„œ ë Œë”ë§í•˜ì§€ ì•Šì€ ë©”ì‹œì§€ì— ëŒ€í•´
                // displayReceivedMessage(tabId, receivedMessage, false); ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
                displayReceivedMessage(tabId, receivedMessage);
            });

            subscriptions[tabId] = subscription;
            console.log(`STOMP Subscribed to: /sub/chat/room/${roomId}`);
        }



        // --- íŒŒì¼ ì „ì†¡ ê´€ë ¨ REST API í•¨ìˆ˜ ---
        async function uploadFile(file, roomId, senderEmail) {
            const ACCESS_TOKEN_COOKIE_NAME = 'access-token';
            const jwtToken = getCookie(ACCESS_TOKEN_COOKIE_NAME);
            if (!jwtToken) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return null;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('roomId', roomId);
            formData.append('senderEmail', senderEmail); // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°›ëŠ” íŒŒë¼ë¯¸í„°ëª… í™•ì¸

            try {
                const response = await fetch('/api/chat/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}` },
                    body: formData
                });

                if (!response.ok) throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');

                // [í•µì‹¬] ì„œë²„ê°€ ë³´ë‚¸ JSON (originalFileName, storageKey, fileUrl) ë°˜í™˜
                return await response.json();
            } catch (error) {
                console.error('File Upload Error:', error);
                return null;
            }
        }

        // STOMP ë©”ì‹œì§€ í™•ì¥ í•¨ìˆ˜ (ë¯¸ë””ì–´ í¬í•¨)
        function sendMediaStompMessage(tabId, roomId, type, fileUrl, metadata, caption) {
            if (!stompClient || !stompClient.connected) {
                console.error('STOMP connection missing for media.');
                return;
            }

            const tabInfo = openTabs[tabId];
            const roomChatType = tabInfo.type.toUpperCase();

            const chatMessage = {
                chatType: roomChatType,
                roomId: roomId,
                sender: myProfile.email,
                message: caption || '',   // ìº¡ì…˜ì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
                type: type,               // 'IMAGE' or 'FILE'
                fileUrl: fileUrl,
                metadata: metadata,       // JSON ë¬¸ìì—´ ìƒíƒœ
                senderName: myProfile.nickName,
                senderInitial: myProfile.initial
                // createdAt ì œê±° í™•ì¸ (ì„œë²„ê°€ ì²˜ë¦¬)
            };

            // ğŸ”‘ [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ ë©”ì‹œì§€ ë³´ë‚¼ ë•Œë„ ì¸ì¦ í—¤ë” í•„ìˆ˜!
            const jwtToken = getCookie('access-token');
            const headers = { 'Authorization': 'Bearer ' + jwtToken };

            console.log(`ğŸš€ [MEDIA SEND] Type: ${type}, URL: ${fileUrl}`);

            // headers ê°ì²´ ì¶”ê°€
            stompClient.send(`/pub/chat/message`, headers, JSON.stringify(chatMessage));
        }



        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° íŒì—… í•¨ìˆ˜
        function handleDownload(storageKey, metadata) {
             try {
                 const meta = JSON.parse(metadata);
                 const fileName = meta.fileName || 'unknown_file';

                 // API í˜¸ì¶œ ê·œì•½ ë³€ê²½: storageKey ì‚¬ìš©
                 const downloadUrl = `/api/chat/download?storageKey=${encodeURIComponent(storageKey)}&fileName=${encodeURIComponent(fileName)}`;

                 if (confirm(`íŒŒì¼ "${fileName}"ì„(ë¥¼) ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                     window.open(downloadUrl, '_blank');
                 }
             } catch (e) {
                 console.error('Download preparation failed:', e);
                 alert('ë‹¤ìš´ë¡œë“œ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
             }
        }

        // ë‹¤ìš´ë¡œë“œ í•¸ë“¤ëŸ¬
        window.handleDownload = handleDownload;
        window.handleImageClick = (url) => { window.open(url, '_blank'); };

        // --- File Area Manager í´ë˜ìŠ¤ ---
        class FileAreaManager {
            constructor(chatAreaEl, tabId, roomId) {
                this.tabId = tabId;
                this.roomId = roomId;
                this.chatAreaEl = chatAreaEl;
                this.fileDropArea = chatAreaEl.querySelector('.file-drop-area');
                this.previewContainer = chatAreaEl.querySelector('.file-preview-container');
                this.fileListEl = chatAreaEl.querySelector('.file-list-summary');
                this.sendBtn = chatAreaEl.querySelector('.chat-send-btn');
                this.inputEl = chatAreaEl.querySelector('.chat-input');
                this.fileInput = chatAreaEl.querySelector('.file-input-hidden');
                this.toggleBtn = chatAreaEl.querySelector('.file-toggle-btn');
                this.fileList = [];

                if (!this.fileDropArea || !this.previewContainer || !this.inputEl || !this.sendBtn) { return; }

                this.addEventListeners();
                this.updateSendButtonState();
            }

            addEventListeners() {
                this.toggleBtn.addEventListener('click', () => {
                    // 1. íŒŒì¼ ë“œë¡­ ì˜ì—­ì˜ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœë¥¼ í† ê¸€
                    const isActive = this.fileDropArea.classList.toggle('active'); // í† ê¸€ í›„ì˜ ìƒˆë¡œìš´ ìƒíƒœ

                    this.toggleBtn.textContent = 'âœ–';

                    // 2. ìƒˆë¡œìš´ ìƒíƒœ(isActive)ì— ë”°ë¼ ë²„íŠ¼ì˜ íšŒì „ í´ë˜ìŠ¤ë¥¼ ì œì–´
                    if (isActive) {
                         // ì˜ì—­ì´ ë°©ê¸ˆ ì—´ë ¸ë‹¤ë©´ (active: true) -> 'âœ–' ëª¨ì–‘(0ë„ íšŒì „)
                         this.toggleBtn.classList.add('opened');
                    } else {
                         // ì˜ì—­ì´ ë°©ê¸ˆ ë‹«í˜”ë‹¤ë©´ (active: false) -> '+' ëª¨ì–‘(45ë„ íšŒì „)
                         this.toggleBtn.classList.remove('opened');
                         // ë²„íŠ¼í´ë¦­ì‹œ ì—…ë¡œë“œíŒŒì¼ ë¦¬ìŠ¤íŠ¸ ì „ë¶€ì œê±°
                         this.clearFiles();
                    }
                });

                // --- ë“œë˜ê·¸/ë“œë¡­ ì´ë²¤íŠ¸ ---
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    this.fileDropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });

                this.fileDropArea.addEventListener('dragenter', () => this.fileDropArea.classList.add('highlight'));
                this.fileDropArea.addEventListener('dragleave', () => this.fileDropArea.classList.remove('highlight'));

                this.fileDropArea.addEventListener('drop', (e) => {
                    this.fileDropArea.classList.remove('highlight');
                    this.handleDrop(e.dataTransfer.files);
                });

                // --- íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ---
                this.fileInput.addEventListener('change', (e) => {
                     this.handleDrop(e.target.files);
                     e.target.value = null;
                });

                // íŒŒì¼ ë“œë¡­ ì˜ì—­ í´ë¦­ ì‹œ input í´ë¦­ ìœ ë„
                this.fileDropArea.addEventListener('click', () => {
                     this.fileInput.click();
                });

                // ğŸ”‘ [ì¶”ê°€] íŒŒì¼ ëª©ë¡ ìš”ì•½ ì»¨í…Œì´ë„ˆì— ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•˜ì—¬ X ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
                this.fileListEl.addEventListener('click', (e) => {
                    const button = e.target.closest('.remove-file-btn');
                    if (button) {
                        const fileName = button.dataset.fileName;
                        // removeFile í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ this.fileListì—ì„œ íŒŒì¼ ì œê±° ë° UI ì—…ë°ì´íŠ¸
                        this.removeFile(fileName);
                    }
                });


                // --- í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ (Send ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”) ---
                this.inputEl.addEventListener('input', () => {
                    this.updateSendButtonState();
                });

                // --- ì—”í„° í‚¤ ì…ë ¥ ì´ë²¤íŠ¸ (ì±„íŒ…/íŒŒì¼ ì „ì†¡) ---
                this.inputEl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSend();
                    }
                });

                // --- ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ---
                this.sendBtn.addEventListener('click', () => {
                    this.handleSend();
                });
            }

            handleDrop(files) {
                Array.from(files).forEach(file => {
                     const fileType = file.type.startsWith('image/') ? 'IMAGE' : 'FILE';
                     this.fileList.push({ file: file, type: fileType, name: file.name, size: file.size });
                });
                this.updateUI();
            }

            removeFile(fileName) {
                this.fileList = this.fileList.filter(f => f.name !== fileName);
                this.updateUI();
            }

            clearFiles() {
                this.fileList = [];
                this.updateUI();
                this.fileDropArea.classList.remove('active');

                // íŒŒì¼ ëª©ë¡ì´ ë¹„ì›Œì§ˆ ë•Œ 'opened' í´ë˜ìŠ¤ë¥¼ ì œê±°í•˜ì—¬ + ëª¨ì–‘(45ë„)ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.
                this.toggleBtn.classList.remove('opened');
                this.toggleBtn.textContent = 'âœ–';
            }
            updateSendButtonState() {
                 const hasText = this.inputEl.value.trim().length > 0;
                 const hasFiles = this.fileList.length > 0;
                 this.sendBtn.disabled = !(hasText || hasFiles);
            }

            updateUI() {
                this.updateSendButtonState();

                // 1. ğŸ”‘ [ìˆ˜ì • 1] íŒŒì¼ ëª©ë¡ ìš”ì†ŒëŠ” ì¦‰ì‹œ ë¹„ì›ë‹ˆë‹¤.
                this.fileListEl.innerHTML = '';

                // 2. íŒŒì¼ì´ ì—†ëŠ” ê²½ìš°
                if (this.fileList.length === 0) {

                    // ğŸ”‘ [ìˆ˜ì • 2: í•µì‹¬] ë¨¼ì € has-files í´ë˜ìŠ¤ë¥¼ ì œê±°í•˜ì—¬ CSS Transition (max-height: 200px -> 0)ì„ ì¦‰ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
                    this.previewContainer.classList.remove('has-files');

                    // ğŸ”‘ [ìˆ˜ì • 3: ì•ˆì •ì„± í™•ë³´] Transition ì‹œê°„(0.3s)ì´ ì§€ë‚œ í›„, DOMì—ì„œ ë‚´ìš©ë¬¼ì„ ì™„ì „íˆ ì œê±°í•˜ê³  display: noneìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.
                    // Transitionì´ ë¶€ë“œëŸ½ê²Œ ì™„ë£Œë  ì‹œê°„ì„ ì¤ë‹ˆë‹¤.
                    setTimeout(() => {
                        this.previewContainer.innerHTML = '';
                        this.previewContainer.style.display = 'none'; // ì˜ì—­ì„ ì™„ì „íˆ ì œê±° (max-height 0 ì™„ë£Œ í›„)
                    }, 350);

                    return;
                }

                // 3. íŒŒì¼ì´ ìˆëŠ” ê²½ìš°

                // ğŸ”‘ [ìˆ˜ì • 4: í•„ìˆ˜] íŒŒì¼ì´ ê°±ì‹ ë  ë•Œë§ˆë‹¤ í”„ë¦¬ë·° ì»¨í…Œì´ë„ˆì˜ ë‚´ìš©ì„ ê°€ì¥ ë¨¼ì € ë¹„ì›ë‹ˆë‹¤.
                // ì´ì „ íŒŒì¼ì˜ ë¯¸ë¦¬ë³´ê¸°ê°€ ë‚¨ì•„ìˆì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
                this.previewContainer.innerHTML = '';

                // display: flexë¥¼ ì„¤ì •í•˜ê³  has-files í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•˜ì—¬ Transition (max-height: 0 -> 200px)ì„ ì‹œì‘í•©ë‹ˆë‹¤.
                this.previewContainer.style.display = 'flex';
                this.previewContainer.classList.add('has-files');

                const hasNonImage = this.fileList.some(f => f.type === 'FILE');

                if (!hasNonImage) {
                    this.renderImagePreviews();
                } else {
                    this.previewContainer.innerHTML = '<div class="file-preview-message">íŒŒì¼ í¬í•¨: ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ</div>';
                }

                // 4. íŒŒì¼ ëª©ë¡ ìš”ì•½ì„ fileListElì— ë‹¤ì‹œ ë Œë”ë§
                this.fileList.forEach(f => {
                     const cleanFileName = f.name.replace(/'/g, "\\'");
                     // console.log(fileListManagers); // ì½˜ì†” ë¡œê·¸ëŠ” í”„ë¡œë•ì…˜ ì½”ë“œì—ì„œëŠ” ì œê±°í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
                     this.fileListEl.insertAdjacentHTML('beforeend',
                        `<div class="file-summary-item">
                             <span>${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB)</span>
                             <button class="remove-file-btn"
                                     data-file-name="${cleanFileName}"
                                     data-tab-id="${this.tabId}">âœ–</button>
                         </div>`);
                });
            }

            renderImagePreviews() {
                 const numImages = this.fileList.length;
                 this.fileList.forEach((fileInfo) => {
                     const reader = new FileReader();
                     reader.onload = (e) => {
                         const img = document.createElement('img');
                         img.src = e.target.result;
                         img.alt = fileInfo.name;
                         img.style.maxWidth = numImages === 1 ? '100%' : '50%';
                         if (this.fileList.some(f => f.name === fileInfo.name)) {
                             this.previewContainer.appendChild(img);
                         }
                     };
                     reader.readAsDataURL(fileInfo.file);
                 });
            }

            // ì „ì†¡ í•¸ë“¤ëŸ¬ í†µí•© í•¨ìˆ˜
            handleSend() {
                const caption = this.inputEl.value.trim();
                const hasText = caption.length > 0;
                const hasFiles = this.fileList.length > 0;

                if (!hasText && !hasFiles) return;
                if (isSending) return;

                // 1. íŒŒì¼ì´ ìˆëŠ” ê²½ìš°
                if (hasFiles) {
                    this.sendFiles(caption);
                }
                // 2. í…ìŠ¤íŠ¸ë§Œ ìˆëŠ” ê²½ìš° (ì—¬ê¸°ê°€ ëŠê²¨ ìˆì—ˆìŠµë‹ˆë‹¤!)
                else if (hasText) {
                     // [ìˆ˜ì •] ì „ì—­ í•¨ìˆ˜ sendStompMessageë¥¼ ì—¬ê¸°ì„œ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤!
                     if (typeof sendStompMessage === 'function') {
                         sendStompMessage(this.tabId, this.roomId, caption);
                     } else {
                         console.error("sendStompMessage í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                     }

                     this.inputEl.value = '';
                     this.updateSendButtonState();
                }
            }


            async sendFiles(caption) {
                if (this.fileList.length === 0 || isSending) return;
                isSending = true;

                // 1. ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ ë³‘ë ¬ ì²˜ë¦¬
                const uploadPromises = this.fileList.map(fileInfo =>
                    uploadFile(fileInfo.file, this.roomId, myProfile.email)
                );

                try {
                    const responses = await Promise.all(uploadPromises);
                    const currentTime = getCurrentTime(); // í˜„ì¬ ì‹œê°„ì„ ë¯¸ë¦¬ ê°€ì ¸ì˜µë‹ˆë‹¤.

                    // 2. ì—…ë¡œë“œ ì„±ê³µí•œ íŒŒì¼ë“¤ì— ëŒ€í•´ STOMP ë©”ì‹œì§€ ì „ì†¡ ë° ë‚™ê´€ì  ë Œë”ë§
                    responses.forEach((response, index) => {
                        if (response) {
                            const fileUrl = response.fileUrl ? response.fileUrl : `/api/chat/download/${response.storageKey}`;
                            const originalFileInfo = this.fileList[index];
                            const messageType = originalFileInfo.type; // 'IMAGE' or 'FILE'

                            // [í•µì‹¬] ë©”íƒ€ë°ì´í„° JSON ìƒì„± (DB ì €ì¥ìš©)
                            const metadataObj = {
                                fileName: response.originalFileName,
                                fileUrl: fileUrl,
                                fileSize: originalFileInfo.size,
                                storageKey: response.storageKey
                            };
                            const metadataJson = JSON.stringify(metadataObj);
                            // A. í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ì‹œ í‘œì‹œ (ë‚™ê´€ì  ë Œë”ë§)
                            const optimisticMessage = {
                                createdAt: new Date().toISOString(),
                                sender: myProfile.email,
                                senderName: myProfile.nickName,
                                time: currentTime,
                                type: 'mine', // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì„ì„ ê°•ì œ
                                messageType: messageType,
                                fileUrl: fileUrl,
                                metadata: metadataJson,
                                message: caption // ìº¡ì…˜ í…ìŠ¤íŠ¸
                            };

                            // 3. í´ë¼ì´ì–¸íŠ¸ í™”ë©´ì— ì¦‰ì‹œ í‘œì‹œ
                            if (typeof displayReceivedMessage === 'function') {
                                // this.tabIdë¥¼ ì²« ë²ˆì§¸ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ì •í™•íˆ ì°¾ë„ë¡ ìˆ˜ì •
                                displayReceivedMessage(this.tabId, optimisticMessage, true);
                            } else {
                                console.error("displayReceivedMessage í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë©”ì‹œì§€ ì¦‰ì‹œ ë Œë”ë§ ì‹¤íŒ¨.");
                            }


                            // B. ë¯¸ë””ì–´ ë©”ì‹œì§€ ì „ì†¡ (ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„°)
                            sendMediaStompMessage(
                                this.tabId,
                                this.roomId,
                                messageType,   // 'IMAGE' or 'FILE'
                                fileUrl,
                                metadataJson,
                                caption
                            );
                        }
                    });
                    this.clearFiles();
                    this.inputEl.value = '';

                    // ì´ë¯¸ì§€ ëª¨ë‹¬ ë¼ì´íŠ¸ë°•ìŠ¤ ê°±ì‹ 
                    if (typeof initializeChatLightbox === 'function') {
                        initializeChatLightbox();
                    }

                } catch (e) {
                    console.error("íŒŒì¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:", e);
                } finally {
                    isSending = false;
                }
            }
        }
        // ì „ì—­ì— FileAreaManager ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ê°ì²´ (ê¸°ì¡´ ì½”ë“œì—ì„œ ì‚¬ìš©ë¨)
        window.fileListManagers = {};


        // --- ì‹¤ì œ ë°±ì—”ë“œ í†µì‹  í•¨ìˆ˜ (fetch ê¸°ë°˜) ---

        /**
         * ìƒˆ ì±„íŒ…ë°©ì„ DBì— ì €ì¥í•˜ë„ë¡ ì„œë²„ì— ìš”ì²­í•˜ê³  Room IDë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.
         */
        async function requestServerCreateRoom(roomName, roomType, memberIds) {
            const ACCESS_TOKEN_COOKIE_NAME = 'access-token';
            const jwtToken = getCookie(ACCESS_TOKEN_COOKIE_NAME);

            console.log("íšë“ëœ JWT í† í°:", jwtToken);

            if (!jwtToken) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return null;
            }

            // DTO êµ¬ì¡°ì™€ ì¼ì¹˜í•˜ëŠ” JSON ê°ì²´ ìƒì„±
            const requestData = {
                roomName: roomName,
                creatorId: myProfile.userId,
                roomType: roomType,
                memberIds: memberIds
            };

            console.log("--- ì„œë²„ ìš”ì²­ JSON ë°ì´í„° ---");
            console.log(JSON.stringify(requestData));
            console.log("----------------------------");

            try {
                const response = await fetch('/api/chat/room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify(requestData) // ìˆ˜ì •ëœ ê°ì²´ ì „ì†¡
                });

                if (!response.ok) {
                    // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€(ìˆëŠ” ê²½ìš°)ë¥¼ ì¶œë ¥í•˜ë©´ ë””ë²„ê¹…ì— ë„ì›€ë¨
                    const errorBody = await response.text();
                    throw new Error(`ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (${response.status} ${response.statusText}): ${errorBody}`);
                }
                const data = await response.json();
                console.log(`[SERVER RESPONSE] New Room Created: ID=${data.roomId}, Name=${roomName}`);
                return data.roomId;
            } catch (error) {
                console.error('Room Creation Error:', error);
                alert('ì±„íŒ…ë°© ìƒì„± ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return null;
            }
        }



        // requestServerLoadRooms í•¨ìˆ˜ ì¶”ê°€
        async function requestServerLoadRooms() {
            const ACCESS_TOKEN_COOKIE_NAME = 'access-token';
            const jwtToken = getCookie(ACCESS_TOKEN_COOKIE_NAME);

            if (!jwtToken) {
                console.error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. (í† í° ì—†ìŒ)");
                return [];
            }

            try {
                // [DB CONNECTION] ì„œë²„ì˜ ì‹¤ì œ ì±„íŒ…ë°© ëª©ë¡ API í˜¸ì¶œ (myProfile.userId ê¸°ë°˜)
                const response = await fetch(`/api/chat/room/list/${myProfile.userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.statusText);
                }

                const rooms = await response.json();
                console.log(`[SERVER RESPONSE] Loaded ${rooms.length} chat rooms for user: ${myProfile.userId}`);

                return rooms;
            } catch (error) {
                console.error('Room List Load Error:', error);
                return [];
            }
        }

        /**
         * íŠ¹ì • ë°©ì˜ ê³¼ê±° ì±„íŒ… ë‚´ì—­ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
         */
        async function requestServerLoadHistory(roomId) {
            try {
                const response = await fetch(`/api/chat/history/${roomId}`);

                if (!response.ok) throw new Error('ê³¼ê±° ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨: ' + response.statusText);
                const history = await response.json();
                console.log('history',history);
                console.log(`[SERVER RESPONSE] Loaded ${history.length} history messages for Room: ${roomId}`);
                return history; // [{senderId, senderName, message, time, type, fileUrl, metadata}, ...]
            } catch (error) {
                console.error('History Load Error:', error);
                return [];
            }
        }

        /**
         * íŠ¹ì • ë°©ì˜ ì°¸ì—¬ì ëª©ë¡ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
         */
        async function requestServerLoadParticipants(roomId) {
            try {
                const response = await fetch(`/api/chat/participants/${roomId}`); // <-- ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸
                if (!response.ok) throw new Error('ì°¸ì—¬ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + response.statusText);
                const participants = await response.json();
                console.log(`[SERVER RESPONSE] Loaded ${participants.length} participants for Room: ${roomId}`);
                console.log("participants!!!!!",participants);
                return participants; // [{email, nickName, userId}]
            } catch (error) {
                console.error('Participants Load Error:', error);
                return [];
            }
        }

        // --- ê¸°ì¡´ UI ë¡œì§ í†µí•© ë° ìˆ˜ì • ---

        function createTabButton(tabId, name, closable = true) {
            if (tabBar.querySelector(`.tab[data-tab-id="${tabId}"]`)) return;
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.tabId = tabId;
            tab.innerHTML = closable ? `${name} <span class="close-btn" data-id="${tabId}">âœ–</span>` : name;
            tabBar.appendChild(tab);

            tab.addEventListener('click', (e) => {
                if (e.target.classList.contains('close-btn')) {
                    closeTab(tabId);
                } else {
                    activateTab(tabId);
                }
            });
        }

        iconBar.addEventListener('click', (e) => {
            const btn = e.target.closest('.icon-btn');
            if (!btn) return;
            toggleLeftPanel(btn.dataset.view);
        });

        function toggleLeftPanel(view) {
            if (subPanel.classList.contains('open') && currentLeftView === view) {
                subPanel.classList.remove('open');
                iconBar.querySelector(`.icon-btn[data-view="${currentLeftView}"]`)?.classList.remove('active');
                currentLeftView = null;
            } else {
                iconBar.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('active'));
                iconBar.querySelector(`.icon-btn[data-view="${view}"]`)?.classList.add('active');
                updateSubPanelContent(view);
                subPanel.classList.add('open');
                currentLeftView = view;
            }
        }

        // updateSubPanelContent: loadAndRenderRooms í•¨ìˆ˜ ì¬ì •ì˜ ë° ì „ì—­ ë“±ë¡
        function updateSubPanelContent(view) {
            let contentHTML = '';

            if (view === 'chat') {
                contentHTML = `
                    <div class="panel-actions">
                        <label class="title-text">ì±„íŒ…ë°©</label>
                        <button id="btn-add-group">+ ìƒˆ ì±„íŒ…ë°©</button>
                    </div>
                    <div class="folder-tree chat-tree">
                        <input type="text" id="room-search" class="chat-mok" placeholder="ì±„íŒ…ë°© ê²€ìƒ‰">
                        <div class="divider"><span>ì±„íŒ… ëª©ë¡</span></div>
                        <div id="chat-room-list" class="chat-room-list">
                            <div style="text-align: center; padding: 20px;">ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>`;
            } else if (view === 'document') {
                contentHTML = `
                    <div class="panel-actions">
                        <label class="title-text">ë‚´ ë³´ê´€í•¨</label>
                    </div>
                    <div class="folder-tree">
                        <ul>
                            <li class="folder">
                                <span class="folder-label">ë³´ê´€í•¨</span>
                                <ul>
                                    <li class="file" data-type="document" data-id="d1" onclick="location.href='/api/chat/portfolio'" "data-name="í¬íŠ¸í´ë¦¬ì˜¤ë³´ê´€í•¨">í¬íŠ¸í´ë¦¬ì˜¤ ë³´ê´€í•¨</li>
                                    <li class="file" data-type="document" data-id="d2" onclick="location.href='/api/chat/coverLetter'" data-name="ìê¸°ì†Œê°œì„œë³´ê´€í•¨">ìê¸°ì†Œê°œì„œ ê²Œì‹œíŒ</li>
                                    <li class="file" data-type="document" data-id="d3" onclick="alert('ì‚¬ì§„ë³´ê´€í•¨ ë¯¸êµ¬í˜„')"data-name="ì‚¬ì§„ë³´ê´€í•¨">ì‚¬ì§„ ë³´ê´€í•¨</li>
                                </ul>
                            </li>
                        </ul>
                    </div>`;
            } else if (view === 'community') {
                contentHTML = `
                    <div class="panel-actions">
                        <label class="title-text">ì»¤ë®¤ë‹ˆí‹°</label>
                    </div>
                    <div class="folder-tree">
                        <ul>
                            <li class="folder">
                                <span class="folder-label">ê²Œì‹œíŒ</span>
                                <ul>
                                    <li class="file" data-type="community" data-id="c1" onclick="location.href='/api/chat/noticepage'" data-name="ê³µì§€ì‚¬í•­">ê³µì§€ì‚¬í•­</li>
                                    <li class="file" data-type="community" data-id="c2" onclick="location.href='/api/chat/free_community'" data-name="ììœ ê²Œì‹œíŒ">ììœ ê²Œì‹œíŒ</li>
                                    <li class="file" data-type="community" data-id="c3" onclick="location.href='/api/chat/hotissuePage'" data-name="í•«ì´ìŠˆê²Œì‹œíŒ">í•«ì´ìŠˆê²Œì‹œíŒ</li>
                                    <li class="file" data-type="community" data-id="c4" onclick="location.href='/api/chat/document'" data-name="ë¬¸ì„œê²Œì‹œíŒ">ë¬¸ì„œê²Œì‹œíŒ</li>
                                    <li class="file" data-type="community" data-id="c5" onclick="location.href='/api/chat/coverLetter'" data-name="ìì†Œì„œê²Œì‹œíŒ">ìì†Œì„œê²Œì‹œíŒ</li>
                                </ul>
                            </li>
                        </ul>
                    </div>`;
            } else {
                contentHTML = `
                    <div class="panel-actions">
                        <label class="title-text">4ì¡° í”„ë¡œì íŠ¸</label>
                    </div>
                    <div class="folder-tree">
                        <p>ê¹€í™ì„­, ë‚¨ê·œë¯¼, ì •ì§€ì›, ì •ì¬ë¯¼</p>
                    </div>`;
            }

            subPanelContent.innerHTML = contentHTML;

            function attachDeleteButtons(chatRoomList) {
                chatRoomList.querySelectorAll('.chat-room-item').forEach(item => {
                    if (item.querySelector('.delete-room')) return;
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'ì‚­ì œ';
                    delBtn.className = 'delete-room';
                    delBtn.style.marginLeft = '8px';
                    delBtn.style.background = '#000000';
                    delBtn.style.color = '#ffffff';
                    delBtn.style.border = 'none';
                    delBtn.style.borderRadius = '4px';
                    delBtn.style.cursor = 'pointer';
                    delBtn.style.padding = '2px 6px';

                    delBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const roomName = item.dataset.name;
                        const roomId = item.dataset.roomId;

                        if (confirm(`ì±„íŒ…ë°© "${roomName}"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {

                            // [DB CONNECTION] ì„œë²„ì— ë°© ì‚­ì œ ìš”ì²­
                            const success = await requestServerDeleteRoom(roomId);

                            if (success) {
                                item.remove(); // ì„œë²„ì—ì„œ ì„±ê³µí–ˆì„ ê²½ìš°ì—ë§Œ UIì—ì„œ ì œê±°
                                alert(`"${roomName}" ì±„íŒ…ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                                const tabId = `group_${item.dataset.id}`;
                                if (openTabs[tabId]) closeTab(tabId);
                            } else {
                                // ì‚­ì œ ì‹¤íŒ¨ ì‹œ ë³„ë„ ì²˜ë¦¬
                                console.warn(`ë°© ì‚­ì œ ì‹¤íŒ¨: ${roomName}`);
                            }
                        }
                    });
                    item.querySelector('.room-title')?.appendChild(delBtn);
                });
            }

            if (view === 'chat') {
                const chatRoomList = document.getElementById('chat-room-list');

                // loadAndRenderRooms: DTO í•„ë“œ ë°˜ì˜ ë° ì •ë ¬
                async function loadAndRenderRooms() {
                    try {
                        const rooms = await requestServerLoadRooms();

                        // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                        rooms.sort((a, b) => {
                             const timeA = a.lastMessageTime ? new Date(a.lastMessageTime).getTime() : 0;
                             const timeB = b.lastMessageTime ? new Date(b.lastMessageTime).getTime() : 0;
                             return timeB - timeA; // ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹ ìˆœ)
                        });

                        chatRoomList.innerHTML = '';
                        if (rooms.length === 0) {
                            chatRoomList.innerHTML = '<div style="text-align: center; padding: 20px;">ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                            return;
                        }

                        rooms.forEach(room => {
                            const item = document.createElement('div');
                            item.className = 'chat-room-item';
                            item.dataset.id = room.roomId; // ê³ ìœ  IDë¡œ ì‚¬ìš©
                            item.dataset.type = 'group';
                            item.dataset.roomId = room.roomId;
                            item.dataset.name = room.roomName;

                            const unreadBadge = room.unreadCount > 0
                                ? `<span class="unread-badge">${room.unreadCount}</span>`
                                : '';

                            // lastMessageTimeì´ ìœ íš¨í•œ ê²½ìš° í¬ë§·íŒ…
                            const lastTime = room.lastMessageTime ? new Date(room.lastMessageTime).toLocaleTimeString('ko-KR', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';

                            item.innerHTML = `
                                <div class="room-title">
                                    <span class="room-name">${room.roomName}</span>
                                    <span class="room-time">${lastTime}</span>
                                </div>
                                <div class="room-meta">
                                    <span class="room-last">${room.lastMessage || 'ìƒˆ ì±„íŒ…ë°©ì…ë‹ˆë‹¤.'}</span>
                                    <span class="room-count">${room.memberCount || 0}ëª…</span>
                                    ${unreadBadge}
                                </div>
                            `;
                            chatRoomList.appendChild(item);
                        });
                        attachDeleteButtons(chatRoomList);
                    } catch (e) {
                        console.error('Failed to render chat rooms:', e);
                        chatRoomList.innerHTML = `
                            <div style="color: red; padding: 20px;">
                                ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
                                ${e.message || 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨'}
                            </div>`;
                    }
                }
                window.loadAndRenderRooms = loadAndRenderRooms; // ì „ì—­ ë“±ë¡
                loadAndRenderRooms();

                const addGroupBtn = document.getElementById('btn-add-group');

                if (addGroupBtn) {
                    addGroupBtn.addEventListener('click', async () => {
                        const name = prompt('ìƒˆ ê·¸ë£¹ ì±„íŒ… ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ìƒˆ í”„ë¡œì íŠ¸)');
                        if (!name) return;

                        // ì„œë²„ DTOê°€ ìš”êµ¬í•˜ëŠ” í•„ìˆ˜ í•„ë“œ ì •ì˜
                        const roomType = 'GROUP';
                        const memberIds = [myProfile.userId];

                        // 1. ì„œë²„ì— ë°© ìƒì„± ìš”ì²­ ë° Room ID ë°›ê¸°
                        const newRoomId = await requestServerCreateRoom(name, roomType, memberIds);

                        if (!newRoomId) {
                            alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨)');
                            return;
                        }

                        // 2. ì„œë²„ë¡œë¶€í„° ìµœì‹  ë°© ëª©ë¡ì„ ê°€ì ¸ì™€ UIë¥¼ ì™„ì „íˆ ê°±ì‹ 
                        // (ìˆ˜ë™ìœ¼ë¡œ DOM ìš”ì†Œë¥¼ ì¶”ê°€í•˜ëŠ” ê¸°ì¡´ ë¡œì§ì€ ì œê±°)
                        await loadAndRenderRooms();

                        // 3. ì‚¬ìš©ì ì•Œë¦¼ ë° ìƒˆë¡œ ìƒì„±ëœ ë°©ìœ¼ë¡œ ì´ë™
                        alert(`"${name}" ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                        // ìƒˆë¡œ ìƒì„±ëœ ë°©ì˜ íƒ­ì„ ë°”ë¡œ ì—´ì–´ì£¼ê¸° ìœ„í•œ ë¡œì§
                        const newRoomItem = document.querySelector(`.chat-room-item[data-room-id="${newRoomId}"]`);
                        if (newRoomItem) {
                            // openTab í•¨ìˆ˜ê°€ ì ì ˆíˆ ì •ì˜ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
                            const tabId = `group_${newRoomId}`;
                        }
                    });
                }

                if (chatRoomList) {
                    chatRoomList.addEventListener('click', (e) => {
                        const item = e.target.closest('.chat-room-item');
                        if (!item || e.target.classList.contains('delete-room')) return;

                        // **[ì±„íŒ…ë°© ì§„ì…]**
                        const tabId = `group_${item.dataset.id}`;
                        const name = item.dataset.name || 'ê·¸ë£¹ ì±„íŒ…';
                        const roomId = item.dataset.roomId; // ì‹¤ì œ DB Room ID

                        // 1. íƒ­ ì—´ê¸° ë° UI ì„¤ì •
                        openTab(tabId, name, 'group', roomId);

                        // ë©”ì‹œì§€ ì´ë ¥ ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ ì¶”ê°€ (isInitialLoad: true)
                        loadChatMessages(tabId, true);

                        // (ì„ íƒ ì‚¬í•­: STOMP ì—°ê²°ë„ openTab ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬í•´ì•¼ í•¨)
                        // connectWebSocket(tabId);
                    });
                }
            }

            if (view === 'document' || view === 'community') {
                subPanelContent.querySelectorAll('.file').forEach(fileEl => {
                    fileEl.addEventListener('dblclick', () => {
                        const type = fileEl.dataset.type;
                        const id = fileEl.dataset.id;
                        const name = fileEl.dataset.name;
                        const tabId = `${type}_${id}`;
                        openTab(tabId, name, type);
                    });
                });
            }
        }
        const friendContextMenu = document.createElement('div');
        friendContextMenu.id = 'friend-context-menu';
        friendContextMenu.className = 'context-menu';
        friendContextMenu.innerHTML = `
            <div class="menu-item warning" id="ctx-friend-delete">ì¹œêµ¬ ì‚­ì œ</div>
            <div class="menu-item warning" id="ctx-friend-block">ì°¨ë‹¨</div>
            <div class="menu-item" id="ctx-friend-cancel">ì·¨ì†Œ</div>
        `;
        document.body.appendChild(friendContextMenu);

        let targetFriendEmail = null;

        // ì¹œêµ¬ ëª©ë¡ ìš°í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„
        friendList.addEventListener('contextmenu', (e) => {
            const item = e.target.closest('.friend-item');
            if (!item) return;

            e.preventDefault();
            targetFriendEmail = item.dataset.id; // email

            friendContextMenu.style.display = 'block';
            friendContextMenu.style.left = `${e.pageX}px`;
            friendContextMenu.style.top = `${e.pageY}px`;
        });

        // ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('ctx-friend-delete').addEventListener('click', () => {
            if (!targetFriendEmail) return;
            if (confirm('ì„ íƒí•œ ì¹œêµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch(`/api/friends/delete?friendEmail=${encodeURIComponent(targetFriendEmail)}`, {
                    method: 'DELETE'
                }).then(res => {
                    if (res.ok) {
                        window.WindowLoadFriendList(); // ëª©ë¡ ê°±ì‹ 
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ì‚­ì œ ì‹¤íŒ¨');
                    }
                });
            }
            friendContextMenu.style.display = 'none';
        });

        document.getElementById('ctx-friend-block').addEventListener('click', () => {
            if (!targetFriendEmail) return;
            if (confirm('ì„ íƒí•œ ìœ ì €ë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch(`/api/friends/block?blockedEmail=${encodeURIComponent(targetFriendEmail)}`, {
                    method: 'POST'
                }).then(res => {
                    if (res.ok) {
                        window.WindowLoadFriendList(); // ëª©ë¡ ê°±ì‹  (ì¹œêµ¬ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§)
                        // ì°¨ë‹¨ ëª©ë¡ ê°±ì‹  ë¡œì§ì´ ìˆë‹¤ë©´ í˜¸ì¶œ (fetchAndRenderBlockList)
                        if (window.fetchAndRenderBlockList) window.fetchAndRenderBlockList();
                        alert('ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ì°¨ë‹¨ ì‹¤íŒ¨');
                    }
                });
            }
            friendContextMenu.style.display = 'none';
        });

        document.getElementById('ctx-friend-cancel').addEventListener('click', () => {
            friendContextMenu.style.display = 'none';
        });

        // ë°°ê²½ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            if (!friendContextMenu.contains(e.target)) {
                friendContextMenu.style.display = 'none';
            }
        });
        /**
         * íŠ¹ì • Room IDë¥¼ ì„œë²„ì— ì „ì†¡í•˜ì—¬ DBì—ì„œ ì‚­ì œí•˜ë„ë¡ ìš”ì²­í•©ë‹ˆë‹¤.
         */
        async function requestServerDeleteRoom(roomId) {
            const ACCESS_TOKEN_COOKIE_NAME = 'access-token';
            const jwtToken = getCookie(ACCESS_TOKEN_COOKIE_NAME);

            if (!jwtToken) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return false;
            }

            try {
                const response = await fetch(`/api/chat/room/${roomId}`, {
                    method: 'DELETE', // HTTP DELETE ë©”ì„œë“œ ì‚¬ìš©
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ì±„íŒ…ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.statusText);
                }

                console.log(`[SERVER RESPONSE] Room Deleted: ID=${roomId}`);
                return true; // ì‚­ì œ ì„±ê³µ
            } catch (error) {
                console.error('Room Deletion Error:', error);
                alert('ì±„íŒ…ë°© ì‚­ì œ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return false; // ì‚­ì œ ì‹¤íŒ¨
            }
        }

        addFriendBtn.addEventListener('click', () => {
            addFriendModal.classList.add('open');
            window.WindowLoadReceivedRequests();
            friendSearchInput.focus();
        });

        function showAddMemberModal(tabId) {
            if (!addMemberModal || !memberSearchInput || !memberSearchResultsList) {
                console.error("ERROR: ë©¤ë²„ ì¶”ê°€ ëª¨ë‹¬ ê´€ë ¨ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HTML IDë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                return;
            }

            // 1. rawId (UUID) ì¶”ì¶œ
            currentRoomIdForAdd = openTabs[tabId]?.roomId;

            // 2. ëª¨ë‹¬ ë‚´ìš© ì´ˆê¸°í™” ë° í‘œì‹œ
            memberSearchInput.value = '';
            memberSearchResultsList.innerHTML = '<div class="info-message">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì´ë©”ì¼, ë‹‰ë„¤ì„, ì´ë¦„)</div>';
            addMemberModal.classList.add('open');
            memberSearchInput.focus();
        }
        if (memberSearchInput) {
            memberSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length > 1 && currentRoomIdForAdd) {
                    searchUsersForRoom(query, currentRoomIdForAdd);
                } else {
                    memberSearchResultsList.innerHTML = '<div class="info-message">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
                }
            });
        }

        // --- A. ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ë° ë Œë”ë§ ---
        window.WindowLoadFriendList = function loadFriendList() {
            fetch('/api/friends/list', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (!response.ok) throw new Error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + response.status);
                return response.json();
            })
            .then(friends => {
                renderFriendList(friends);
            })
            .catch(error => {
                console.error('âŒ ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                if (friendList) {
                    friendList.innerHTML = `<div class="empty-list error">ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜</div>`;
                }
            });
        }
        /**
         * ì„œë²„ì—ì„œ ë°›ì€ ì¹œêµ¬ ë°ì´í„°ë¥¼ í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤. (ìˆ˜ì •ë¨: friend.userName ì‚¬ìš©)
         * @param {Array<Object>} friends - UserDto ê°ì²´ì˜ ë°°ì—´
         */
        function renderFriendList(friends) {
            if (!friendList) return;

            if (friends.length === 0) {
                friendList.innerHTML = `<div class="empty-list">ì•„ì§ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            const getMockStatus = (index) => {
                const statuses = ['ì˜¨ë¼ì¸', 'ì˜¤í”„ë¼ì¸', 'íšŒì˜ ì¤‘'];
                return statuses[index % statuses.length];
            };

            friendList.innerHTML = friends.map((friend, index) => {
                const mockStatus = getMockStatus(index);
                const statusClass = mockStatus.toLowerCase().replace(/\s/g, '-');

                // friend.userName ì‚¬ìš©
                const initial = friend.userName ? friend.userName[0] : '?';

                return `
                    <div class="friend-item"
                         data-id="${friend.email}"
                         data-name="${friend.userName}"
                         data-status="${mockStatus}"
                         data-status-class="${statusClass}">
                        <div class="avatar">${initial}</div>
                        <div class="name">${friend.userName}</div>
                        <div class="status-dot ${statusClass}"></div>
                    </div>`;
            }).join('');
        }

        // --- B. ì¹œêµ¬ ê²€ìƒ‰ ë¡œì§ (friendSearchInput ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” DOMContentLoaded ì‹œì‘ ë¶€ë¶„ì—ì„œ ì´ë¯¸ ìºì‹±ë¨) ---
        if (friendSearchInput) {
            friendSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length > 1) {
                    searchUsers(query);
                } else {
                    if (searchResultsList) searchResultsList.innerHTML = '';
                }
            });
        }
        /**
         * ì‚¬ìš©ì ê²€ìƒ‰ APIë¥¼ í˜¸ì¶œí•˜ê³  ê²°ê³¼ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. (ìˆ˜ì •ë¨: user.userName ì‚¬ìš©)
         */
        function searchUsers(query) {
            if (!searchResultsList) return;
            searchResultsList.innerHTML = '<div class="loading-message">ê²€ìƒ‰ ì¤‘...</div>';

            fetch(`/api/friends/search?query=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(users => {
                    if (users.length === 0) {
                        searchResultsList.innerHTML = '<div class="info-message">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        btnSendRequests.style.display = 'none';
                        return;
                    }

                    // ì²´í¬ë°•ìŠ¤ ëª¨ë“œ ë Œë”ë§
                    searchResultsList.innerHTML = users.map(user => {
                        if (user.email === myProfile.email) return '';
                        const initial = user.userName ? user.userName[0] : '?';

                        return `
                            <div class="search-result-item">
                                <div class="avatar" style="width:32px; height:32px; font-size:14px;">${initial}</div>
                                <div style="margin-left:10px;">
                                    <div style="font-weight:bold; font-size:13px;">${user.userName}</div>
                                    <div style="font-size:11px; color:#888;">${user.email}</div>
                                </div>
                                <input type="checkbox" class="user-checkbox" value="${user.email}">
                            </div>`;
                    }).join('');

                    // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë²„íŠ¼ í‘œì‹œ
                    btnSendRequests.style.display = 'block';
                });
        }
        // [ê¸°ëŠ¥ 2] ì„ íƒí•œ ì¹œêµ¬ë“¤ì—ê²Œ ìš”ì²­ ë³´ë‚´ê¸°
        btnSendRequests.addEventListener('click', async () => {
            const checkboxes = searchResultsList.querySelectorAll('.user-checkbox:checked');
            if (checkboxes.length === 0) {
                alert("ìš”ì²­ì„ ë³´ë‚¼ ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const promises = Array.from(checkboxes).map(cb => {
                const receiverEmail = cb.value;
                return fetch('/api/friends/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receiverEmail: receiverEmail })
                });
            });

            try {
                await Promise.all(promises);
                alert(`${checkboxes.length}ëª…ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
                btnSendRequests.style.display = 'none';
                searchResultsList.innerHTML = '';
                document.getElementById('friend-search-input').value = '';
            } catch (e) {
                console.error(e);
                alert("ì¼ë¶€ ìš”ì²­ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        async function searchUsersForRoom(query, roomId) {
            memberSearchResultsList.innerHTML = '<div class="loading-message">ê²€ìƒ‰ ì¤‘...</div>';

            try {
                // [ìˆ˜ì • A] 1. í˜„ì¬ ì±„íŒ…ë°© ë©¤ë²„ ì´ë©”ì¼ ëª©ë¡ì„ ë¨¼ì € ê°€ì ¸ì˜µë‹ˆë‹¤.
                const currentMembersEmails = await fetchCurrentMembersEmails(roomId);

                // 2. ì „ì²´ ì‚¬ìš©ì ê²€ìƒ‰ ê²°ê³¼ ë¡œë“œ (ê¸°ì¡´ ë¡œì§)
                const response = await fetch(`/api/user/search?query=${encodeURIComponent(query)}`);
                const users = await response.json();

                // [ìˆ˜ì • B] 3. í˜„ì¬ ë©¤ë²„ê°€ ì•„ë‹Œ ì‚¬ìš©ìë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
                const filteredUsers = users.filter(user => {
                    // user.emailì´ currentMembersEmails ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ true ë°˜í™˜
                    return !currentMembersEmails.includes(user.email);
                });

                if (filteredUsers.length === 0) {
                    memberSearchResultsList.innerHTML = '<div class="info-message">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. (í˜¹ì€ ê²€ìƒ‰ëœ ì‚¬ìš©ìê°€ ì´ë¯¸ ëª¨ë‘ ë©¤ë²„ì…ë‹ˆë‹¤.)</div>';
                    return;
                }

                // 4. ë Œë”ë§ (filteredUsers ì‚¬ìš©)
                memberSearchResultsList.innerHTML = filteredUsers.map(user => {
                    // userIdê°€ ì—†ë‹¤ë©´ emailì„ fallbackìœ¼ë¡œ ì‚¬ìš©
                    const userId = user.id || user.email;
                    const initial = user.userName ? user.userName[0] : '?';

                    return `
                        <div class="search-result-item" data-id="${userId}">
                            <div class="avatar">${initial}</div>
                            <div class="name">${user.userName || user.nickName} (${user.email})</div>
                            <input type="checkbox" class="member-checkbox" data-user-id="${userId}">
                        </div>`;
                }).join('');

            } catch (error) {
                console.error('ì‚¬ìš©ì ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                memberSearchResultsList.innerHTML = '<div class="error-message">ì‚¬ìš©ì ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        /**
         * GLightboxë¥¼ ì´ˆê¸°í™”í•˜ê±°ë‚˜, ìƒˆë¡œ ì¶”ê°€ëœ '.glightbox' ìš”ì†Œì— ëŒ€í•´ ê¸°ëŠ¥ì„ ì¬ë°”ì¸ë”©í•˜ëŠ” í•¨ìˆ˜
         * ì´ í•¨ìˆ˜ëŠ” ìƒˆ ë©”ì‹œì§€ê°€ DOMì— ì¶”ê°€ë  ë•Œë§ˆë‹¤ í˜¸ì¶œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
         */
        function initializeChatLightbox() {
            if (chatLightboxInstance) {
                chatLightboxInstance.destroy();
                chatLightboxInstance = null;
            }

            // 1. ëª¨ë“  ì´ë¯¸ì§€ ìš”ì†Œ ì„ íƒ
            const images = document.querySelectorAll('.chat-messages .image-preview');
            let imagesLoaded = 0;

            // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° (ìºì‹œëœ ê²½ìš°) ë°”ë¡œ ì´ˆê¸°í™”
            if (images.length === 0 || Array.from(images).every(img => img.complete)) {
                createLightboxInstance();
                return;
            }

            // 2. ê° ì´ë¯¸ì§€ì˜ ë¡œë“œ ìƒíƒœë¥¼ ê°ì‹œ
            images.forEach(img => {
                if (img.complete) {
                    // ì´ë¯¸ ë¡œë“œ ì™„ë£Œëœ ê²½ìš°
                    imagesLoaded++;
                } else {
                    // ë¡œë“œ ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¼
                    img.onload = () => {
                        imagesLoaded++;
                        if (imagesLoaded === images.length) {
                            // ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ë©´ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
                            createLightboxInstance();
                        }
                    };
                    // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì¹´ìš´íŠ¸ (ë¬´í•œ ëŒ€ê¸° ë°©ì§€)
                    img.onerror = () => {
                        imagesLoaded++;
                        if (imagesLoaded === images.length) {
                            createLightboxInstance();
                        }
                    };
                }
            });

            // 3. GLightbox ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í•¨ìˆ˜ (ì˜µì…˜ì€ ì—¬ê¸°ì— ìœ„ì¹˜)
            function createLightboxInstance() {
                // ì´ë¯¸ 200ms ë”œë ˆì´ë¥¼ ì£¼ì—ˆë”ë¼ë„, ì•ˆì „í•˜ê²Œ ìµœì¢… ìƒì„±
                chatLightboxInstance = GLightbox({
                    selector: '.glightbox',
                    gallery: 'chat-photos',
                    loop: true,
                    caption: false,
                    draggable: false,
                    zoomable: true,
                    touchNavigation: true,
                    keyboardNavigation: true,
                    openEffect: 'zoom',
                    closeEffect: 'zoom',
                    mousewheel: true,
                    download: false,
                });
                // console.log("GLightbox: ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ ì´ˆê¸°í™” ì™„ë£Œ");
            }
        }
        function appendChatMessageToDOM(messageData, skipScroll = false) {
            // 1. ë©”ì‹œì§€ HTML ìƒì„±
            const messageHtml = createChatMessageHTML(messageData);

            // 2. ì±„íŒ… ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const chatContainer = document.getElementById(`chat-messages-${messageData.tabId}`); // messageDataì— tabIdê°€ ìˆì–´ì•¼ í•¨

            // íƒ­ IDê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ activeTabId ì‚¬ìš© (fallback)
            const targetContainer = chatContainer || document.getElementById(`chat-messages-${activeTabId}`);

            if (targetContainer) {
                // 3. ì±„íŒ… ì»¨í…Œì´ë„ˆì— ìƒˆ ë©”ì‹œì§€ ì¶”ê°€
                targetContainer.insertAdjacentHTML('beforeend', messageHtml);

                // 4. [í•µì‹¬ ìˆ˜ì •] skipScrollì´ trueì¼ ê²½ìš° ìŠ¤í¬ë¡¤ ë¡œì§ì„ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ
                if (skipScroll) {
                    // ê³¼ê±° ë‚´ì—­ ë¡œë”© ì¤‘ì´ë¯€ë¡œ ìŠ¤í¬ë¡¤ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
                    // (GLightbox ì´ˆê¸°í™”ëŠ” í•„ìš”í•  ìˆ˜ ìˆìŒ)
                    initializeChatLightbox();
                    return;
                }

                // --- ë¼ì´ë¸Œ ë©”ì‹œì§€(ì‹¤ì‹œê°„)ì¼ ë•Œë§Œ ì•„ë˜ ë¡œì§ ì‹¤í–‰ ---
                setTimeout(() => {
                    const lastMessageElement = targetContainer.lastElementChild;
                    const img = lastMessageElement ? lastMessageElement.querySelector('img') : null;

                    if (img) {
                        img.onload = () => { targetContainer.scrollTop = targetContainer.scrollHeight; };
                        if (img.complete) { targetContainer.scrollTop = targetContainer.scrollHeight; }
                    } else {
                        targetContainer.scrollTop = targetContainer.scrollHeight;
                    }
                }, 10);

                initializeChatLightbox();
            }
        }
        if (addFriendConfirmBtn && addFriendInput && friendList) {
            addFriendConfirmBtn.addEventListener('click', () => {
                const name = (addFriendInput.value || '').trim();
                if (!name) { alert('ì¶”ê°€í•  ì¹œêµ¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                const id = 'f' + Math.floor(Math.random() * 1e6);
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.dataset.id = id;
                item.dataset.name = name;
                item.dataset.status = 'ì˜¨ë¼ì¸';
                item.innerHTML = `<div class="avatar">${name[0]}</div><div class="name">${name}</div>`;
                friendList.appendChild(item);
                addFriendInput.value = '';
                addFriendModal.classList.remove('open');
            });
        }

        if (addMemberButton) {
            addMemberButton.addEventListener('click', () => {
                addSelectedMembers(currentRoomIdForAdd);
            });
        }

        async function addSelectedMembers(roomId) {
            if (!roomId) return;

            // ì²´í¬ëœ ì‚¬ìš©ì ID(ë˜ëŠ” email) ëª©ë¡ ì¶”ì¶œ
            const selectedUsers = Array.from(memberSearchResultsList.querySelectorAll('.member-checkbox:checked'))
                                         .map(cb => cb.dataset.userId);

            if (selectedUsers.length === 0) {
                alert("ì¶”ê°€í•  ë©¤ë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                // ì„œë²„ì˜ ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
                const response = await fetch(`/api/chat/room/${roomId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(selectedUsers)
                });

                if (response.ok) {
                    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ (STOMP)
                    // ì´ˆëŒ€ëœ ìœ ì €ë“¤ì˜ ì´ë¦„ì„ ì•Œê¸° ìœ„í•´ ì¶”ê°€ ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, ê°„ë‹¨íˆ "ìƒˆë¡œìš´ ë©¤ë²„"ë¡œ í†µì¹­í•˜ê±°ë‚˜
                    // ì²´í¬ë°•ìŠ¤ ì˜†ì˜ ì´ë¦„ì„ ê°€ì ¸ì™€ì„œ ì¡°í•© ê°€ëŠ¥
                    const names = Array.from(memberSearchResultsList.querySelectorAll('.member-checkbox:checked'))
                                    .map(cb => cb.closest('.search-result-item').querySelector('.name').textContent.split('(')[0].trim());

                    const sysMsg = `${names.join(', ')}ë‹˜ì´ ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤.`;

                    // í˜„ì¬ í™œì„±í™”ëœ íƒ­ ID ì°¾ê¸°
                    const tabId = Object.keys(openTabs).find(key => openTabs[key].roomId === roomId);
                    if (tabId) {
                        // sendStompMessage í•¨ìˆ˜ í™œìš© (íƒ€ì…ì€ TALKì´ì§€ë§Œ ë‚´ìš©ì€ ì‹œìŠ¤í…œì )
                        // ë˜ëŠ” ë°±ì—”ë“œì—ì„œ ë©¤ë²„ ì¶”ê°€ ì‹œ ìë™ìœ¼ë¡œ ì†Œì¼“ ë©”ì‹œì§€ë¥¼ ë¿Œë¦¬ëŠ” ê²ƒì´ ê°€ì¥ ì´ìƒì ì„
                        sendStompMessage(tabId, roomId, sysMsg);
                    }
                    alert("ì´ˆëŒ€ ì™„ë£Œ");
                    addMemberModal.classList.remove('open');

                    // í›„ì† ì‘ì—…: ì±„íŒ…ë°© ì •ë³´ ë˜ëŠ” ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    // loadAndRenderRoomsê°€ ì „ì—­ì— ë“±ë¡ë˜ì—ˆë‹¤ê³  ê°€ì •
                    if (window.loadAndRenderRooms) window.loadAndRenderRooms();

                    // í˜„ì¬ ì—´ë¦° íƒ­ì˜ ì°¸ì—¬ì ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨í•´ì•¼ í•©ë‹ˆë‹¤.
                    if (activeTabId && openTabs[activeTabId].roomId === roomId) {
                        const participants = await requestServerLoadParticipants(roomId);
                        chatParticipants[activeTabId] = participants.map(p => ({
                            email: p.email, nickName: p.nickName, userId: p.userId
                        }));
                        renderMemberList(activeTabId, roomId);
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ë©¤ë²„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            }
        }
        async function scrollToUnreadMessages(tabId, roomId) {
            console.log(`[DEBUG] scrollToUnreadMessages ì‹¤í–‰: tabId=${tabId}`);
            const listContainer = document.getElementById(`chat-messages-${tabId}`);
            if (!listContainer) return;

            // 1. ë§ˆì§€ë§‰ ì½ì€ ì‹œê°„(lastReadTime) ê°€ì ¸ì˜¤ê¸°
            // openTabs[tabId]ì— ì„œë²„ì—ì„œ ë°›ì€ lastReadTime (ISO í˜•ì‹ì˜ ë¬¸ìì—´)ì´ ì €ì¥ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
            const tabInfo = openTabs[tabId];
            const lastReadTimeStr = tabInfo ? tabInfo.lastReadTime : null;
            console.log(`[DEBUG] lastReadTimeStr: ${lastReadTimeStr}`);
            // lastReadTime ì •ë³´ê°€ ì—†ìœ¼ë©´ (ì˜ˆ: ë°©ì„ ì²˜ìŒ ì—´ì—ˆê±°ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°), ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤.
            if (!lastReadTimeStr) {
                scrollToBottom(tabId);
                return;
            }

            // Date ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ ì¤€ë¹„
            const lastReadDate = new Date(lastReadTimeStr);

            // 2. ì²« ë²ˆì§¸ ì•ˆ ì½ì€ ë©”ì‹œì§€ ì°¾ê¸°
            const messages = listContainer.querySelectorAll('.chat-message');
            let firstUnreadMessage = null;

            for (const message of messages) {
                const messageTimeStr = message.dataset.createdAt;
                if (!messageTimeStr) continue;

                const messageDate = new Date(messageTimeStr);
                console.log('messageDate:', messageDate);
                console.log('lastReadDate:', lastReadDate);
                // ë©”ì‹œì§€ ìƒì„± ì‹œê°„ì´ ë§ˆì§€ë§‰ ì½ì€ ì‹œê°„ë³´ë‹¤ ì´í›„ì¸ ê²½ìš° (ìƒˆ ë©”ì‹œì§€)
                // 1msë¼ë„ ì´í›„ë¼ë©´ ì•ˆ ì½ì€ ë©”ì‹œì§€ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
                if (messageDate > lastReadDate) {
                    firstUnreadMessage = message;
                    break;
                }
            }

            // 3. ìŠ¤í¬ë¡¤ ì‹¤í–‰
            if (firstUnreadMessage) {
                // ì²« ë²ˆì§¸ ì•ˆ ì½ì€ ë©”ì‹œì§€ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤ (ë¶€ë“œëŸ½ê²Œ)
                // 'start'ë¥¼ ì‚¬ìš©í•˜ë©´ ìš”ì†Œì˜ ìƒë‹¨ì´ ë·°í¬íŠ¸ ìƒë‹¨ì— ë§ì¶°ì§‘ë‹ˆë‹¤.
                firstUnreadMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // ì•ˆ ì½ì€ ë©”ì‹œì§€ ì˜ì—­ì— ì‹œê°ì ì¸ í‘œì‹œ (CSS í•„ìš”)
                // firstUnreadMessage.classList.add('unread-marker');

            } else {
                // ì•ˆ ì½ì€ ë©”ì‹œì§€ê°€ ì—†ë‹¤ë©´, ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                scrollToBottom(tabId);
            }
        }

        // ìš°í´ë¦­ ì´ë²¤íŠ¸
        memberList.addEventListener('contextmenu', (e) => {
            const item = e.target.closest('.friend-item');
            if (!item) return;

            e.preventDefault(); // ê¸°ë³¸ ë¸Œë¼ìš°ì € ë©”ë‰´ ì°¨ë‹¨

            // ë°ì´í„° ì¶”ì¶œ
            const email = item.dataset.id; // email
            // ì‹¤ì œ ê°•í‡´ë¥¼ ìœ„í•´ì„  DBì˜ userIdê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ. renderMemberListì—ì„œ dataset.userId ì¶”ê°€ í•„ìš”.
            // ì—¬ê¸°ì„  emailì„ userIdë¡œ ê°€ì •í•˜ê±°ë‚˜ datasetì—ì„œ ì°¾ìŒ
            targetMemberName = item.dataset.name;
            targetRoomId = currentRoomId;

            // ë³¸ì¸ì€ ê°•í‡´ ë¶ˆê°€ ì²˜ë¦¬
            if (email === myProfile.email) return;

            // ë©”ë‰´ ìœ„ì¹˜ ì„¤ì •
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;

            // íƒ€ê²Ÿ ì €ì¥ (ì—¬ê¸°ì„  emailì„ IDë¡œ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •)
            targetMemberId = email;
        });

        friendList.addEventListener('click', async (e) => {
            // 1. í´ë¦­ëœ ìš”ì†Œê°€ .friend-itemì¸ì§€ í™•ì¸
            const item = e.target.closest('.friend-item');
            if (!item) return;

            // 2. ì¹œêµ¬ ë°ì´í„° ì¶”ì¶œ
            const friendId = item.dataset.id; // email ë˜ëŠ” userId
            const friendName = item.dataset.name;

            // 3. 1:1 ì±„íŒ…ë°© ìš”ì²­ (ê¸°ì¡´ dblclickì˜ í•µì‹¬ ë¡œì§)
            try {
                const reqBody = {
                    myId: myProfile.userId, // ì „ì—­ ë³€ìˆ˜ myProfile ì‚¬ìš© ê°€ì •
                    friendId: friendId,
                    friendName: friendName
                };

                // fetch í˜¸ì¶œ (Personal Room API)
                 const response = await fetch('/api/chat/rooms/personal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reqBody)
                });

                if(response.ok) {
                    const roomDto = await response.json();

                    // 4. íƒ­ ì—´ê¸° (ì´ í•¨ìˆ˜ ë‚´ë¶€ì— lastReadTime ì¡°íšŒ ë° ìŠ¤í¬ë¡¤ ë¡œì§ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.)
                    openTab(`personal_${roomDto.roomId}`, friendName, 'friend', roomDto.roomId);

                    // 1:1 ì±„íŒ…ì€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ ì•Šì•„ë„ ë°”ë¡œ ì—´ë¦¬ë„ë¡ í•¨
                } else {
                    console.error(`1:1 ì±„íŒ…ë°© ìƒì„±/ì¡°íšŒ ì‹¤íŒ¨: Status ${response.status}`);
                }
            } catch(error) {
                console.error("1:1 ì±„íŒ…ë°© ìƒì„± í†µì‹  ì˜¤ë¥˜", error);
            }
        });

        startChatBtn.addEventListener('click', async () => {
            if (!modalFriendData) return;

            try {
                // 1. ì„œë²„ì— 1:1 ì±„íŒ…ë°© ì •ë³´ ìš”ì²­ (ìƒì„± ë˜ëŠ” ì¡°íšŒ)
                // ì£¼ì˜: Controllerì— ë³‘í•©ëœ API ê²½ë¡œê°€ '/api/chat/rooms/personal' ì¸ì§€ í™•ì¸ í•„ìš”
                const response = await fetch('/api/chat/rooms/personal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': ... (ì¿ í‚¤ë‚˜ í—¤ë”ì— í† í° ìë™ í¬í•¨ë¨)
                    },
                    body: JSON.stringify({
                        myId: myProfile.email,       // í˜¹ì€ myProfile.userId (ë°±ì—”ë“œ ë¡œì§ì— ë§ì¶° ì„¤ì •)
                        friendId: modalFriendData.id, // ì¹œêµ¬ì˜ ì´ë©”ì¼ (dataset.id)
                        friendName: modalFriendData.name
                    })
                });

                if (!response.ok) {
                    throw new Error('ì±„íŒ…ë°© ìƒì„±/ì¡°íšŒ ì‹¤íŒ¨');
                }

                // 2. ì„œë²„ë¡œë¶€í„° ì˜¬ë°”ë¥¸ Room ì •ë³´(UUID í¬í•¨) ìˆ˜ì‹ 
                const roomDto = await response.json();
                const realRoomId = roomDto.roomId; // DBì— ì €ì¥ëœ ì§„ì§œ UUID

                console.log("Server Room ID:", realRoomId);

                // 3. ì˜¬ë°”ë¥¸ IDë¡œ íƒ­ ì—´ê¸°
                const tabId = `friend_${modalFriendData.id}`; // íƒ­ IDëŠ” í”„ë¡ íŠ¸ ì‹ë³„ìš©ì´ë¼ ìœ ì§€í•´ë„ ë¬´ë°©
                openTab(tabId, modalFriendData.name, 'friend', realRoomId);

                // 4. ëª¨ë‹¬ ë‹«ê¸° ë° UI ì •ë¦¬
                friendProfileModal.classList.remove('open');
                if (window.innerWidth < 768) friendPanel.classList.remove('open');

            } catch (e) {
                console.error("1:1 ì±„íŒ…ë°© ì—°ê²° ì˜¤ë¥˜:", e);
                alert("ì±„íŒ…ë°©ì„ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        });

        inviteMemberBtn.addEventListener('click', () => {
            // 1. í˜„ì¬ í™œì„±í™”ëœ íƒ­ ID í™•ì¸
            if (!activeTabId) {
                 alert('ë¨¼ì € ê·¸ë£¹ ì±„íŒ…ë°©ì„ ì—´ì–´ì£¼ì„¸ìš”.');
                 return;
            }

            const tabInfo = openTabs[activeTabId];

            // 2. ê·¸ë£¹ ì±„íŒ…ë°©ì¸ì§€ í™•ì¸
            if (tabInfo.type !== 'group') {
                 alert('ê·¸ë£¹ ì±„íŒ…ë°©ì—ì„œë§Œ ë©¤ë²„ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                 return;
            }

            // 3. ë©¤ë²„ ê²€ìƒ‰ ë° ì¶”ê°€ ëª¨ë‹¬ í˜¸ì¶œ
            showAddMemberModal(activeTabId);
        });

        document.querySelectorAll('.modal-close-btn, .btn-cancel').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modal;
                if (modalId) document.getElementById(modalId).classList.remove('open');
            });
        });
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('open'); });
        });

        // --- openTab í•¨ìˆ˜ ---
        async function openTab(tabId, name, type, roomId = null) {
             // 1. ì´ë¯¸ ì—´ë¦° íƒ­ì´ë©´ í™œì„±í™”í•˜ê³  ë¦¬í„´
             if (openTabs[tabId]) {
                // ê³ ì •ëœ ID ëŒ€ì‹  ë™ì  tabId ì‚¬ìš©
                console.log(openTabs[tabId].lastReadTime);
                activateTab(tabId);
                if (roomId) updateLastReadTime(roomId);
                return;
            }

            // íƒ­ ì •ë³´ ì´ˆê¸° ì„¤ì • (lastReadTime í•„ë“œ ì¶”ê°€)
            openTabs[tabId] = { type, name, roomId, lastReadTime: "" };

            let participants = [];
            let lastReadTime = "";

            // 2. ì±„íŒ…ë°©ì¼ ê²½ìš° STOMP êµ¬ë… ë° ë©¤ë²„/LastReadTime ë¡œë”©
            if (type === 'group' || type === 'friend') {
                connectStomp();

                if (roomId) {
                    // requestServerLoadHistory í˜¸ì¶œ ì œê±°
                    const [fetchedParticipants, fetchedLastReadTime] = await Promise.all([
                        requestServerLoadParticipants(roomId).catch(e => { console.error("Participants Load Fail:", e); return []; }),
                        requestServerLoadLastReadTime(roomId).catch(e => { console.error("LastReadTime Load Fail:", e); return ""; })
                    ]);

                    // history ë³€ìˆ˜ ì‚¬ìš© ì œê±°
                    participants = fetchedParticipants;
                    lastReadTime = fetchedLastReadTime;

                    // ë°›ì•„ì˜¨ lastReadTimeì„ ì „ì—­ ìƒíƒœì— ì €ì¥
                    if(openTabs[tabId]) {
                        openTabs[tabId].lastReadTime = lastReadTime;
                    }

                    chatParticipants[tabId] = participants.map(p => ({
                        email: p.email, nickName: p.nickName, userId: p.userId
                    }));

                    subscribeChatRoom(tabId, roomId);

                    // setTimeout ë° scrollToLastReadMessage ë¡œì§ ì œê±°
                    // loadChatMessagesê°€ ë¡œë”© ë° ìŠ¤í¬ë¡¤ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
                }
            }

            createTabButton(tabId, name, true);

            // 1. ì±„íŒ…ë°© ë¼ˆëŒ€ ìƒì„±
            renderChatArea(tabId, name, roomId);

            // 2. íƒ­ í™œì„±í™”
            activateTab(tabId);

            // 3.  ì»¤ì„œ ê¸°ë°˜ ë©”ì‹œì§€ ë¡œë”© ì‹œì‘
            if (type === 'group' || type === 'friend' && roomId) {
                // loadChatMessages(tabId, true) í˜¸ì¶œ (ì´ˆê¸° ë¡œë”©)
                await loadChatMessages(tabId, true);
            }
        }

        function renderMessageHistory(tabId, historyMessages) {
            if (!historyMessages || historyMessages.length === 0) return;

            const listContainerId = `chat-messages-${tabId}`;
            const listContainer = document.getElementById(listContainerId);

            if (!listContainer) return;

            listContainer.innerHTML = '';

            historyMessages.forEach(msg => {
                const messageData = {
                    ...msg,
                    tabId: tabId
                };
                // ë‘ ë²ˆì§¸ ì¸ìë¡œ trueë¥¼ ë„˜ê²¨ì„œ ìŠ¤í¬ë¡¤ ê°•ì œ ì´ë™ ë°©ì§€
                appendChatMessageToDOM(messageData, true);
            });
        }
        async function requestServerLoadLastReadTime(roomId) {
            try {
                const response = await fetch(`/api/chat/rooms/${roomId}/last-read-time`);
                if (response.ok) {
                    return response.text();
                }
                console.error("Last Read Time ì¡°íšŒ ì‹¤íŒ¨. ìƒíƒœ:", response.status);
                return "";
            } catch (e) {
                console.error("Last Read Time ì¡°íšŒ ì¤‘ í†µì‹  ì˜¤ë¥˜:", e);
                return "";
            }
        }

        function scrollToBottom(tabId) {
            const listContainer = document.getElementById(`chat-messages-${tabId}`);
            if (!listContainer) return;
            listContainer.scrollTop = listContainer.scrollHeight;

            // ìŠ¤í¬ë¡¤ ì™„ë£Œ í›„(ì¦‰ì‹œ) ì„œë²„ì— ì½ìŒ ì²˜ë¦¬ ìš”ì²­
            const tabInfo = openTabs[tabId];
            if (tabInfo && tabInfo.roomId) {
                updateLastReadTime(tabInfo.roomId);
            }
        }

        /**
         * ë©”ì‹œì§€ ëª©ë¡ì—ì„œ ë§ˆì§€ë§‰ ì½ì€ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤.
         */
        function scrollToLastReadMessage(tabId, lastReadTime) {
            const listContainerId = `chat-messages-${tabId}`;
            const listContainer = document.getElementById(listContainerId);

            if (!listContainer) return;

            if (!lastReadTime) {
                console.log("LastReadTime ì—†ìŒ -> ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤");
                listContainer.scrollTop = listContainer.scrollHeight;
                return;
            }

            const lastReadDate = parseDateRobust(lastReadTime);
            if (!lastReadDate || isNaN(lastReadDate.getTime())) {
                console.warn("LastReadTime ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨:", lastReadTime);
                listContainer.scrollTop = listContainer.scrollHeight;
                return;
            }

            const messages = listContainer.querySelectorAll('.chat-message');
            let targetElement = null;

            console.log(`[ìŠ¤í¬ë¡¤ ë¡œì§ ì‹œì‘] ì´ ë©”ì‹œì§€: ${messages.length}, ë§ˆì§€ë§‰ ì½ì€ ì‹œê°„: ${lastReadDate.toLocaleString()}`);

            for (let i = 0; i < messages.length; i++) {
                const msgTimeStr = messages[i].getAttribute('data-created-at');
                if (!msgTimeStr) continue;

                const msgDate = parseDateRobust(msgTimeStr);

                // ë‚ ì§œ ë¹„êµ ë¡œê·¸ (í•„ìš”ì‹œ ì£¼ì„ í•´ì œí•˜ì—¬ í™•ì¸)
                // console.log(`ë¹„êµ: ë©”ì‹œì§€(${msgDate.getTime()}) vs ì½ìŒ(${lastReadDate.getTime()})`);

                if (msgDate && msgDate > lastReadDate) {
                    targetElement = messages[i];
                    console.log(`âœ… [íƒ€ê²Ÿ ë°œê²¬] ì•ˆ ì½ì€ ë©”ì‹œì§€ ì‹œì‘: ${msgTimeStr}`);

                    // ì‹œê°ì  ë””ë²„ê¹…: ì°¾ì€ ë©”ì‹œì§€ì— ë¹¨ê°„ í…Œë‘ë¦¬ í‘œì‹œ (í…ŒìŠ¤íŠ¸ í›„ ì‚­ì œ)
                    // targetElement.style.border = "2px solid red";
                    break;
                }
            }

            if (targetElement) {
                // ì•ˆ ì½ì€ ë©”ì‹œì§€ê°€ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ ì´ë™
                targetElement.scrollIntoView({ behavior: 'auto', block: 'center' });
            } else {
                console.log("ğŸš« ì•ˆ ì½ì€ ë©”ì‹œì§€ ì—†ìŒ (ëª¨ë‘ ì½ìŒ) -> ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤");
                listContainer.scrollTop = listContainer.scrollHeight;
            }
        }
        // --- renderChatArea (íŒŒì¼ ë“œë¡­ ì˜ì—­ ë° ì…ë ¥ í•„ë“œ ì¶”ê°€) ---
        function renderChatArea(tabId, name, roomId) {
            const existingContent = document.getElementById(`tab-content-${tabId}`);
            if (existingContent) {
                return;
            }

            // HTML í…œí”Œë¦¿ ìˆ˜ì •: íŒŒì¼ ë“œë¡­ ì˜ì—­, ë¯¸ë¦¬ë³´ê¸°, íŒŒì¼ ìš”ì•½, í…ìŠ¤íŠ¸ ì…ë ¥, ì „ì†¡ ë²„íŠ¼ í¬í•¨
            const chatContent = `

                <ul id="chat-messages-${tabId}" class="chat-messages">
                    </ul>

                <div class="chat-utility-area">
                    <div class="file-drop-area" data-tab-id="${tabId}">
                        <input type="file" class="file-input-hidden" multiple style="display: none;">
                        <p>íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.</p>
                    </div>

                    <div class="file-preview-container">
                        </div>
                    <div class="file-list-summary">
                        </div>
                </div>

                <div class="chat-input-area">
                        <div class="file-toggle-btn-area">
                            <button class="file-toggle-btn">+</button>
                        </div>
                        <div class="chat-input_area">
                            <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="chat-send-btn_area">
                            <button class="chat-send-btn">ì „ì†¡</button>
                        </div>
                </div>
            `;

            const newContent = document.createElement('div');
            newContent.className = 'tab-content';
            newContent.id = `tab-content-${tabId}`;

            if (openTabs[tabId].type !== 'group' && openTabs[tabId].type !== 'friend') {
                 newContent.innerHTML = `<div style="padding:20px;">[${openTabs[tabId].type.toUpperCase()}] ${name} í˜ì´ì§€</div>`;
            } else {
                 newContent.innerHTML = chatContent;
            }

            chatAreaWrapper.appendChild(newContent);
            emptyState.style.display = 'none';

            // FileAreaManager ì´ˆê¸°í™” ë° ì „ì—­ ë“±ë¡
            const contentEl = newContent;
            if (roomId) {
                fileListManagers[tabId] = new FileAreaManager(
                    contentEl,
                    tabId,
                    roomId
                );
            }

            // ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë©”ì‹œì§€ ë° íŒŒì¼ ì „ì†¡ í†µí•©)
            const sendBtn = contentEl.querySelector('.chat-send-btn');
            const inputEl = contentEl.querySelector('.chat-input');
            const fileManager = fileListManagers[tabId];

            if (sendBtn && inputEl) {
                const handleSend = () => {
                    const text = inputEl.value.trim();

                    // 1. íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° (ìº¡ì…˜ì´ ìˆë“  ì—†ë“ )
                    if (fileManager && fileManager.fileList.length > 0) {
                        fileManager.sendFiles(text);
                    }
                    // 2. í…ìŠ¤íŠ¸ë§Œ ì¡´ì¬í•˜ëŠ” ê²½ìš°
                    else if (text) {
                        sendStompMessage(tabId, roomId, text);
                    }

                    inputEl.value = '';
                    // ì „ì†¡ í›„ ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
                    if (fileManager) fileManager.updateSendButtonState();
                };

                sendBtn.addEventListener('click', handleSend);
                inputEl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend();
                    }
                });

                // í…ìŠ¤íŠ¸ ì…ë ¥ ì‹œ ì „ì†¡ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                inputEl.addEventListener('input', () => {
                     if (fileManager) fileManager.updateSendButtonState();
                });
            }
        } // End renderChatArea



        function renderMemberList(tabId, roomId) {
            if (!memberList) return;
            currentRoomId = roomId;
            memberList.innerHTML = '';

            // membersëŠ” í•­ìƒ ë°°ì—´ì´ê±°ë‚˜ ë¹ˆ ë°°ì—´([])ì´ë¯€ë¡œ ì•ˆì „í•©ë‹ˆë‹¤.
            const members = chatParticipants[tabId] || [];
            if (members.length === 0) {
                memberList.innerHTML = '<div class="empty-member">ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // myProfileì—ì„œ ë¡œê·¸ì¸ ì‚¬ìš©ì ë³¸ì¸ì˜ emailì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const myEmail = myProfile ? myProfile.email : null; // myId ëŒ€ì‹  myEmail ì‚¬ìš©

            members.forEach(m => {
                console.log("m!!!!!!!!", m);

                // 1. í‘œì‹œí•  ì´ë¦„ ê²°ì •: nickNameì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ email ì‚¬ìš©
                const displayName = m.nickName || m.email;

                // 2. ì•„ë°”íƒ€ì— í‘œì‹œí•  ê¸€ì ê²°ì • (displayNameì˜ ì²« ê¸€ì)
                const avatarChar = displayName ? displayName[0] : '?';

                // 3. ì°¸ì—¬ì ëª©ë¡ ì•„ì´í…œ ìƒì„± ë° ë°ì´í„° ì„¤ì •
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.dataset.id = m.email; // ë°ì´í„° idëŠ” email ì‚¬ìš©
                item.dataset.name = displayName; // ë°ì´í„° nameì€ í‘œì‹œ ì´ë¦„ ì‚¬ìš©

                // 4. ì—­í•  í…ìŠ¤íŠ¸ ê²°ì •
                let roleText = 'ì°¸ì—¬ì';

                // m.emailê³¼ myEmailì„ ë¹„êµí•˜ì—¬ ë³¸ì¸ì¸ì§€ í™•ì¸
                if (myEmail && m.email === myEmail) {
                    roleText = 'ë‚˜'; // ë¡œê·¸ì¸ ì‚¬ìš©ì ë³¸ì¸ì¸ ê²½ìš°
                }

                // 5. HTML êµ¬ì¡° ìƒì„±
                item.innerHTML = `
                     <div class="avatar">${avatarChar}</div>
                        <div class="member-text">
                            <div class="member-name">${displayName}</div>
                            <div class="member-role">${roleText}</div>
                    </div>
                `;

                memberList.appendChild(item);
            });
        }

        // =======================================================================
        // ë©”ì‹œì§€ ë¡œë”© ë° ë Œë”ë§ í•¨ìˆ˜ (loadChatMessages)
        // =======================================================================
        async function loadChatMessages(tabId, isInitialLoad = true) {
            console.log(`[DEBUG] loadChatMessages í˜¸ì¶œë¨. tabId: ${tabId}, isInitialLoad: ${isInitialLoad}`);
            const tabInfo = openTabs[tabId];
            if (!tabInfo) {
                console.error(`[DEBUG] tabInfoê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: ${tabId}`);
                return;
            }

            const roomId = tabInfo.roomId;
            let state = chatPaginationStates[tabId];

            // ìƒíƒœê°€ ì—†ê±°ë‚˜ ì´ˆê¸° ë¡œë”©ì¼ ê²½ìš° ì´ˆê¸°í™”
            if (!state || isInitialLoad) {
                state = {
                    nextCursor: null, // ì´ˆê¸° ë¡œë”© ì‹œ ì»¤ì„œëŠ” null
                    hasMore: true,
                    isLoading: false,
                    observer: null
                };
                chatPaginationStates[tabId] = state;
            }

            // ì¤‘ë³µ ë¡œë”© ë°©ì§€
            if (state.isLoading || (!state.hasMore && !isInitialLoad)) {
                console.log(`[Chat] ${tabId}: ì´ë¯¸ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë” ì´ìƒ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. (hasMore: ${state.hasMore})`);
                return;
            }

            state.isLoading = true;

            // UI ë¡œë”© í‘œì‹œ (ìƒë‹¨ ìƒëµ ì˜ì—­ì—)
            if (!isInitialLoad) {
                togglePlaceholderLoading(tabId, true);
            }

            const lastReadTime = tabInfo.lastReadTime; // openTabì—ì„œ ì¡°íšŒëœ lastReadTime ì‚¬ìš©
            // ì´ˆê¸° ë¡œë”© ì‹œ limitì€ ë°±ì—”ë“œì—ì„œ 20ê°œë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ, ìƒë‹¨ ìŠ¤í¬ë¡¤ ì‹œì—ë§Œ 50ì„ ëª…ì‹œ
            const limit = isInitialLoad ? 20 : 50;

            const apiUrl = `/api/chat/rooms/${roomId}/messages/history?limit=${limit}` +
                   (state.nextCursor ? `&cursor=${encodeURIComponent(state.nextCursor)}` : '') +
                   (isInitialLoad && lastReadTime ? `&lastReadTime=${encodeURIComponent(lastReadTime)}` : '');

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Failed to load chat history: ' + response.statusText);
                }
                const data = await response.json(); // ChatHistoryResponse DTO

                //ë””ë²„ê·¸ìš© ì½”ë“œ
                console.log(`[DEBUG] API URL: ${apiUrl}`);
                console.log(`[DEBUG] Received Messages: ${data.messages ? data.messages.length : 0}, HasMore: ${data.hasMore}`);

                const listContainer = document.getElementById(`chat-messages-${tabId}`);

                if (!listContainer) {
                    console.warn(`[WARN] ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ID: chat-messages-${tabId}). 50ms í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.`);
                    // 50ms í›„ ë‹¤ì‹œ ì‹œë„
                    setTimeout(() => {
                        // ì¬ì‹œë„ ì‹œ isInitialLoad ê°’ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì—¬ ë¡œë”© ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
                        loadChatMessages(tabId, isInitialLoad);
                    }, 50);

                    // í˜„ì¬ ì‹¤í–‰ì„ ì—¬ê¸°ì„œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
                    return;
                }

                // ë””ë²„ê¹…ì„ ìœ„í•´ ìˆ˜ì‹ ëœ ë©”ì‹œì§€ ê°œìˆ˜ ë¡œê·¸ ì¶”ê°€
                console.log(`[Chat: ${tabId}] ë©”ì‹œì§€ ë¡œë”© ì™„ë£Œ. ë©”ì‹œì§€ ê°œìˆ˜: ${data.messages ? data.messages.length : 0}. hasMore: ${data.hasMore}`);


                // 1. ê¸°ì¡´ ìƒë‹¨ Placeholder ì œê±° (ìˆë‹¤ë©´)
                const existingPlaceholder = listContainer.querySelector('.chat-placeholder-top');
                if (existingPlaceholder) {
                    existingPlaceholder.remove();
                }

                // 2. ë©”ì‹œì§€ ë Œë”ë§
                if (data.messages && data.messages.length > 0) {
                    let fragment = document.createDocumentFragment();

                    data.messages.forEach(message => {
                        const messageHtml = createChatMessageHTML(message);
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = messageHtml;

                        if (tempDiv.firstElementChild) {
                            fragment.appendChild(tempDiv.firstElementChild);
                        }
                    });

                    // ì´ˆê¸° ë¡œë”©ì€ append, ì¶”ê°€ ë¡œë”©ì€ prepend
                    if (isInitialLoad) {
                        listContainer.innerHTML = '';
                        listContainer.appendChild(fragment);

                        const firstUnreadId = data.firstUnreadMessageId;

                        if (firstUnreadId) {
                            // 1. ì•ˆ ì½ì€ ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ ê·¸ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
                            scrollToMessageId(tabId, firstUnreadId);
                        } else {
                            // ì•ˆ ì½ì€ ë©”ì‹œì§€ê°€ ì—†ë‹¤ë©´ (ëª¨ë‘ ì½ì—ˆë‹¤ë©´) ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                            scrollToBottom(tabId);
                        }
                    } else { // ì¶”ê°€ ë¡œë”© (ìƒë‹¨ ìŠ¤í¬ë¡¤)
                        // ì¶”ê°€ ë¡œë”© ì‹œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³´ì¡´ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                        const oldScrollHeight = listContainer.scrollHeight;
                        const oldScrollTop = listContainer.scrollTop;

                        // ê¸°ì¡´ ë©”ì‹œì§€ ëª©ë¡ì˜ ë§¨ ì•ì— ì¶”ê°€
                        listContainer.prepend(fragment);

                        const newScrollHeight = listContainer.scrollHeight;
                        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ìƒˆë¡œ ì¶”ê°€ëœ ë†’ì´ë§Œí¼ ì´ë™í•˜ì—¬ ë·°í¬íŠ¸ ìœ„ì¹˜ ìœ ì§€
                        listContainer.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
                    }

                    // GLightbox ì¬ì´ˆê¸°í™”
                    // ê¸°ì¡´ì˜ initializeChatLightbox()ë¥¼ ìš°ë¦¬ê°€ ë…¼ì˜í•œ reinitializeLightbox()ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
                    reinitializeLightbox(); // â­â­ ìˆ˜ì •ëœ ë¶€ë¶„ (ì´ì „ì— initializeChatLightbox()ì˜€ìŒ) â­â­

                } else {
                    // ì´ˆê¸° ë¡œë”© ì‹œ ë©”ì‹œì§€ê°€ ì—†ì„ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
                    if (isInitialLoad && listContainer.childElementCount === 0) {
                         listContainer.innerHTML = '<li class="system-message">ì´ ì±„íŒ…ë°©ì—ëŠ” ì•„ì§ ë©”ì‹œì§€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    }
                }
                // 3. ìƒíƒœ ê°±ì‹ 
                state.nextCursor = data.nextCursor;
                state.hasMore = data.hasMore;
                chatPaginationStates[tabId] = state;

                // 4. ìƒˆë¡œìš´ Placeholder ìƒì„± ë° Intersection Observer ì¬ì„¤ì •
                if (state.hasMore) {
                    // ê°€ì¥ ìƒë‹¨ì— ìƒˆë¡œìš´ Placeholder ì‚½ì…
                    listContainer.insertAdjacentHTML('afterbegin', createPlaceholderHtml());
                    // Observer ì¬ì„¤ì •
                    initializeIntersectionObserver(tabId);
                } else {
                     // ë” ì´ìƒ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ Placeholder ëŒ€ì‹  ì •ë³´ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ìˆ˜ ìˆìŒ (ì„ íƒ ì‚¬í•­)
                     if (!isInitialLoad && listContainer.childElementCount > 0) {
                         listContainer.insertAdjacentHTML('afterbegin', '<li class="system-message">ë” ì´ìƒ ê³¼ê±° ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>');
                     }
                }
                updateLastReadTime(roomId);
                if (isInitialLoad) {
                    attachScrollReadListener(tabId);
                }
            } catch (error) {
                console.error(`[Chat] ë©”ì‹œì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${roomId}`, error);
                alert('ì±„íŒ… ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            } finally {
                state.isLoading = false;
                // UI ë¡œë”© ìƒíƒœ í•´ì œ
                if (!isInitialLoad) {
                    togglePlaceholderLoading(tabId, false);
                }
            }
        }

        // =======================================================================
        // Intersection Observer ì„¤ì •
        // =======================================================================
        function initializeIntersectionObserver(tabId) {
            const state = chatPaginationStates[tabId];
            if (!state) return;

            // ê¸°ì¡´ ì˜µì €ë²„ê°€ ìˆë‹¤ë©´ ì—°ê²° í•´ì œ
            if (state.observer) {
                state.observer.disconnect();
            }

            const listContainer = document.getElementById(`chat-messages-${tabId}`);
            if (!listContainer) return;

            // ê°ì§€í•  ëŒ€ìƒ: .chat-placeholder-top
            const placeholder = listContainer.querySelector('.chat-placeholder-top');

            if (placeholder) {
                const observerOptions = {
                    root: listContainer, // ìŠ¤í¬ë¡¤ ìš”ì†Œ (ì±„íŒ… ëª©ë¡ ì»¨í…Œì´ë„ˆ)
                    rootMargin: '0px',
                    threshold: 0.1 // placeholderê°€ 10% ì´ìƒ ë³´ì¼ ë•Œ
                };

                const observer = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        // Placeholderê°€ ë·°í¬íŠ¸ì— ì§„ì…í–ˆê³ , í˜„ì¬ ë¡œë”© ì¤‘ì´ ì•„ë‹ˆë©°, ë” ë¡œë“œí•  ë©”ì‹œì§€ê°€ ìˆì„ ë•Œ
                        if (entry.isIntersecting && !state.isLoading && state.hasMore) {
                            console.log(`[Observer] Placeholder ê°ì§€ë¨. ${tabId}ì˜ ê³¼ê±° ë©”ì‹œì§€ ë¡œë”© ì‹œì‘.`);
                            // ë¡œë”© í•¨ìˆ˜ í˜¸ì¶œ (isInitialLoad = false)
                            loadChatMessages(tabId, false);

                            // ë¡œë”© ìš”ì²­ì„ í–ˆìœ¼ë¯€ë¡œ, ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ë¥¼ ìœ„í•´ ì„ì‹œë¡œ ê´€ì°° ì¤‘ì§€
                            observer.unobserve(entry.target);
                        }
                    });
                }, observerOptions);

                observer.observe(placeholder);
                state.observer = observer; // ìƒíƒœì— ì˜µì €ë²„ ì €ì¥
            }
        }

        // =======================================================================
        // [ì¶”ê°€] ë·°í¬íŠ¸ í•˜ë‹¨ ë©”ì‹œì§€ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì¶œ í•¨ìˆ˜
        // =======================================================================
        function getVisibleBottomMessageTimestamp(listContainer) {
            const messages = listContainer.querySelectorAll('.chat-message:not(.system)');
            if (messages.length === 0) return null;

            const containerRect = listContainer.getBoundingClientRect();

            for (let i = messages.length - 1; i >= 0; i--) {
                const message = messages[i];
                const messageRect = message.getBoundingClientRect();

                // ë©”ì‹œì§€ê°€ ì»¨í…Œì´ë„ˆ ë·°í¬íŠ¸ ë‚´ì— ì¼ë¶€ë¶„ì´ë¼ë„ ë³´ì´ëŠ”ì§€ í™•ì¸
                if (messageRect.top < containerRect.bottom && messageRect.bottom > containerRect.top) {
                    return message.getAttribute('data-created-at');
                }
            }

            return null;
        }


        // =======================================================================
        // [ì¶”ê°€] ìŠ¤í¬ë¡¤ ê°ì§€ ë° lastReadTime ê°±ì‹  ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜
        // =======================================================================
        function attachScrollReadListener(tabId) {
            const listContainer = document.getElementById(`chat-messages-${tabId}`);
            if (!listContainer) return;

            let readUpdatePending = false;
            const roomId = openTabs[tabId] ? openTabs[tabId].roomId : null;

            if (!roomId) return;

            listContainer.onscroll = function() {
                const tabInfo = openTabs[tabId];
                if (!tabInfo || readUpdatePending) return;

                const visibleBottomTimestamp = getVisibleBottomMessageTimestamp(listContainer);
                if (!visibleBottomTimestamp) return;

                const currentLastReadTime = tabInfo.lastReadTime || '0';

                // í˜„ì¬ ë³´ì´ëŠ” ë©”ì‹œì§€ì˜ ì‹œê°„ì´ ê¸°ì¡´ lastReadTimeë³´ë‹¤ ìµœì‹ ì¸ì§€ ë¹„êµ
                const isNewerThanLastRead = visibleBottomTimestamp > currentLastReadTime;

                if (isNewerThanLastRead) {
                    readUpdatePending = true;
                    console.log(`[ReadEvent] ìƒˆë¡œìš´ ì½ìŒ ì§€ì  ê°ì§€ (${visibleBottomTimestamp}). lastReadTime ê°±ì‹  ì‹œì‘.`);

                    // í´ë¼ì´ì–¸íŠ¸ openTabs ë°ì´í„° ì¦‰ì‹œ ê°±ì‹  (ìŠ¤í¬ë¡¤ ì í”„ ë°©ì§€ íš¨ê³¼)
                    tabInfo.lastReadTime = visibleBottomTimestamp;
                    tabInfo.unreadCount = 0;

                    // ì„œë²„ API í˜¸ì¶œ (DB lastReadTime ê°±ì‹ )
                    updateLastReadTime(roomId);

                    // 5ì´ˆ í›„ì— í”Œë˜ê·¸ ì´ˆê¸°í™”
                    setTimeout(() => {
                        readUpdatePending = false;
                    }, 5000);
                }
            };
        }

        // Placeholder í´ë¦­ ì‹œ í˜¸ì¶œ (Intersection Observerê°€ ì‹¤íŒ¨í•  ê²½ìš° ëŒ€ë¹„)
        function loadMoreMessages(tabId) {
            // isInitialLoadë¥¼ falseë¡œ í˜¸ì¶œí•˜ì—¬ ìƒë‹¨ ìŠ¤í¬ë¡¤ ë¡œì§ì„ ë”°ë¦…ë‹ˆë‹¤.
            loadChatMessages(tabId, false);
        }
        // --- activateTab í•¨ìˆ˜ (renderChatArea ëŒ€ì‹  íˆìŠ¤í† ë¦¬/ë©¤ë²„ ëª©ë¡ë§Œ ê°±ì‹ ) ---
        function activateTab(tabId) {
            activeTabId = tabId;
            const tabInfo = openTabs[tabId];
            currentRoomId = tabInfo ? tabInfo.roomId : null;

            tabBar.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            chatAreaWrapper.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const activeTabEl = tabBar.querySelector(`.tab[data-tab-id="${tabId}"]`);
            const activeContentEl = document.getElementById(`tab-content-${tabId}`);

            if (activeTabEl && activeContentEl) {
                activeTabEl.classList.add('active');
                activeContentEl.classList.add('active');

                // 1. ë©¤ë²„ ëª©ë¡ë§Œ ê°±ì‹  (ë©”ì‹œì§€ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
                renderMemberList(tabId, currentRoomId);

                // 2. íŒŒì¼ ë§¤ë‹ˆì € ìƒíƒœ ì—…ë°ì´íŠ¸
                if (fileListManagers[tabId]) {
                    fileListManagers[tabId].updateSendButtonState();
                }
                activeTabEl.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        function closeTab(tabId) {
            if (subscriptions[tabId]) {
                subscriptions[tabId].unsubscribe();
                delete subscriptions[tabId];
                console.log(`STOMP Unsubscribed from: ${tabId}`);
            }

            const tabEl = tabBar.querySelector(`.tab[data-tab-id="${tabId}"]`);
            const contentEl = document.getElementById(`tab-content-${tabId}`);
            if (tabEl) tabEl.remove();
            if (contentEl) contentEl.remove();
            delete openTabs[tabId];

            if (activeTabId === tabId) {
                const ids = Object.keys(openTabs);
                if (ids.length) {
                    activateTab(ids[ids.length - 1]);
                }
                else {
                    activeTabId = null;
                    currentRoomId = null;
                    memberList.innerHTML = '<div class="empty-member">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ë©´ ì°¸ì—¬ìê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
                    emptyState.style.display = 'flex';
                }
            }
            // íŒŒì¼ ë§¤ë‹ˆì € ì œê±°
            if (fileListManagers[tabId]) {
                delete fileListManagers[tabId];
            }
        }

        tabBar.addEventListener('wheel', (e) => {
            if (e.deltaY !== 0) {
                e.preventDefault();
                tabBar.scrollLeft += e.deltaY;
            }
        });

        // 5. ì„œë²„ì— í˜„ì¬ ì‹œê°ìœ¼ë¡œ lastReadTimeì„ ì—…ë°ì´íŠ¸í•˜ê³ , UIë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
        function updateLastReadTime(roomId) {
            if (!roomId) {
                console.warn("updateLastReadTime: roomIdê°€ ìœ íš¨í•˜ì§€ ì•Šì•„ ê°±ì‹ ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
                return;
            }

            // â­â­ FIX: í˜„ì¬ ì‹œê°ì„ ìƒì„± â­â­
            const now = new Date().toISOString();
            const tabId = findTabIdByRoomId(roomId);

            const jwtToken = getCookie('access-token');

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': jwtToken ? `Bearer ${jwtToken}` : ''
            };

            fetch(`/api/chat/rooms/${roomId}/update-read-time`, {
                method: 'POST',
                headers: headers
            })
            .then(response => {
                if (!response.ok) {
                    console.error(`Last Read Time ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status})`);
                } else {
                    console.log(`[ReadTime] Room ${roomId}ì˜ lastReadTime ê°±ì‹  ì„±ê³µ.`);

                    // â­â­â­ FIX: API ì„±ê³µ ì‹œ í´ë¼ì´ì–¸íŠ¸ì˜ openTabs ë°ì´í„° ì¦‰ì‹œ ê°±ì‹  â­â­â­
                    if (tabId && openTabs[tabId]) {
                        openTabs[tabId].unreadCount = 0;
                        // ê°€ì¥ ì¤‘ìš”! openTabsì˜ lastReadTimeì„ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê°±ì‹ 
                        openTabs[tabId].lastReadTime = now;
                        console.log(`[ReadTime] openTabs[${tabId}].lastReadTimeì„ ${now}ë¡œ ê°±ì‹ í–ˆìŠµë‹ˆë‹¤.`);
                    }
                    // â­â­â­ ----------------------------------------------------------------- â­â­â­

                    // 1. ì¢Œì¸¡ ë°© ëª©ë¡ì˜ ì•ˆ ì½ì€ ë°°ì§€ ì œê±°/ìˆ¨ê¹€
                    const unreadBadge = document.querySelector(`#room-${roomId} .unread-badge`);
                    if (unreadBadge) {
                        unreadBadge.textContent = '0';
                        unreadBadge.style.display = 'none';
                    }

                    // 3. í•„ìš”í•˜ë‹¤ë©´ ì „ì²´ ë°© ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ ë° ë Œë”ë§ (ì„ íƒì )
                    if (window.loadAndRenderRooms) {
                         window.loadAndRenderRooms();
                    }
                }
            })
            .catch(error => {
                console.error("Last Read Time ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            });
        }

        // ==========================================================

        /**
         * roomIdë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ openTabs ê°ì²´ì—ì„œ í•´ë‹¹í•˜ëŠ” tabIdë¥¼ ì°¾ìŠµë‹ˆë‹¤.
         * (ì´ í•¨ìˆ˜ëŠ” updateLastReadTime ìƒìœ„ì— ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.)
         */
        function findTabIdByRoomId(roomId) {
            for (const tabId in openTabs) {
                // openTabsì˜ êµ¬ì¡°ì— ë”°ë¼ roomId í•„ë“œë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
                if (openTabs[tabId].roomId === roomId) {
                    return tabId;
                }
            }
            return null;
        }
        function isChatScrolledToBottom(tabId) {
            const listContainer = document.getElementById(`chat-messages-${tabId}`);
            if (!listContainer) {
                console.error(`[ERROR] ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID: chat-messages-${tabId}`);

                setTimeout(() => {
                    // ì¬ì‹œë„ ì‹œ isInitialLoadëŠ” falseë¡œ ì„¤ì •í•˜ì—¬ ìƒíƒœ ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
                    loadChatMessages(tabId, isInitialLoad);
                }, 50);

                return;
            }

            // scrollHeight (ì „ì²´ ë‚´ìš© ë†’ì´) - scrollTop (í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜) <= clientHeight (í™”ë©´ì— ë³´ì´ëŠ” ë†’ì´) + ì˜¤ì°¨(10)
            // ì¦‰, ë‚¨ì€ ìŠ¤í¬ë¡¤ ì˜ì—­ì´ í™”ë©´ ë†’ì´ì™€ ê±°ì˜ ê°™ìœ¼ë©´ ë§¨ ì•„ë˜ë¡œ ê°„ì£¼
            const tolerance = 10; // ìŠ¤í¬ë¡¤ ì˜¤ì°¨ í—ˆìš© ë²”ìœ„ (í”½ì…€)
            const scrolledDistance = listContainer.scrollHeight - listContainer.scrollTop;

            return scrolledDistance <= (listContainer.clientHeight + tolerance);
        }
        function initMyProfile() {
            // Thymeleaf ë³€ìˆ˜ë‚˜ APIë¡œ ë°›ì•„ì˜¨ ê°’ ì ìš©
            const initial = myProfile.nickName ? myProfile.nickName[0] : '?';

            pImg.textContent = initial;
            // ì‹¤ì œ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´: pImg.style.backgroundImage = `url(${myProfile.profileImageUrl})`; pImg.textContent = '';

            pName.textContent = myProfile.nickName;
            // pMessage.textContent = myProfile.bio || "ìƒíƒœ ë©”ì‹œì§€ ì—†ìŒ"; // UserProfileì— bioê°€ ìˆë‹¤ë©´

            updateOnlineStatusUI();
        }

        function updateOnlineStatusUI() {
            if (myOnlineStatus) {
                pDot.classList.remove('offline');
                pDot.classList.add('online');
                pStateText.textContent = 'ì˜¨ë¼ì¸';
            } else {
                pDot.classList.remove('online');
                pDot.classList.add('offline');
                pStateText.textContent = 'ì˜¤í”„ë¼ì¸';
            }
        }

        // ìƒíƒœ ì  í´ë¦­ ì‹œ í† ê¸€
        if (pDot) {
            pDot.addEventListener('click', () => {
                myOnlineStatus = !myOnlineStatus;
                updateOnlineStatusUI();
                // í•„ìš”í•˜ë‹¤ë©´ ì„œë²„ì— ìƒíƒœ ë³€ê²½ API í˜¸ì¶œ
            });
        }

        initMyProfile();

        /**
         * WebSocket ë©”ì‹œì§€ DTOë¥¼ ë°›ì•„ HTML ìš”ì†Œë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
         * ì„œë²„ DTO í•„ë“œ ì‚¬ìš©: senderName, senderInitial, fileUrl, metadata, messageType, text
         */
        function createChatMessageHTML(message) {
            const currentMyEmail = myProfile.email || null;
            const senderEmail = message.sender ||    null;
            console.log("[ë””ë²„ê·¸]message", message);
            // 1. message.typeì´ 'mine' ë˜ëŠ” 'other'ë¡œ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ê·¸ ê°’ì„ isMineì— ë°˜ì˜í•©ë‹ˆë‹¤.
            const isTypeSet = message.type === 'mine' || message.type === 'other';

            let isMine;
            if (isTypeSet) {
                // ë‚™ê´€ì  ë Œë”ë§ ì‹œ (message.type = 'mine') ì´ ë¡œì§ì„ ë”°ë¦…ë‹ˆë‹¤.
                isMine = message.type === 'mine';
            } else {
                isMine = senderEmail && currentMyEmail && senderEmail === currentMyEmail;
            }

            // isSystem íŒë³„ ë¡œì§ì€ DTOì˜ type í•„ë“œë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
            // ì´ message.typeì€ 'ENTER', 'QUIT', 'TALK', 'IMAGE' ë“±ì„ ë‹´ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
            let contentMessageType = message.messageType;
            if (!contentMessageType && message.type !== 'mine' && message.type !== 'other') {
                contentMessageType = message.type;
            }
            const isSystem = contentMessageType === 'ENTER' || contentMessageType === 'QUIT';
            const rawSenderName = message.senderName || message.sender || 'Unknown';

            // DTOì—ì„œ ê°’ì´ null/ë¹ˆ ë¬¸ìì—´ë¡œ ì˜¤ë”ë¼ë„ '?'ë¡œ í‘œì‹œë˜ë„ë¡ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            const displayName = rawSenderName && rawSenderName.trim() !== '' ? rawSenderName : '?';

            // ì´ˆì„±ì´ ì—†ì„ ê²½ìš°, rawSenderName(ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼)ì„ ì‚¬ìš©í•˜ì—¬ ê³„ì‚°í•˜ê±°ë‚˜, ì²« ê¸€ìë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const displayInitial = displayName !== '?' ? getKoreanInitials(displayName) : '?';

            // ì•„ë°”íƒ€ í‘œì‹œ ì¡°ê±´: ë‚´ ë©”ì‹œì§€ê°€ ì•„ë‹ˆê³ , ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì•„ë‹ ë•Œ (isMineì´ ì´ì œ ì •í™•í•˜ë¯€ë¡œ ì´ ë¡œì§ì€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤)
            const showAvatar = !isMine && !isSystem;

            // 1. ë©”ì‹œì§€ ë‚´ìš© (content) ê²°ì •
            let contentHTML = '';

            const messageContent = message.message || message.text || '';

            if (isSystem) {
                // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë‚´ìš©ì— í†µí•©ëœ í•„ë“œ ì‚¬ìš©
                contentHTML = `<p class="system-message">${messageContent}</p>`;
            } else {
                // ìœ ë‹ˆí¬ ID ìƒì„± (ë²„íŠ¼ ì œì–´ìš©)
                const btnId = `dl-btn-${message.time.replace(/:/g,'')}-${Math.floor(Math.random()*1000)}`;

                // (A) IMAGE íƒ€ì…
                if (contentMessageType === 'IMAGE' && message.fileUrl) {
                    contentHTML = `
                        <div class="image-bubble">
                            <a href="${message.fileUrl}" class="glightbox" data-gallery="chat-photos">
                                <img src="${message.fileUrl}"
                                     class="image-preview"
                                     height="200"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'><text y=\\'0.9em\\' font-size=\\'80\\'>ğŸ–¼ï¸</text></svg>';"
                                >
                            </a>

                            <button id="${btnId}" class="btn-download-action"
                                    onclick="downloadWithProgress('${message.fileUrl}', '', '${btnId}')">
                                ${iconDownload}
                                ${progressRingHTML}
                            </button>
                        </div>
                        ${messageContent ? `<p class="caption">${messageContent}</p>` : ''}
                    `;
                }
                // (B) FILE íƒ€ì…
                else if (contentMessageType === 'FILE' && message.fileUrl) {
                    let fileName = 'ì•Œ ìˆ˜ ì—†ëŠ” íŒŒì¼';
                    let fileSize = '';

                    if (message.metadata) {
                         try {
                             const meta = typeof message.metadata === 'string' ? JSON.parse(message.metadata) : message.metadata;
                             fileName = meta.fileName || fileName;
                             if(meta.fileSize) fileSize = formatBytes(meta.fileSize);
                         } catch (e) {}
                    }

                    //   ì¸ë¼ì¸ onclick í•¨ìˆ˜ì— ì‚¬ìš©ë  íŒŒì¼ ì´ë¦„ì„ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                    const safeFileName = fileName.replace(/'/g, "\\'").replace(/"/g, '\\"');

                    contentHTML = `
                        <div class="media-bubble">
                            <div class="file-icon-box">ğŸ“„</div>
                            <div class="file-info-wrapper">
                                <span class="file-name">${fileName}</span>
                                <span class="file-size">${fileSize}</span>
                            </div>
                            <button id="${btnId}" class="btn-download-action" title="ë‹¤ìš´ë¡œë“œ"
                                    onclick="downloadWithProgress('${message.fileUrl}', '${safeFileName}', '${btnId}')">
                                ${iconDownload}
                                ${progressRingHTML}
                            </button>
                        </div>
                         ${messageContent ? `<p class="caption">${messageContent}</p>` : ''}
                    `;
                }
                // (C) TALK íƒ€ì…
                else {
                    // [ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€]
                    if (contentMessageType === 'IMAGE' || contentMessageType === 'FILE') {
                        console.error("âš ï¸ ë¯¸ë””ì–´ ë Œë”ë§ ì‹¤íŒ¨ (URL ëˆ„ë½ë¨):", message);
                    }

                    // ë©”ì‹œì§€ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ê³µë°± ì²˜ë¦¬ ë°©ì§€ (ì„ íƒ ì‚¬í•­)
                    const displayContent = messageContent ? messageContent : (isSystem ? '' : '&nbsp;');
                    contentHTML = `<div class="bubble">${displayContent}</div>`;
                }
            }

            // 2. ìµœì¢… ë©”ì‹œì§€ êµ¬ì¡°
            return `
                <li class="chat-message ${isMine ? 'mine' : 'other'} ${isSystem ? 'system' : ''}"
                    data-created-at="${message.createdAt}"
                >

                    ${showAvatar ? `<div class="avatar">${displayInitial}</div>` : ''}

                    <div class="message-body">

                        ${showAvatar ? `<div class="sender-name">${displayName}</div>` : ''}

                        <div class="content-box">
                            ${contentHTML}
                            <div class="message-time">${message.time}</div>
                        </div>

                    </div>
                </li>
            `;
        }

        function scrollToBottom(tabId) {
            // 1. ì±„íŒ… ëª©ë¡ ì»¨í…Œì´ë„ˆ(ul) ì°¾ê¸°
            const listContainer = document.getElementById(`chat-messages-${tabId}`);
            if (!listContainer) return;

            // 2. [í•µì‹¬ ìˆ˜ì •] ìŠ¤í¬ë¡¤ë°”ë¥¼ ê°•ì œë¡œ ë§¨ ì•„ë˜ë¡œ ë‚´ë¦¼
            // scrollIntoViewê°€ ì•„ë‹ˆë¼ scrollTop ì†ì„±ì„ ì¡°ì‘í•´ì•¼ ì •í™•í•˜ê²Œ ë‚´ë¶€ ë‚´ìš©ì´ ìŠ¤í¬ë¡¤ë©ë‹ˆë‹¤.
            listContainer.scrollTop = listContainer.scrollHeight;

            // 3. ìŠ¤í¬ë¡¤ ì™„ë£Œ í›„(ì¦‰ì‹œ) ì„œë²„ì— ì½ìŒ ì²˜ë¦¬ ìš”ì²­
            const tabInfo = openTabs[tabId];
            if (tabInfo && tabInfo.roomId) {
                updateLastReadTime(tabInfo.roomId);
            }
        }

        // STOMP ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        function sendStompMessage(tabId, roomId, text) {
            if (!stompClient || !stompClient.connected) {
                console.error('STOMP connection is not established.');
                alert('ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const tabInfo = openTabs[tabId];
            // tabInfoê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë°©ì–´ ì½”ë“œ
            if (!tabInfo) {
                console.error(`Tab Info not found for tabId: ${tabId}`);
                return;
            }

            const roomChatType = tabInfo.type.toUpperCase();

            const chatMessage = {
                chatType: roomChatType,
                roomId: roomId,
                sender: myProfile.email,

                // ğŸ’¡ [ìˆ˜ì • í¬ì¸íŠ¸] í…ìŠ¤íŠ¸ ë©”ì‹œì§€ì´ë¯€ë¡œ íŒŒì¼ ê´€ë ¨ í•„ë“œëŠ” nullë¡œ ì„¤ì •
                fileUrl: null,
                message: text,
                metadata: null,

                type: 'TALK',
                senderName: myProfile.nickName,
                senderInitial: myProfile.initial
            };

            const jwtToken = getCookie('access-token');
            const headers = { 'Authorization': 'Bearer ' + jwtToken };

            console.log("ğŸš€ í´ë¼ì´ì–¸íŠ¸ ì „ì†¡ ì‹œë„(TALK):", chatMessage);

            stompClient.send(`/pub/chat/message`, headers, JSON.stringify(chatMessage));

            // ë‚™ê´€ì  ë Œë”ë§ (ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ì¦‰ì‹œ í‘œì‹œ)
            const localMessage = {
                ...chatMessage,
                createdAt: new Date().toISOString(),
                message: text,
                // ë Œë”ë§ ì‹œ í•„ìš”í•œ íƒ€ì… ì •ë³´ ë³´ê°•
                messageType: 'TALK'
            };

            displayReceivedMessage(tabId, localMessage, true);
        }

        // --- displayReceivedMessage ---
        function displayReceivedMessage(tabId, message, isMine = false) {
            const list = document.getElementById(`chat-messages-${tabId}`);

            let type = isMine ? 'mine' : 'other';
            console.log("[ë””ë²„ê·¸] list", list);
            console.log("[ë””ë²„ê·¸] message", message);
            console.log("[ë””ë²„ê·¸] tabId", tabId);

            // isMineì´ falseì¼ ë•Œë§Œ (ì¦‰, STOMP êµ¬ë…ìœ¼ë¡œ ë‹¤ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œë§Œ)
            // ì‹¤ì œë¡œ ë©”ì‹œì§€ ë°œì‹ ìê°€ ë‚˜ ìì‹ ì¸ì§€ í™•ì¸í•˜ì—¬ 'mine'ìœ¼ë¡œ ì¬ì„¤ì •í•©ë‹ˆë‹¤.
            if (!isMine) {
                // myProfileì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ë°©ì–´ ì½”ë“œ ì¬ì‚¬ìš©
                const myEmail = (myProfile && myProfile.email) || '';

                // ë°œì‹ ì ì´ë©”ì¼ê³¼ í˜„ì¬ ì‚¬ìš©ì ì´ë©”ì¼ì´ ì¼ì¹˜í•˜ë©´ 'mine'ìœ¼ë¡œ ì„¤ì •
                if (message.sender === myEmail && myEmail !== '') {
                    type = 'mine';
                }
            }

            console.log(`[Chat Debug] Final Type: ${type}, isMine Param: ${isMine}, My Email: ${(myProfile && myProfile.email) || 'N/A'}, Sender: ${message.sender}`);

            const senderName = message.senderName || message.sender;
            const senderInitial = getKoreanInitials(senderName);
            const messageType = message.messageType || message.type;

            const newMessage = {
                type: type,
                text: message.message,
                time: new Date(message.createdAt).toLocaleTimeString('ko-KR', { hour: 'numeric', minute: '2-digit', hour12: true }),
                senderInitial: senderInitial,
                createdAt: message.createdAt,
                senderName: senderName,
                messageType: messageType,
                fileUrl: message.fileUrl,
                metadata: message.metadata
            };

            if (!chatHistories[tabId]) chatHistories[tabId] = [];
            chatHistories[tabId].push(newMessage);

            if (list) {
                // [1] ë©”ì‹œì§€ ì¶”ê°€ ì „, ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ ë°”ë‹¥ê¶Œ(ì—¬ìœ ê°’ 200px)ì— ìˆëŠ”ì§€ ì²´í¬
                // ìŠ¤í¬ë¡¤ì´ ë§¨ ì•„ë˜ì— ë¶™ì–´ìˆë‹¤ë©´ nearBottomì€ trueê°€ ë©ë‹ˆë‹¤.
                const nearBottom = (list.scrollHeight - list.scrollTop - list.clientHeight) <= 200;

                // [2] ë©”ì‹œì§€ HTMLì„ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                list.insertAdjacentHTML('beforeend', createChatMessageHTML(newMessage));

                // [3] ìŠ¤í¬ë¡¤ ì²˜ë¦¬ ë¡œì§
                // ì¡°ê±´: (ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€) ë˜ëŠ” (ì‚¬ìš©ìê°€ ì´ë¯¸ ë°”ë‹¥ì„ ë³´ê³  ìˆì—ˆì„ ë•Œ)
                if (type === 'mine' || nearBottom) {

                    // 3-1. ì¦‰ì‹œ ìŠ¤í¬ë¡¤ (í…ìŠ¤íŠ¸ ë©”ì‹œì§€ìš©)
                    scrollToBottom(tabId);

                    // 3-2. ì´ë¯¸ì§€ë‚˜ íŒŒì¼ì´ í¬í•¨ëœ ê²½ìš° ë¡œë”© ì§€ì—° ëŒ€ì‘
                    // ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ë©´ì„œ ë†’ì´ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë¡œë“œ ì™„ë£Œ í›„ í•œ ë²ˆ ë” ìŠ¤í¬ë¡¤
                    const lastMessageElement = list.lastElementChild;
                    if (lastMessageElement) {
                        const img = lastMessageElement.querySelector('img.image-preview');
                        if (img) {
                            img.onload = () => scrollToBottom(tabId);
                        }
                    }

                    // í˜¹ì‹œ ëª¨ë¥¼ ë Œë”ë§ ë”œë ˆì´ë¥¼ ìœ„í•´ ì§§ì€ ì‹œê°„ ë’¤ ë°©ì–´ì  ìŠ¤í¬ë¡¤
                    setTimeout(() => scrollToBottom(tabId), 50);
                }

                // GLightbox ì¬ì‹¤í–‰ (ì´ë¯¸ì§€ ë·°ì–´ ë°”ì¸ë”©)
                initializeChatLightbox();
            }

            // [4] ì•Œë¦¼ ë° ì½ìŒ ì²˜ë¦¬ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
            if (tabId !== activeTabId && !isMine) {
                // ë‹¤ë¥¸ ë°©ì—ì„œ ì˜¨ ë©”ì‹œì§€ë¼ë©´ ì•Œë¦¼ í‘œì‹œ
                 if (window.loadAndRenderRooms) window.loadAndRenderRooms();
                 showNotification(senderName, newMessage.text, tabId);
            } else if (tabId === activeTabId) {
                // í˜„ì¬ ë³´ê³  ìˆëŠ” ë°©ì´ë¼ë©´ lastReadTime ê°±ì‹ 
                if (openTabs[tabId].roomId) {
                     updateLastReadTime(openTabs[tabId].roomId);
                }
            }
        } // End displayReceivedMessage

        function showNotification(senderName, messageText, tabId) {
            const area = document.getElementById(NOTIFICATION_AREA_ID);
            if (!area) {
                console.warn('ì•Œë¦¼ ì˜ì—­ (ID: notification-area)ì´ HTMLì— ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const tabInfo = openTabs[tabId];
            const displayRoomName = tabInfo?.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ë°©';

            // ì•Œë¦¼ ìš”ì†Œ ìƒì„±
            const notification = document.createElement('div');
            notification.className = 'chat-notification-popup';
            notification.innerHTML = `
                <strong>[${displayRoomName}] ${senderName}</strong>
                <p>${messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText}</p>
            `;
            notification.dataset.tabId = tabId;

            // í´ë¦­ ì‹œ í•´ë‹¹ ë°©ìœ¼ë¡œ ì´ë™ (openTab í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •)
            notification.onclick = () => {
                activateTab(tabId);
                notification.remove();
            };

            area.appendChild(notification);

            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                notification.classList.add('fading-out');
                setTimeout(() => notification.remove(), 500); // CSS transition ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì œê±°
            }, 5000);
        }

        // getCurrentActiveRoomIdëŠ” activeTabIdì™€ currentRoomIdë¡œ ëŒ€ì²´ ê°€ëŠ¥

        function openInviteMemberModal() {
            if (!inviteFriendList || !friendList || !memberList || !currentRoomId) {
                alert('ì±„íŒ…ë°©ì„ ì„ íƒí•´ì•¼ ë©¤ë²„ë¥¼ ì´ˆëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            const friendItems = Array.from(friendList.querySelectorAll('.friend-item'));
            const memberItems = Array.from(memberList.querySelectorAll('.friend-item'));

            const memberIds = new Set(
                memberItems
                    .map(m => m.dataset.id)
                    .filter(Boolean)
            );

            inviteFriendList.innerHTML = '';

            const availableFriends = friendItems.filter(f => !memberIds.has(f.dataset.id));

            if (availableFriends.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'ì´ˆëŒ€ ê°€ëŠ¥í•œ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
                li.className = 'invite-empty';
                inviteFriendList.appendChild(li);
            } else {
                availableFriends.forEach(f => {
                    const li = document.createElement('li');
                    li.className = 'invite-item';
                    li.dataset.id = f.dataset.id;
                    li.dataset.name = f.dataset.name;
                    li.textContent = `${f.dataset.name} (${f.dataset.status || ''})`.trim();

                    li.addEventListener('click', () => {
                        addMemberFromFriend(li.dataset.id, li.dataset.name);
                        inviteMemberModal.classList.remove('open');
                    });

                    inviteFriendList.appendChild(li);
                });
            }

            inviteMemberModal.classList.add('open');
        }
        // --- C. ì¹œêµ¬ ìš”ì²­ ë° ìˆ˜ë½ ë¡œì§ ---
        function sendFriendRequest(receiverEmail, buttonElement) {
            buttonElement.disabled = true;
            buttonElement.textContent = 'ì „ì†¡ ì¤‘...';

            fetch('/api/friends/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ receiverEmail: receiverEmail })
            })
            .then(response => {
                if (response.ok) {
                    buttonElement.textContent = 'ìš”ì²­ ì™„ë£Œ';
                    buttonElement.classList.add('sent');
                    // ë²„íŠ¼ì€ ìš”ì²­ ì™„ë£Œ ìƒíƒœë¡œ ìœ ì§€
                    return;
                }
                // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í…ìŠ¤íŠ¸ë¡œ ì½ì–´ì„œ Errorì— í¬í•¨
                return response.text().then(text => { throw new Error(text || 'ìš”ì²­ ì‹¤íŒ¨'); });
            })
            .catch(error => {
                console.error('ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨:', error);
                // alert('ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨: ' + (error.message || 'ì„œë²„ ì˜¤ë¥˜')); // alert ëŒ€ì‹  console ì‚¬ìš©
                buttonElement.textContent = 'ìš”ì²­';
                buttonElement.disabled = false;
            });
        }

        window.WindowLoadReceivedRequests = function loadReceivedRequests() {
            const container = document.getElementById('received-requests-list');
            if (!container) return;

            container.innerHTML = '<div class="loading-message">ë¡œë”© ì¤‘...</div>';

            fetch('/api/friends/requests/received')
                .then(res => res.json())
                .then(requests => {
                    if (requests.length === 0) {
                        container.innerHTML = '<div class="empty-list">ë°›ì€ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    container.innerHTML = requests.map(user => {
                        const initial = user.userName ? user.userName[0] : '?';
                        return `
                            <div class="request-item" id="req-${user.email}">
                                <div class="avatar">${initial}</div>
                                <div class="name">${user.userName}</div>
                                <button class="btn-accept" onclick="handleAcceptRequest('${user.email}')">í™•ì¸</button>
                            </div>
                        `;
                    }).join('');
                });
        }

        window.handleAcceptRequest = function(senderEmail) {
            fetch(`/api/friends/request/accept?senderEmail=${encodeURIComponent(senderEmail)}`, {
                method: 'POST'
            })
            .then(res => {
                if (res.ok) {
                    // UI ì—…ë°ì´íŠ¸: ìš”ì²­ ëª©ë¡ì—ì„œ ì œê±°
                    const item = document.getElementById(`req-${senderEmail}`);
                    if (item) item.remove();

                    // ì¹œêµ¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    window.WindowLoadFriendList();
                    alert("ì¹œêµ¬ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else {
                    alert("ìš”ì²­ ìˆ˜ë½ ì‹¤íŒ¨");
                }
            });
        };
        function acceptFriendRequest(senderEmail, buttonElement) {
            buttonElement.disabled = true;
            buttonElement.textContent = 'ìˆ˜ë½ ì¤‘...';

            fetch(`/api/friends/accept/${senderEmail}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    console.log('ì¹œêµ¬ ìˆ˜ë½ ì„±ê³µ!');
                    // ëª©ë¡ ê°±ì‹  (ì¹œêµ¬ê°€ ë˜ì—ˆìœ¼ë¯€ë¡œ ì¹œêµ¬ ëª©ë¡ ê°±ì‹  + ìš”ì²­ ëª©ë¡ì—ì„œ ì œê±°)
                    window.WindowLoadFriendList();
                    window.WindowLoadReceivedRequests();
                    return;
                }
                return response.text().then(text => { throw new Error(text || 'ìˆ˜ë½ ì‹¤íŒ¨'); });
            })
            .catch(error => {
                console.error('ì¹œêµ¬ ìˆ˜ë½ ì‹¤íŒ¨:', error);
                // alert('ìˆ˜ë½ ì‹¤íŒ¨: ' + (error.message || 'ì„œë²„ ì˜¤ë¥˜')); // alert ëŒ€ì‹  console ì‚¬ìš©
                buttonElement.textContent = 'ìˆ˜ë½';
                buttonElement.disabled = false;
            });
        }

        //í—¬í¼ì¶”ê°€
        async function fetchCurrentMembersEmails(roomId) {
            try {
                const response = await fetch(`/api/chat/room/${roomId}/members/emails`);
                if (!response.ok) throw new Error('ì±„íŒ…ë°© ë©¤ë²„ ì´ë©”ì¼ ë¡œë“œ ì‹¤íŒ¨');
                return await response.json(); // List<String> of emails
            } catch (error) {
                console.error("í˜„ì¬ ì±„íŒ…ë°© ë©¤ë²„ ë¡œë“œ ì˜¤ë¥˜:", error);
                return [];
            }
        }

        function addMemberFromFriend(friendId, friendName) {
            if (!memberList || !activeTabId || !currentRoomId) return;

            const exists = memberList.querySelector(`.friend-item[data-id="${friendId}"]`);
            if (exists) return;

            // ì‹¤ì œë¡œëŠ” ì„œë²„ì— ë©¤ë²„ ì¶”ê°€ ìš”ì²­ í•„ìš”
            console.log(`[SERVER REQUEST] Added Member: Room=${currentRoomId}, Friend=${friendName}`);

            const firstChar = (friendName && friendName[0]) || '?';

            const item = document.createElement('div');
            item.className = 'friend-item';
            item.dataset.id = friendId;
            item.dataset.name = friendName;

            item.innerHTML = `
                <div class="avatar">${firstChar}</div>
                <div class="member-text">
                    <div class="member-name">${friendName}</div>
                    <div class="member-role">ì´ˆëŒ€ëœ ë©¤ë²„</div>
                </div>
            `;
            memberList.appendChild(item);

            // ë¡œì»¬ ì°¸ì—¬ì ëª©ë¡ì—ë„ ì¶”ê°€
            if (chatParticipants[activeTabId]) {
                chatParticipants[activeTabId].push({ email: friendId, nickName: friendName, userId: 'user_' + friendId });
            }

            // ìš°ì¸¡ ì¹œêµ¬ íŒ¨ë„ ìˆ˜ì •: ì¹œêµ¬ ëª©ë¡/ìš”ì²­ ë¡œë“œ ì¶”ê°€
            openFriendPanelBtn.addEventListener('click', () => {
                console.log("ì˜¤í”ˆì¹œêµ¬íŒ¨ë„ë²„íŠ¼");
                friendPanel.classList.toggle('open');
                if (friendPanel.classList.contains('open')) {
                    window.WindowLoadFriendList();
                    window.WindowLoadReceivedRequests();
                }
            });
            // ë©¤ë²„ì¶”ê°€
            addFriendBtn.addEventListener('click', () => {
                // 1. í˜„ì¬ í™œì„±í™”ëœ íƒ­ ID í™•ì¸
                if (!activeTabId) {
                     alert('ë¨¼ì € ê·¸ë£¹ ì±„íŒ…ë°©ì„ ì—´ì–´ì£¼ì„¸ìš”.');
                     return;
                }

                const tabInfo = openTabs[activeTabId];

                // 2. ê·¸ë£¹ ì±„íŒ…ë°©ì¸ì§€ í™•ì¸
                if (tabInfo.type !== 'group') {
                     alert('ê·¸ë£¹ ì±„íŒ…ë°©ì—ì„œë§Œ ë©¤ë²„ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                     return;
                }

                // 3. íŒì—… ì—´ê¸° í•¨ìˆ˜ í˜¸ì¶œ (ì•„ë˜ ì„¹ì…˜ì— ìƒˆë¡œ ì •ì˜í•´ì•¼ í•¨)
                showAddMemberModal(activeTabId);

            });
        }
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
        });
        document.addEventListener('click', function(e) {
            // í´ë¦­ëœ ìš”ì†Œê°€ .remove-file-btnì´ê±°ë‚˜ ê·¸ ë‚´ë¶€ ìš”ì†Œì¸ì§€ í™•ì¸
            const removeBtn = e.target.closest('.remove-file-btn');
            if (removeBtn) {
                // 1. data- ì†ì„±ì—ì„œ ì •ë³´ ì¶”ì¶œ
                const tabId = removeBtn.dataset.tabId;
                const fileName = removeBtn.dataset.fileName;

                // 2. íŒŒì¼ ê´€ë¦¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ì•ˆì „í•˜ê²Œ í™•ì¸ (window.fileListManagers ì‚¬ìš©)
                const manager = window.fileListManagers[tabId];

                if (manager) {
                    // 3. FileAreaManager ì¸ìŠ¤í„´ìŠ¤ì˜ removeFile í˜¸ì¶œ (ë‚´ë¶€ì ìœ¼ë¡œ updateUIë„ í˜¸ì¶œë¨)
                    manager.removeFile(fileName);
                } else {
                    console.warn('WARN: ë‹«íŒ íƒ­ì˜ ì”ì—¬ íŒŒì¼ ë²„íŠ¼ í´ë¦­ë¨. DOMì—ì„œ ì œê±°.');
                    // ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ëŠ” ê²½ìš°, ì‹œê°ì ìœ¼ë¡œë§Œ ì œê±°
                    removeBtn.closest('.file-summary-item')?.remove();
                }
            }
        });


        // ê°•í‡´ ë²„íŠ¼ í´ë¦­
        kickBtn.addEventListener('click', async () => {
            if (!targetMemberId || !targetRoomId) return;

            if (confirm(`${targetMemberName}ë‹˜ì„ í˜„ì¬ ì±„íŒ…ë°©ì—ì„œ íƒˆí‡´ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                    // DELETE API í˜¸ì¶œ (ê²½ë¡œëŠ” /api/chat/rooms/...ë¡œ ê°€ì •)
                    const res = await fetch(`/api/chat/rooms/${targetRoomId}/members/${targetMemberId}`, {
                        method: 'DELETE'
                    });

                    if (res.ok) {
                        const itemToRemove = memberList.querySelector(`.friend-item[data-id="${targetMemberId}"]`);
                        // UI ê°±ì‹  (ê°•í‡´ëœ ë©¤ë²„ ëª©ë¡ì—ì„œ ì œê±°)
                        if(itemToRemove) itemToRemove.remove();

                        // ê°•í‡´í•œ ë°©ì¥ì—ê²Œë§Œ ì•ŒëŒì°½ìœ¼ë¡œ ì„±ê³µ ë©”ì‹œì§€ ë„ìš°ê¸°
                        alert(`${targetMemberName}ë‹˜ì´ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.`);
                    } else {
                        // ì„œë²„ì—ì„œ ë°˜í™˜ëœ ì‘ë‹µ ë³¸ë¬¸ì„ ì½ì–´ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì•Œë¦¼ì°½ì— í‘œì‹œ
                        const errorMessage = await res.text();
                        // ì„œë²„ì—ì„œ "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."ë‚˜ "ë°©ì¥ì€ ë³¸ì¸ì„ ê°•í‡´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." ë“±ì˜ ë©”ì‹œì§€ë¥¼ ë°›ì•„ì„œ ë„ì›€
                        alert(`ê°•í‡´ ì‹¤íŒ¨: ${errorMessage || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ"}`);
                    }
                } catch (e) {
                    console.error(e);
                    alert("ê°•í‡´ ì‹¤íŒ¨: í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
                }
            }
            contextMenu.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            contextMenu.style.display = 'none';
        });

    setTimeout(initializeChatLightbox, 200);
    });



    //ì¹œêµ¬ëª©ë¡ ìŠ¤í¬ë¦½íŠ¸
    //ì „ì²´íŒ¨ë„(í¬ê¸°ì¡°ì •)
    const open_list_wrap = document.getElementById('friend-panel-right');
    //ê³ ì • ëª©ë¡(í¬ê¸°ì¡°ì •)
    const fixed_list = document.getElementById('fixed_column');
    //ì›€ì§ì¼ ëª©ë¡
    const open_column = document.getElementById('frd_column');
    //ë²„íŠ¼
    const openFriendPanelBtn = document.getElementById('open-friend-panel-btn');
    if (openFriendPanelBtn) {
        openFriendPanelBtn.addEventListener('click',()=>{
            fixed_list.style.width= "260px";
            const isMove = open_column.classList.toggle('addmove');
            if(isMove){
                open_column.style.transition = "0.3s ease";
                open_column.style.right = "260px";

                if (window.WindowLoadFriendList) window.WindowLoadFriendList();
                if (window.WindowLoadReceivedRequests) window.WindowLoadReceivedRequests();

            } else{
                open_column.style.transition = "0.3s ease";
                open_column.style.right = "0px";
            }
        });
    }


</script>

</body>

</html>